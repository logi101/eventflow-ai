---
phase: 01-scheduler-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - eventflow-app/supabase/migrations/20260128000001_enable_cron_extensions.sql
autonomous: false

user_setup:
  - service: supabase
    why: "Enable pg_cron extension (Dashboard-only operation)"
    dashboard_config:
      - task: "Enable pg_cron extension"
        location: "Supabase Dashboard -> Database -> Extensions -> Search 'pg_cron' -> Enable"
      - task: "Enable pg_net extension"
        location: "Supabase Dashboard -> Database -> Extensions -> Search 'pg_net' -> Enable"
      - task: "Enable vault extension"
        location: "Supabase Dashboard -> Database -> Extensions -> Search 'vault' -> Enable"

must_haves:
  truths:
    - "pg_cron extension is enabled and accessible"
    - "pg_net extension is enabled for HTTP requests"
    - "vault extension is enabled for secure secret storage"
    - "postgres user has cron schema permissions"
  artifacts:
    - path: "eventflow-app/supabase/migrations/20260128000001_enable_cron_extensions.sql"
      provides: "Migration file documenting extension enablement and grants"
      contains: "GRANT USAGE ON SCHEMA cron"
  key_links:
    - from: "cron schema"
      to: "postgres user"
      via: "GRANT statements"
      pattern: "GRANT.*cron.*postgres"
---

<objective>
Enable PostgreSQL scheduling extensions (pg_cron, pg_net, vault) required for automated reminder triggers.

Purpose: Foundation for all scheduled jobs - without these extensions, no database-level scheduling is possible.
Output: Migration file documenting grants + verified extensions enabled in Supabase.
</objective>

<execution_context>
@/Users/eliyawolfman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eliyawolfman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-scheduler-infrastructure/01-RESEARCH.md

# Existing migrations directory
@eventflow-app/supabase/migrations/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration for extension grants</name>
  <files>eventflow-app/supabase/migrations/20260128000001_enable_cron_extensions.sql</files>
  <action>
Create a SQL migration file that:

1. Documents the manual extension enablement requirement in comments
2. Grants necessary permissions to postgres user for cron schema
3. Verifies extensions are accessible with DO block checks

Contents should include:
```sql
-- Extensions pg_cron, pg_net, vault must be enabled via Supabase Dashboard first
-- Dashboard -> Database -> Extensions -> Enable each

-- Grant cron schema permissions to postgres
GRANT USAGE ON SCHEMA cron TO postgres;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA cron TO postgres;

-- Grant net schema permissions
GRANT USAGE ON SCHEMA net TO postgres;

-- Verify extensions (will error if not enabled)
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_cron') THEN
    RAISE EXCEPTION 'pg_cron extension not enabled. Enable via Dashboard first.';
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'pg_net') THEN
    RAISE EXCEPTION 'pg_net extension not enabled. Enable via Dashboard first.';
  END IF;
END $$;
```

Do NOT attempt CREATE EXTENSION statements - these fail on Supabase hosted projects where extensions must be enabled via Dashboard.
  </action>
  <verify>File exists at eventflow-app/supabase/migrations/20260128000001_enable_cron_extensions.sql with proper SQL content</verify>
  <done>Migration file created with grant statements and verification checks</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Enable PostgreSQL extensions via Supabase Dashboard</action>
  <instructions>
These extensions CANNOT be enabled via SQL on Supabase hosted projects. Manual dashboard steps required:

1. Open Supabase Dashboard for your project
2. Navigate to: Database -> Extensions
3. Search and enable each extension:
   - **pg_cron** - Job scheduling (search "pg_cron", click Enable)
   - **pg_net** - Async HTTP requests (search "pg_net", click Enable)
   - **vault** - Encrypted secret storage (search "vault", click Enable)

After enabling all three, run this verification query in SQL Editor:
```sql
SELECT extname, extversion FROM pg_extension
WHERE extname IN ('pg_cron', 'pg_net', 'vault');
```

Expected result: 3 rows showing all extensions enabled.
  </instructions>
  <resume-signal>Type "extensions enabled" after confirming all 3 extensions show in query results</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Run migration to apply grants</name>
  <files>eventflow-app/supabase/migrations/20260128000001_enable_cron_extensions.sql</files>
  <action>
Run the migration against the Supabase database using one of:

Option A (Supabase CLI if configured):
```bash
cd eventflow-app && npx supabase db push
```

Option B (Direct SQL execution):
Copy the migration SQL and execute in Supabase SQL Editor.

The migration should complete without errors if extensions were properly enabled in the previous checkpoint.
  </action>
  <verify>
Run verification query:
```sql
-- Check extensions
SELECT extname, extversion FROM pg_extension WHERE extname IN ('pg_cron', 'pg_net', 'vault');

-- Check cron schema access
SELECT has_schema_privilege('postgres', 'cron', 'USAGE');
```
Both queries should return successful results.
  </verify>
  <done>All 3 extensions enabled, postgres user has cron schema privileges</done>
</task>

</tasks>

<verification>
Run in Supabase SQL Editor:
```sql
-- Verify all extensions
SELECT extname, extversion
FROM pg_extension
WHERE extname IN ('pg_cron', 'pg_net', 'vault');

-- Verify cron access
SELECT current_user, has_schema_privilege(current_user, 'cron', 'USAGE') as can_use_cron;

-- Verify pg_cron worker is running
SELECT pid, usename, application_name, state
FROM pg_stat_activity
WHERE application_name ILIKE 'pg_cron%';
```
Expected: 3 extensions listed, cron access = true, pg_cron process visible.
</verification>

<success_criteria>
1. pg_cron extension enabled (shows in pg_extension)
2. pg_net extension enabled (shows in pg_extension)
3. vault extension enabled (shows in pg_extension)
4. postgres user can access cron schema
5. Migration file committed to repository
</success_criteria>

<output>
After completion, create `.planning/phases/01-scheduler-infrastructure/01-01-SUMMARY.md`
</output>
