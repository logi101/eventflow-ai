---
phase: 01-scheduler-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - eventflow-app/supabase/migrations/20260128000002_setup_vault_secrets.sql
autonomous: false

user_setup:
  - service: supabase
    why: "Store actual secret values in Vault"
    env_vars:
      - name: SUPABASE_URL
        source: "Supabase Dashboard -> Settings -> API -> Project URL"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Settings -> API -> service_role (reveal)"
    dashboard_config:
      - task: "Store secrets in Vault via SQL Editor"
        location: "Supabase Dashboard -> SQL Editor"

must_haves:
  truths:
    - "supabase_url secret stored in Vault"
    - "service_role_key secret stored in Vault"
    - "Secrets are retrievable via vault.decrypted_secrets view"
  artifacts:
    - path: "eventflow-app/supabase/migrations/20260128000002_setup_vault_secrets.sql"
      provides: "Migration template for Vault secrets (with placeholder values)"
      contains: "vault.create_secret"
  key_links:
    - from: "vault.decrypted_secrets"
      to: "trigger_reminder_job function (Plan 03)"
      via: "SELECT decrypted_secret"
      pattern: "vault\\.decrypted_secrets.*supabase_url"
---

<objective>
Configure Vault secrets for secure storage of Supabase URL and service_role_key.

Purpose: Credentials needed by trigger_reminder_job function must be stored securely (not hardcoded). Vault provides encrypted storage with authenticated decryption.
Output: Vault secrets populated and verifiable, migration template for documentation.
</objective>

<execution_context>
@/Users/eliyawolfman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eliyawolfman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-scheduler-infrastructure/01-RESEARCH.md
@.planning/phases/01-scheduler-infrastructure/01-01-SUMMARY.md

# Extension enablement must be complete before this plan
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Vault secrets migration template</name>
  <files>eventflow-app/supabase/migrations/20260128000002_setup_vault_secrets.sql</files>
  <action>
Create a SQL migration file with Vault secret creation statements. Use placeholder values that will be replaced manually.

Contents:
```sql
-- ============================================================================
-- Vault Secrets for pg_cron Edge Function Invocation
-- ============================================================================
-- IMPORTANT: This migration contains PLACEHOLDER values.
-- Replace with actual values before running, OR run the statements manually
-- in SQL Editor with real values.
--
-- DO NOT commit real secrets to version control!
-- ============================================================================

-- Store Supabase project URL
SELECT vault.create_secret(
  'https://YOUR_PROJECT_REF.supabase.co',  -- Replace with actual project URL
  'supabase_url',
  'Supabase project URL for Edge Function calls'
);

-- Store service_role_key (bypasses RLS for cron jobs)
SELECT vault.create_secret(
  'YOUR_SERVICE_ROLE_KEY_HERE',  -- Replace with actual service_role key
  'service_role_key',
  'Service role key for authenticated cron job requests'
);

-- Verification query (run after inserting real values)
-- SELECT name, description FROM vault.decrypted_secrets WHERE name IN ('supabase_url', 'service_role_key');
```

The migration file serves as documentation. Actual secrets will be inserted via SQL Editor in the checkpoint.
  </action>
  <verify>File exists at eventflow-app/supabase/migrations/20260128000002_setup_vault_secrets.sql</verify>
  <done>Migration template created with placeholder values and instructions</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Insert Vault secrets with actual values via SQL Editor</action>
  <instructions>
Secrets must be inserted manually with real values (not committed to git).

1. Get your Supabase credentials:
   - Dashboard -> Settings -> API
   - Copy "Project URL" (e.g., https://abcdefgh.supabase.co)
   - Click "Reveal" on service_role key, copy the full key

2. Open Supabase SQL Editor and run (with YOUR values):
```sql
-- Insert supabase_url
SELECT vault.create_secret(
  'https://YOUR_ACTUAL_PROJECT.supabase.co',
  'supabase_url',
  'Supabase project URL for Edge Function calls'
);

-- Insert service_role_key
SELECT vault.create_secret(
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...YOUR_ACTUAL_KEY',
  'service_role_key',
  'Service role key for authenticated cron job requests'
);
```

3. Verify secrets were stored:
```sql
SELECT name, description, created_at
FROM vault.decrypted_secrets
WHERE name IN ('supabase_url', 'service_role_key');
```

Expected result: 2 rows showing both secrets with timestamps.

SECURITY NOTES:
- service_role_key bypasses RLS - handle with care
- Never commit real keys to git
- Keys can be rotated later using vault.update_secret()
  </instructions>
  <resume-signal>Type "secrets stored" after verification query shows both secrets</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Verify Vault retrieval works correctly</name>
  <files>None (verification only)</files>
  <action>
Run a verification query to confirm secrets can be retrieved by the postgres user (which will execute cron jobs).

Execute in SQL Editor:
```sql
-- Test secret retrieval as postgres user would
SELECT
  (SELECT decrypted_secret FROM vault.decrypted_secrets WHERE name = 'supabase_url') AS url_retrieved,
  (SELECT LEFT(decrypted_secret, 20) || '...' FROM vault.decrypted_secrets WHERE name = 'service_role_key') AS key_prefix;
```

This confirms:
1. Secrets exist in Vault
2. Decryption works
3. The pattern used in trigger_reminder_job will function correctly

If this fails, the secret names may be wrong or vault extension not properly configured.
  </action>
  <verify>Query returns non-null values for both url_retrieved and key_prefix</verify>
  <done>Vault secrets stored and retrievable, ready for use by trigger_reminder_job function</done>
</task>

</tasks>

<verification>
Run in Supabase SQL Editor:
```sql
-- Full verification
SELECT
  name,
  description,
  created_at,
  CASE
    WHEN name = 'supabase_url' THEN decrypted_secret
    WHEN name = 'service_role_key' THEN LEFT(decrypted_secret, 30) || '...[truncated]'
  END AS value_preview
FROM vault.decrypted_secrets
WHERE name IN ('supabase_url', 'service_role_key');
```
Expected: 2 rows, URL fully visible, key truncated for security.
</verification>

<success_criteria>
1. supabase_url secret exists in Vault
2. service_role_key secret exists in Vault
3. Both secrets retrievable via vault.decrypted_secrets
4. Migration template file committed (with placeholders, not real values)
</success_criteria>

<output>
After completion, create `.planning/phases/01-scheduler-infrastructure/01-02-SUMMARY.md`
</output>
