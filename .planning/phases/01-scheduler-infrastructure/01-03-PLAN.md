---
phase: 01-scheduler-infrastructure
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - eventflow-app/supabase/migrations/20260128000003_create_trigger_reminder_function.sql
autonomous: true

must_haves:
  truths:
    - "trigger_reminder_job(reminder_type) function exists"
    - "Function returns request_id (BIGINT) from pg_net"
    - "Function retrieves credentials from Vault (not hardcoded)"
    - "Function calls /functions/v1/send-reminder Edge Function"
  artifacts:
    - path: "eventflow-app/supabase/migrations/20260128000003_create_trigger_reminder_function.sql"
      provides: "Database function for Edge Function invocation"
      contains: "CREATE OR REPLACE FUNCTION trigger_reminder_job"
      min_lines: 30
  key_links:
    - from: "trigger_reminder_job"
      to: "vault.decrypted_secrets"
      via: "SELECT decrypted_secret"
      pattern: "vault\\.decrypted_secrets.*supabase_url"
    - from: "trigger_reminder_job"
      to: "net.http_post"
      via: "pg_net HTTP call"
      pattern: "net\\.http_post"
    - from: "trigger_reminder_job"
      to: "/functions/v1/send-reminder"
      via: "URL concatenation"
      pattern: "/functions/v1/send-reminder"
---

<objective>
Create the trigger_reminder_job database function that invokes the send-reminder Edge Function.

Purpose: This reusable function wraps pg_net HTTP calls with proper authentication. Cron jobs call this function with different reminder types, avoiding duplicate code in each scheduled job.
Output: Database function ready to be called by cron schedules.
</objective>

<execution_context>
@/Users/eliyawolfman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eliyawolfman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-scheduler-infrastructure/01-RESEARCH.md
@.planning/phases/01-scheduler-infrastructure/01-02-SUMMARY.md

# Reference existing Edge Function for expected payload
@eventflow-scaffold/functions/send-reminder.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trigger_reminder_job function migration</name>
  <files>eventflow-app/supabase/migrations/20260128000003_create_trigger_reminder_function.sql</files>
  <action>
Create a SQL migration file with the trigger_reminder_job function.

The function must:
1. Accept reminder_type parameter (TEXT)
2. Retrieve supabase_url from Vault
3. Retrieve service_role_key from Vault
4. Call send-reminder Edge Function via net.http_post
5. Return the request_id for tracking
6. Use SECURITY DEFINER for elevated permissions

Contents:
```sql
-- ============================================================================
-- Trigger Reminder Job Function
-- ============================================================================
-- Reusable function for pg_cron to invoke send-reminder Edge Function
-- Uses pg_net for async HTTP and Vault for secure credentials
-- ============================================================================

CREATE OR REPLACE FUNCTION trigger_reminder_job(reminder_type TEXT)
RETURNS BIGINT
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, net, vault
AS $$
DECLARE
  request_id BIGINT;
  project_url TEXT;
  auth_key TEXT;
BEGIN
  -- Retrieve credentials from Vault
  SELECT decrypted_secret INTO project_url
  FROM vault.decrypted_secrets
  WHERE name = 'supabase_url';

  SELECT decrypted_secret INTO auth_key
  FROM vault.decrypted_secrets
  WHERE name = 'service_role_key';

  -- Validate credentials exist
  IF project_url IS NULL THEN
    RAISE EXCEPTION 'Vault secret "supabase_url" not found. Run Vault setup first.';
  END IF;

  IF auth_key IS NULL THEN
    RAISE EXCEPTION 'Vault secret "service_role_key" not found. Run Vault setup first.';
  END IF;

  -- Call Edge Function via pg_net
  SELECT net.http_post(
    url := project_url || '/functions/v1/send-reminder',
    headers := jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer ' || auth_key
    ),
    body := jsonb_build_object('type', reminder_type)
  ) INTO request_id;

  -- Log the request (optional, can query net._http_response for results)
  RAISE NOTICE 'Triggered reminder job: type=%, request_id=%', reminder_type, request_id;

  RETURN request_id;
END;
$$;

-- Grant execute permission to postgres (cron jobs run as postgres)
GRANT EXECUTE ON FUNCTION trigger_reminder_job(TEXT) TO postgres;

-- Add comment for documentation
COMMENT ON FUNCTION trigger_reminder_job(TEXT) IS
  'Triggers send-reminder Edge Function for specified reminder type. '
  'Called by pg_cron jobs. Returns pg_net request_id for tracking.';
```

Key design decisions:
- SECURITY DEFINER: Required to access Vault secrets
- SET search_path: Prevents search_path injection attacks
- Error handling: Fails fast if Vault secrets missing
- RAISE NOTICE: Provides logging for debugging
  </action>
  <verify>
File exists and contains:
- CREATE OR REPLACE FUNCTION trigger_reminder_job
- vault.decrypted_secrets queries
- net.http_post call
- SECURITY DEFINER
  </verify>
  <done>Migration file created with complete trigger_reminder_job function</done>
</task>

<task type="auto">
  <name>Task 2: Apply migration and verify function</name>
  <files>eventflow-app/supabase/migrations/20260128000003_create_trigger_reminder_function.sql</files>
  <action>
Apply the migration to create the function.

Option A (Supabase CLI):
```bash
cd eventflow-app && npx supabase db push
```

Option B (SQL Editor):
Copy migration SQL and execute in Supabase Dashboard SQL Editor.

After applying, verify the function exists and can be called:
```sql
-- Check function exists
SELECT proname, prosrc
FROM pg_proc
WHERE proname = 'trigger_reminder_job';

-- Test function (will make actual HTTP request!)
-- Use with caution - this sends real reminders if events exist
SELECT trigger_reminder_job('day_before');
```
  </action>
  <verify>
Run verification:
```sql
-- Function exists
SELECT routine_name, routine_type
FROM information_schema.routines
WHERE routine_name = 'trigger_reminder_job';

-- Function signature correct
SELECT pg_get_functiondef(oid)
FROM pg_proc
WHERE proname = 'trigger_reminder_job';
```
Should show function with TEXT parameter returning BIGINT.
  </verify>
  <done>Function created and verified callable</done>
</task>

<task type="auto">
  <name>Task 3: Test function with manual invocation</name>
  <files>None (testing only)</files>
  <action>
Test the function makes successful HTTP request to Edge Function.

Execute in SQL Editor:
```sql
-- Trigger a test request
SELECT trigger_reminder_job('day_before') AS request_id;
```

Then check the response:
```sql
-- Wait a few seconds for async response, then check
SELECT
  id,
  status_code,
  LEFT(content::text, 200) AS response_preview,
  created
FROM net._http_response
WHERE id = (SELECT trigger_reminder_job('day_before'))
ORDER BY created DESC
LIMIT 1;
```

Expected outcomes:
- status_code = 200 (Edge Function executed)
- Response contains {"success": true, "results": {...}}
- If 401: Vault secrets incorrect
- If 500: Edge Function error (check function logs)
  </action>
  <verify>
HTTP response shows status_code 200 and success response from Edge Function.
Check Supabase Dashboard -> Functions -> send-reminder -> Logs for execution details.
  </verify>
  <done>trigger_reminder_job successfully invokes send-reminder Edge Function</done>
</task>

</tasks>

<verification>
Complete verification suite:
```sql
-- 1. Function exists with correct signature
SELECT routine_name, data_type, type_udt_name
FROM information_schema.routines
WHERE routine_name = 'trigger_reminder_job';
-- Expected: trigger_reminder_job, bigint, int8

-- 2. Function can retrieve Vault secrets (tests internal queries)
DO $$
DECLARE
  test_id BIGINT;
BEGIN
  -- This will fail with clear error if Vault not configured
  SELECT trigger_reminder_job('day_before') INTO test_id;
  RAISE NOTICE 'Function executed, request_id: %', test_id;
END $$;

-- 3. Check HTTP response (after running above)
SELECT id, status_code, timed_out
FROM net._http_response
ORDER BY created DESC
LIMIT 3;
-- Expected: Recent entries with status_code 200
```
</verification>

<success_criteria>
1. trigger_reminder_job function created in database
2. Function accepts TEXT parameter for reminder_type
3. Function returns BIGINT request_id
4. Function retrieves credentials from Vault (not hardcoded)
5. Test invocation returns 200 status code from Edge Function
6. Migration file committed to repository
</success_criteria>

<output>
After completion, create `.planning/phases/01-scheduler-infrastructure/01-03-SUMMARY.md`
</output>
