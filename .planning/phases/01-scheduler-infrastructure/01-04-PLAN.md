---
phase: 01-scheduler-infrastructure
plan: 04
type: execute
wave: 4
depends_on: ["01-03"]
files_modified:
  - eventflow-app/supabase/migrations/20260128000004_schedule_reminder_jobs.sql
autonomous: true

must_haves:
  truths:
    - "Cron job for 15_min reminders runs every 5 minutes"
    - "Cron job for day_before reminders runs daily at 6 AM UTC"
    - "Cron job for morning reminders runs daily at 4 AM UTC"
    - "All cron jobs are active and visible in cron.job table"
    - "Job execution history visible in cron.job_run_details"
  artifacts:
    - path: "eventflow-app/supabase/migrations/20260128000004_schedule_reminder_jobs.sql"
      provides: "Cron job schedule configuration"
      contains: "cron.schedule"
      min_lines: 30
  key_links:
    - from: "cron.job"
      to: "trigger_reminder_job"
      via: "cron.schedule command"
      pattern: "trigger_reminder_job"
    - from: "cron.job_run_details"
      to: "cron.job"
      via: "jobid foreign key"
      pattern: "cron\\.job_run_details"
---

<objective>
Schedule pg_cron jobs to invoke trigger_reminder_job at appropriate intervals for each reminder type.

Purpose: This is the core scheduler configuration - it defines WHEN reminders are checked. Jobs run in UTC; times are calculated to align with Israel timezone.
Output: Three active cron jobs checking for reminders on schedule.
</objective>

<execution_context>
@/Users/eliyawolfman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eliyawolfman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-scheduler-infrastructure/01-RESEARCH.md
@.planning/phases/01-scheduler-infrastructure/01-03-SUMMARY.md

# Reference for reminder type handling
@eventflow-scaffold/functions/send-reminder.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cron job schedule migration</name>
  <files>eventflow-app/supabase/migrations/20260128000004_schedule_reminder_jobs.sql</files>
  <action>
Create a SQL migration file that schedules the three reminder cron jobs.

Timezone calculations (pg_cron uses UTC only):
- Israel Standard Time (IST) = UTC+2
- Israel Daylight Time (IDT) = UTC+3
- Use UTC+2 as baseline (err on early side during DST)

Job schedules:
1. 15_min: Every 5 minutes (checks for sessions starting soon)
2. day_before: Daily at 6 AM UTC = 8 AM Israel (send day-before reminders)
3. morning: Daily at 4 AM UTC = 6 AM Israel (send morning-of reminders)

Contents:
```sql
-- ============================================================================
-- Reminder Cron Job Schedules
-- ============================================================================
-- pg_cron uses UTC timezone. Times calculated for Israel (UTC+2/+3):
-- - 6 AM UTC = 8 AM Israel (standard) / 9 AM Israel (DST)
-- - 4 AM UTC = 6 AM Israel (standard) / 7 AM Israel (DST)
--
-- Cron expression format: minute hour day month weekday
-- ============================================================================

-- Job 1: 15-minute session reminders (every 5 minutes)
-- Checks for sessions starting in 15-20 minutes
SELECT cron.schedule(
  'check_reminders_15min',
  '*/5 * * * *',
  $$SELECT trigger_reminder_job('15_min');$$
);

-- Job 2: Day-before reminders (daily at 6 AM UTC)
-- Checks for events happening tomorrow
SELECT cron.schedule(
  'check_reminders_day_before',
  '0 6 * * *',
  $$SELECT trigger_reminder_job('day_before');$$
);

-- Job 3: Morning-of reminders (daily at 4 AM UTC)
-- Checks for events happening today
SELECT cron.schedule(
  'check_reminders_morning',
  '0 4 * * *',
  $$SELECT trigger_reminder_job('morning');$$
);

-- ============================================================================
-- Monitoring View
-- ============================================================================
-- Create a view for easy monitoring of job status

CREATE OR REPLACE VIEW cron_job_status AS
SELECT
  j.jobid,
  j.jobname,
  j.schedule,
  j.command,
  j.active,
  d.runid,
  d.status,
  d.return_message,
  d.start_time,
  d.end_time,
  EXTRACT(EPOCH FROM (d.end_time - d.start_time))::numeric(10,3) AS duration_seconds
FROM cron.job j
LEFT JOIN LATERAL (
  SELECT *
  FROM cron.job_run_details
  WHERE jobid = j.jobid
  ORDER BY start_time DESC
  LIMIT 1
) d ON true
WHERE j.jobname LIKE 'check_reminders%'
ORDER BY j.jobid;

COMMENT ON VIEW cron_job_status IS
  'Shows current status and last run details for reminder cron jobs. '
  'Use for monitoring and debugging scheduler issues.';

-- Grant access to monitoring view
GRANT SELECT ON cron_job_status TO postgres;
GRANT SELECT ON cron_job_status TO authenticated;
```

Key design decisions:
- Unique job names (check_reminders_*) for easy identification
- Dollar-quoting ($$) for command strings to avoid escaping issues
- Monitoring view joins job config with latest run details
- Early morning times to catch participants before their day starts
  </action>
  <verify>
File exists and contains:
- Three cron.schedule calls
- Job names: check_reminders_15min, check_reminders_day_before, check_reminders_morning
- cron_job_status view creation
  </verify>
  <done>Migration file created with all cron job schedules and monitoring view</done>
</task>

<task type="auto">
  <name>Task 2: Apply migration and verify jobs scheduled</name>
  <files>eventflow-app/supabase/migrations/20260128000004_schedule_reminder_jobs.sql</files>
  <action>
Apply the migration to create the cron jobs.

Option A (Supabase CLI):
```bash
cd eventflow-app && npx supabase db push
```

Option B (SQL Editor):
Copy migration SQL and execute in Supabase Dashboard SQL Editor.

After applying, verify jobs exist:
```sql
-- List all scheduled jobs
SELECT jobid, jobname, schedule, active, database
FROM cron.job
WHERE jobname LIKE 'check_reminders%'
ORDER BY jobid;
```

Expected: 3 rows showing all reminder jobs as active.
  </action>
  <verify>
Query returns 3 active jobs:
1. check_reminders_15min with schedule '*/5 * * * *'
2. check_reminders_day_before with schedule '0 6 * * *'
3. check_reminders_morning with schedule '0 4 * * *'
  </verify>
  <done>All three cron jobs scheduled and active</done>
</task>

<task type="auto">
  <name>Task 3: Verify monitoring and wait for first execution</name>
  <files>None (verification only)</files>
  <action>
Verify the monitoring view works and observe job execution.

1. Check monitoring view:
```sql
SELECT * FROM cron_job_status;
```
Should show all 3 jobs. Initial run details may be NULL until first execution.

2. The 15_min job runs every 5 minutes. Wait up to 5 minutes, then check:
```sql
-- Check for recent job runs
SELECT
  jobid,
  runid,
  status,
  return_message,
  start_time,
  end_time
FROM cron.job_run_details
WHERE start_time > NOW() - INTERVAL '10 minutes'
ORDER BY start_time DESC;
```

3. Verify job executed successfully:
```sql
-- Check monitoring view for latest status
SELECT jobname, status, duration_seconds, start_time
FROM cron_job_status
WHERE status IS NOT NULL;
```

Expected: At least one job shows status = 'succeeded'.

If status = 'failed':
- Check return_message for error details
- Verify trigger_reminder_job works manually
- Check Edge Function logs in Dashboard
  </action>
  <verify>
At least one job execution visible in cron.job_run_details with status = 'succeeded'.
Monitoring view (cron_job_status) returns valid data.
  </verify>
  <done>Cron jobs running on schedule, monitoring view functional</done>
</task>

</tasks>

<verification>
Complete verification of Phase 1 success criteria:

```sql
-- 1. pg_cron extension enabled
SELECT extname FROM pg_extension WHERE extname = 'pg_cron';

-- 2. trigger_reminder_job function exists and callable
SELECT routine_name FROM information_schema.routines
WHERE routine_name = 'trigger_reminder_job';

-- 3. Cron jobs configured
SELECT jobname, schedule, active
FROM cron.job
WHERE jobname LIKE 'check_reminders%';
-- Expected: 3 rows, all active=true

-- 4. Test execution (manual trigger)
SELECT trigger_reminder_job('day_before') AS manual_test;

-- 5. Verify execution via monitoring
SELECT * FROM cron_job_status;
```

All five checks must pass for Phase 1 completion.
</verification>

<success_criteria>
1. check_reminders_15min job scheduled (every 5 minutes)
2. check_reminders_day_before job scheduled (daily 6 AM UTC)
3. check_reminders_morning job scheduled (daily 4 AM UTC)
4. All jobs show active = true in cron.job
5. At least one job has executed (visible in cron.job_run_details)
6. cron_job_status monitoring view returns data
7. Migration file committed to repository
</success_criteria>

<output>
After completion, create `.planning/phases/01-scheduler-infrastructure/01-04-SUMMARY.md`
</output>
