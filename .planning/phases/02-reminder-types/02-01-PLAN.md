---
phase: 02-reminder-types
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - eventflow-app/supabase/migrations/20260128_reminder_types_schema.sql
autonomous: true

must_haves:
  truths:
    - "message_type enum includes all 8 reminder types"
    - "events.settings JSONB has default values for all 8 reminder types"
    - "New events inherit reminder preferences correctly"
  artifacts:
    - path: "eventflow-app/supabase/migrations/20260128_reminder_types_schema.sql"
      provides: "Schema updates for new reminder types"
      min_lines: 30
  key_links:
    - from: "message_type enum"
      to: "messages table"
      via: "type column constraint"
      pattern: "ALTER TYPE message_type ADD VALUE"
    - from: "events.settings default"
      to: "events table"
      via: "column default constraint"
      pattern: "ALTER TABLE events ALTER COLUMN settings SET DEFAULT"
---

<objective>
Add schema support for 5 new reminder types (activation, week_before, event_end, follow_up_3mo, follow_up_6mo).

Purpose: Enable send-reminder Edge Function to use new reminder types without schema errors.
Output: Migration file extending message_type enum and events.settings defaults.
</objective>

<execution_context>
@/Users/eliyawolfman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eliyawolfman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@eventflow-scaffold/schema.sql
@.planning/phases/01-scheduler-infrastructure/01-01-SUMMARY.md
@.planning/phases/01-scheduler-infrastructure/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create schema migration for new reminder types</name>
  <files>eventflow-app/supabase/migrations/20260128_reminder_types_schema.sql</files>
  <action>
Create migration file that:

1. **Add new message_type enum values** (5 new types):
   ```sql
   ALTER TYPE message_type ADD VALUE IF NOT EXISTS 'reminder_activation';
   ALTER TYPE message_type ADD VALUE IF NOT EXISTS 'reminder_week_before';
   ALTER TYPE message_type ADD VALUE IF NOT EXISTS 'reminder_event_end';
   ALTER TYPE message_type ADD VALUE IF NOT EXISTS 'reminder_follow_up_3mo';
   ALTER TYPE message_type ADD VALUE IF NOT EXISTS 'reminder_follow_up_6mo';
   ```

2. **Update events.settings default** to include new reminder flags:
   ```sql
   -- Get current default and extend it
   ALTER TABLE events
   ALTER COLUMN settings
   SET DEFAULT jsonb_build_object(
     'send_reminders', true,
     'reminder_activation', true,
     'reminder_week_before', true,
     'reminder_day_before', true,
     'reminder_morning', true,
     'reminder_15min', true,
     'reminder_event_end', true,
     'reminder_follow_up_3mo', false,  -- Opt-in by default
     'reminder_follow_up_6mo', false   -- Opt-in by default
   );
   ```

3. **Update existing events** to have new flags (preserve existing settings):
   ```sql
   -- For all events without the new flags, add them
   UPDATE events
   SET settings = settings || jsonb_build_object(
     'reminder_activation', true,
     'reminder_week_before', true,
     'reminder_event_end', true,
     'reminder_follow_up_3mo', false,
     'reminder_follow_up_6mo', false
   )
   WHERE settings IS NOT NULL
   AND (
     settings->>'reminder_activation' IS NULL
     OR settings->>'reminder_week_before' IS NULL
     OR settings->>'reminder_event_end' IS NULL
     OR settings->>'reminder_follow_up_3mo' IS NULL
     OR settings->>'reminder_follow_up_6mo' IS NULL
   );
   ```

**IMPORTANT:**
- Use `IF NOT EXISTS` for enum additions (avoids errors on re-run)
- Use `||` operator to merge JSONB (preserves existing settings)
- Set follow-up reminders to `false` by default (opt-in feature per ROADMAP)
- DO NOT drop or recreate the enum (breaks existing data)
  </action>
  <verify>
Execute migration via Supabase MCP:
```bash
# Verify enum values added
SELECT unnest(enum_range(NULL::message_type)) as value ORDER BY value;
# Should include all 8 reminder types

# Verify events.settings defaults
SELECT column_default FROM information_schema.columns
WHERE table_name = 'events' AND column_name = 'settings';
# Should show JSON with all 8 reminder flags

# Check existing events have new flags
SELECT count(*) FROM events
WHERE settings->>'reminder_activation' IS NOT NULL;
# Should equal total event count
```
  </verify>
  <done>
- message_type enum includes: reminder_activation, reminder_week_before, reminder_event_end, reminder_follow_up_3mo, reminder_follow_up_6mo
- events.settings default includes all 8 reminder flags
- All existing events updated with new flags (preserving existing settings)
- Migration file committed to repo
  </done>
</task>

<task type="auto">
  <name>Deploy schema migration to Supabase</name>
  <files>N/A (database operation)</files>
  <action>
Execute the migration using Supabase MCP tool:

```typescript
// Use execute_sql with the migration content
await mcp.execute_sql({
  sql: readFileSync('eventflow-app/supabase/migrations/20260128_reminder_types_schema.sql', 'utf8')
})
```

Then verify deployment:
1. Query enum values to confirm additions
2. Query events table to confirm settings updates
3. Check migration is idempotent (can run twice safely)

**Why MCP not psql:** Supabase MCP handles project context, credentials, and logging automatically.
  </action>
  <verify>
```sql
-- 1. Enum has all values
SELECT unnest(enum_range(NULL::message_type)) as value;
-- Expected: 13+ values including all reminder types

-- 2. New events get correct defaults
INSERT INTO events (organization_id, name, start_date, end_date)
VALUES (
  (SELECT id FROM organizations LIMIT 1),
  'Test Event Schema',
  NOW() + interval '7 days',
  NOW() + interval '7 days'
)
RETURNING settings;
-- Expected: JSONB with all 8 reminder flags

-- 3. Cleanup test
DELETE FROM events WHERE name = 'Test Event Schema';
```
  </verify>
  <done>
- Schema migration executed successfully in Supabase project byhohetafnhlakqbydbj
- All enum values present and queryable
- New events inherit all 8 reminder flags
- Test insert/delete confirms schema working
  </done>
</task>

</tasks>

<verification>
Run queries to confirm:
1. `SELECT unnest(enum_range(NULL::message_type))` shows 13+ types
2. All existing events have new reminder flags in settings JSONB
3. Migration is idempotent (running twice produces same result)
</verification>

<success_criteria>
- [ ] Migration file exists with enum additions and settings updates
- [ ] Migration executed via Supabase MCP without errors
- [ ] message_type enum includes all 5 new reminder types
- [ ] events.settings default includes all 8 reminder flags
- [ ] Existing events updated with new flags (verified via query)
- [ ] Follow-up flags default to false (opt-in behavior)
</success_criteria>

<output>
After completion, create `.planning/phases/02-reminder-types/02-01-SUMMARY.md` documenting:
- Migration file path
- Enum values added
- Settings flags added
- Verification query results
</output>
