---
phase: 02-reminder-types
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - eventflow-scaffold/functions/send-reminder.ts
autonomous: true

must_haves:
  truths:
    - "Activation reminder sends when event becomes active"
    - "Week-before reminder sends 7 days before event"
    - "No duplicate reminders sent to same participant for same event"
    - "Reminders respect event settings flags"
  artifacts:
    - path: "eventflow-scaffold/functions/send-reminder.ts"
      provides: "Activation and week-before reminder handlers"
      min_lines: 400
      exports: ["serve"]
  key_links:
    - from: "ReminderJob interface"
      to: "type handlers"
      via: "if (type === 'activation') block"
      pattern: "if \\(type === '(activation|week_before)'\\)"
    - from: "messages table"
      to: "deduplication check"
      via: ".eq('type', 'reminder_activation')"
      pattern: "\\.eq\\('type', 'reminder_"
---

<objective>
Add activation and week-before reminder handlers to send-reminder Edge Function.

Purpose: Enable early-stage event reminders (when manager activates event, 7 days before event).
Output: Updated send-reminder.ts with 2 new reminder type handlers deployed to Supabase.
</objective>

<execution_context>
@/Users/eliyawolfman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eliyawolfman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@eventflow-scaffold/functions/send-reminder.ts
@.planning/phases/02-reminder-types/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Add activation and week_before handlers to send-reminder.ts</name>
  <files>eventflow-scaffold/functions/send-reminder.ts</files>
  <action>
Modify send-reminder.ts to add 2 new type handlers. Follow EXACT pattern of existing handlers.

**Step 1: Update ReminderJob interface (line 14):**
```typescript
interface ReminderJob {
  type: 'activation' | 'week_before' | 'day_before' | 'morning' | '15_min'
}
```

**Step 2: Add activation handler (after line 31, before day_before):**
```typescript
if (type === 'activation') {
  // Find events that are 'active' and have no activation reminder sent yet
  const { data: events } = await supabase
    .from('events')
    .select(`
      id, name, start_date, venue_name, venue_address, organization_id,
      settings,
      participants (
        id, first_name, phone_normalized, status
      )
    `)
    .eq('status', 'active')

  if (events) {
    for (const event of events) {
      if (!event.settings?.reminder_activation) continue

      for (const participant of event.participants || []) {
        if (participant.status !== 'confirmed') continue

        results.processed++

        // Check if activation reminder already sent - CRITICAL: prevents duplicates
        const { data: existingMsg } = await supabase
          .from('messages')
          .select('id')
          .eq('event_id', event.id)
          .eq('participant_id', participant.id)
          .eq('type', 'reminder_activation')
          .maybeSingle()

        if (existingMsg) continue

        const message = buildActivationMessage(event, participant)

        const { data: msgData, error: msgError } = await supabase
          .from('messages')
          .insert({
            event_id: event.id,
            participant_id: participant.id,
            type: 'reminder_activation',
            channel: 'whatsapp',
            recipient_name: participant.first_name,
            recipient_phone: participant.phone_normalized,
            content: message,
            status: 'pending',
          })
          .select()
          .maybeSingle()

        if (msgError || !msgData) {
          results.errors++
          continue
        }

        const sendResult = await sendWhatsApp(
          supabase,
          event.organization_id,
          participant.phone_normalized,
          message,
          msgData.id
        )

        if (sendResult.success) results.sent++
        else results.errors++
      }
    }
  }
}
```

**Step 3: Add week_before handler (after activation, before day_before):**
```typescript
if (type === 'week_before') {
  // Find events happening in exactly 7 days
  const in7days = new Date(now)
  in7days.setDate(in7days.getDate() + 7)
  in7days.setHours(0, 0, 0, 0)

  const in8days = new Date(in7days)
  in8days.setDate(in8days.getDate() + 1)

  const { data: events } = await supabase
    .from('events')
    .select(`
      id, name, start_date, venue_name, venue_address, organization_id,
      settings,
      participants (
        id, first_name, phone_normalized, status
      )
    `)
    .gte('start_date', in7days.toISOString())
    .lt('start_date', in8days.toISOString())
    .eq('status', 'active')

  if (events) {
    for (const event of events) {
      if (!event.settings?.reminder_week_before) continue

      for (const participant of event.participants || []) {
        if (participant.status !== 'confirmed') continue

        results.processed++

        const { data: existingMsg } = await supabase
          .from('messages')
          .select('id')
          .eq('event_id', event.id)
          .eq('participant_id', participant.id)
          .eq('type', 'reminder_week_before')
          .maybeSingle()

        if (existingMsg) continue

        const message = buildWeekBeforeMessage(event, participant)

        const { data: msgData, error: msgError } = await supabase
          .from('messages')
          .insert({
            event_id: event.id,
            participant_id: participant.id,
            type: 'reminder_week_before',
            channel: 'whatsapp',
            recipient_name: participant.first_name,
            recipient_phone: participant.phone_normalized,
            content: message,
            status: 'pending',
          })
          .select()
          .maybeSingle()

        if (msgError || !msgData) {
          results.errors++
          continue
        }

        const sendResult = await sendWhatsApp(
          supabase,
          event.organization_id,
          participant.phone_normalized,
          message,
          msgData.id
        )

        if (sendResult.success) results.sent++
        else results.errors++
      }
    }
  }
}
```

**Step 4: Add message builder functions (after buildMorningMessage, line 319):**
```typescript
function buildActivationMessage(event: any, participant: any): string {
  const eventDate = new Date(event.start_date)
  const dateStr = eventDate.toLocaleDateString('he-IL', {
    weekday: 'long', day: 'numeric', month: 'long'
  })
  const timeStr = eventDate.toLocaleTimeString('he-IL', {
    hour: '2-digit', minute: '2-digit'
  })

  return `×”×™×™ ${participant.first_name}! ğŸ‰

× ×¨×©××ª ×‘×”×¦×œ×—×” ×œ××™×¨×•×¢: ${event.name}

ğŸ“… ${dateStr}
ğŸ• ${timeStr}
ğŸ“ ${event.venue_name || ''} ${event.venue_address || ''}

× ×ª×¨××” ×©×! ğŸ‘‹`
}

function buildWeekBeforeMessage(event: any, participant: any): string {
  const eventDate = new Date(event.start_date)
  const dateStr = eventDate.toLocaleDateString('he-IL', {
    weekday: 'long', day: 'numeric', month: 'long'
  })
  const timeStr = eventDate.toLocaleTimeString('he-IL', {
    hour: '2-digit', minute: '2-digit'
  })

  return `×”×™×™ ${participant.first_name}! â°

×¢×•×“ ×©×‘×•×¢ ×œ-${event.name}

ğŸ“… ${dateStr}
ğŸ• ${timeStr}
ğŸ“ ${event.venue_name || ''} ${event.venue_address || ''}

××¦×¤×™× ×œ×¨××•×ª×š! âœ¨`
}
```

**CRITICAL:**
- Use EXACT deduplication pattern: `.eq('type', 'reminder_X').maybeSingle()`
- Follow existing code style (no new patterns)
- Use timezone-aware date formatting (he-IL locale)
- Check `event.settings?.reminder_X` flag before processing
  </action>
  <verify>
```bash
# 1. Syntax check (TypeScript compilation)
cd eventflow-scaffold/functions/send-reminder && deno cache index.ts

# 2. Deploy to Supabase
# (Uses Supabase MCP deploy_edge_function)

# 3. Test activation reminder via SQL
SELECT * FROM trigger_reminder_job('activation');
# Check: processed > 0, no errors

# 4. Verify message created
SELECT type, recipient_name, content
FROM messages
WHERE type = 'reminder_activation'
ORDER BY created_at DESC
LIMIT 5;

# 5. Test week_before (requires event in 7 days)
# Create test event first if none exist
```
  </verify>
  <done>
- send-reminder.ts includes activation and week_before handlers
- ReminderJob interface updated with new types
- Message builder functions added
- Function deployed to Supabase (version 6+)
- Test calls to trigger_reminder_job() return success
- Messages table shows new reminder_activation and reminder_week_before entries
  </done>
</task>

<task type="auto">
  <name>Deploy updated send-reminder function to Supabase</name>
  <files>N/A (deployment operation)</files>
  <action>
Deploy the updated Edge Function using Supabase MCP:

```typescript
await mcp.deploy_edge_function({
  function_name: 'send-reminder',
  source_path: 'eventflow-scaffold/functions/send-reminder',
  verify_https: true,
  import_map: false  // Not using import map for this function
})
```

After deployment:
1. Verify function version incremented (should be v6+)
2. Test with manual trigger_reminder_job call
3. Check logs for any runtime errors

**Why deploy via MCP:** Handles Supabase CLI authentication, project targeting, and edge function bundling automatically.
  </action>
  <verify>
```sql
-- Manual trigger test for activation
SELECT net.http_post(
  url := current_setting('app.settings.supabase_url') || '/functions/v1/send-reminder',
  headers := jsonb_build_object(
    'Authorization', 'Bearer ' || current_setting('app.settings.service_role_key'),
    'Content-Type', 'application/json'
  ),
  body := jsonb_build_object('type', 'activation')
);

-- Check for errors in response
SELECT * FROM messages
WHERE type = 'reminder_activation'
ORDER BY created_at DESC LIMIT 1;
```
  </verify>
  <done>
- send-reminder Edge Function deployed (version 6+)
- Function accepts 'activation' and 'week_before' type parameters
- Manual test triggers return 200 status
- No runtime errors in Supabase logs
  </done>
</task>

</tasks>

<verification>
Execute trigger_reminder_job for both new types:
```sql
SELECT trigger_reminder_job('activation');
SELECT trigger_reminder_job('week_before');
```

Check messages table for new entries:
```sql
SELECT type, count(*)
FROM messages
WHERE type IN ('reminder_activation', 'reminder_week_before')
GROUP BY type;
```
</verification>

<success_criteria>
- [ ] send-reminder.ts updated with activation and week_before handlers
- [ ] ReminderJob interface includes new types
- [ ] Message builder functions added for both types
- [ ] Edge Function deployed to Supabase successfully
- [ ] trigger_reminder_job('activation') executes without errors
- [ ] trigger_reminder_job('week_before') executes without errors
- [ ] Messages created in database with correct type values
- [ ] No duplicate reminders sent (verified via dedup check)
</success_criteria>

<output>
After completion, create `.planning/phases/02-reminder-types/02-02-SUMMARY.md` documenting:
- Code changes made
- Deployment version
- Test results (trigger_reminder_job calls)
- Sample messages created
</output>
