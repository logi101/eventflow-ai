---
phase: 02-reminder-types
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "All 8 reminder types execute without errors"
    - "Each type creates messages with correct type value"
    - "Deduplication prevents double-sending"
    - "Settings flags control reminder behavior"
  artifacts:
    - path: "messages table"
      provides: "Verification data for all reminder types"
      contains: "8 different reminder_* type values"
  key_links:
    - from: "trigger_reminder_job calls"
      to: "messages table"
      via: "Edge Function execution"
      pattern: "INSERT INTO messages.*type = 'reminder_"
    - from: "cron.schedule jobs"
      to: "trigger_reminder_job"
      via: "scheduled execution"
      pattern: "SELECT trigger_reminder_job"
---

<objective>
Verify all 8 reminder types work correctly end-to-end via manual testing.

Purpose: Confirm Phase 2 implementation before marking phase complete.
Output: Test report documenting all 8 types working, no errors, correct deduplication.
</objective>

<execution_context>
@/Users/eliyawolfman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eliyawolfman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-reminder-types/02-01-SUMMARY.md
@.planning/phases/02-reminder-types/02-02-SUMMARY.md
@.planning/phases/02-reminder-types/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Execute full test suite for all 8 reminder types</name>
  <files>N/A (testing operation)</files>
  <action>
Run comprehensive verification tests via Supabase MCP execute_sql.

**Test 1: Verify schema is ready**
```sql
-- Check enum has all 8 reminder types
SELECT unnest(enum_range(NULL::message_type)) as type
WHERE type::text LIKE 'reminder_%'
ORDER BY type;
-- Expected: 8 rows

-- Check events.settings defaults
SELECT column_default
FROM information_schema.columns
WHERE table_name = 'events' AND column_name = 'settings';
-- Expected: JSON with all 8 reminder_* flags
```

**Test 2: Test each reminder type manually**
```sql
-- Activation (finds active events without activation reminder)
SELECT trigger_reminder_job('activation') as result;

-- Week before (finds events 7 days out)
SELECT trigger_reminder_job('week_before') as result;

-- Day before (finds events tomorrow)
SELECT trigger_reminder_job('day_before') as result;

-- Morning (finds events today)
SELECT trigger_reminder_job('morning') as result;

-- 15-minute (finds sessions starting in 15-20 min)
SELECT trigger_reminder_job('15_min') as result;

-- Event end (finds events past end_date)
SELECT trigger_reminder_job('event_end') as result;

-- 3-month follow-up (finds events completed ~90 days ago with approval)
SELECT trigger_reminder_job('follow_up_3mo') as result;

-- 6-month follow-up (finds events completed ~180 days ago with approval)
SELECT trigger_reminder_job('follow_up_6mo') as result;
```

**Test 3: Verify messages created**
```sql
-- Check all 8 types have messages (or 0 if no eligible events)
SELECT
  type,
  count(*) as message_count,
  count(DISTINCT event_id) as event_count,
  max(created_at) as latest_message
FROM messages
WHERE type IN (
  'reminder_activation',
  'reminder_week_before',
  'reminder_day_before',
  'reminder_morning',
  'reminder_15min',
  'reminder_event_end',
  'reminder_follow_up_3mo',
  'reminder_follow_up_6mo'
)
GROUP BY type
ORDER BY type;
```

**Test 4: Verify deduplication**
```sql
-- Run same trigger twice - should NOT create duplicates
SELECT trigger_reminder_job('day_before');
SELECT trigger_reminder_job('day_before');

-- Check no duplicates
SELECT event_id, participant_id, type, count(*) as count
FROM messages
WHERE type = 'reminder_day_before'
GROUP BY event_id, participant_id, type
HAVING count(*) > 1;
-- Expected: 0 rows
```

**Test 5: Verify settings flags respected**
```sql
-- Find an event with reminder_activation = false
UPDATE events
SET settings = settings || '{"reminder_activation": false}'::jsonb
WHERE id = (SELECT id FROM events WHERE status = 'active' LIMIT 1)
RETURNING id;

-- Run activation trigger
SELECT trigger_reminder_job('activation');

-- Verify NO message created for that event
SELECT count(*) FROM messages
WHERE event_id = (SELECT id FROM events WHERE status = 'active'
                  AND settings->>'reminder_activation' = 'false' LIMIT 1)
AND type = 'reminder_activation';
-- Expected: 0

-- Restore flag
UPDATE events
SET settings = settings || '{"reminder_activation": true}'::jsonb
WHERE settings->>'reminder_activation' = 'false';
```

**Test 6: Verify cron jobs are active**
```sql
-- Check all 8 cron jobs exist and are scheduled
SELECT jobname, schedule, command, active
FROM cron.job
WHERE jobname LIKE 'reminder_%'
ORDER BY jobname;
-- Expected: 8 rows, all active = true
```

**Test 7: Verify Edge Function response structure**
```sql
-- Call trigger_reminder_job and check response
SELECT trigger_reminder_job('activation');
-- Response should be JSON with success=true, results object
```

Document all test results with:
- Pass/fail status for each test
- Error messages if any
- Message counts per type
- Any unexpected behavior
  </action>
  <verify>
All tests pass:
- [ ] Schema has all 8 reminder types in enum
- [ ] Settings defaults include all 8 flags
- [ ] All 8 trigger_reminder_job calls return success
- [ ] Messages created with correct type values
- [ ] No duplicate messages detected
- [ ] Settings flags prevent reminders when false
- [ ] All 8 cron jobs active
- [ ] Edge Function returns proper JSON responses
  </verify>
  <done>
- All 8 reminder types tested via trigger_reminder_job
- Schema verified (enum + settings defaults)
- Deduplication verified (no duplicates after repeated calls)
- Settings flags verified (false prevents sending)
- Cron jobs confirmed active
- Test report shows 8/8 types working
- No errors in Edge Function logs
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete automated reminder system with all 8 reminder types:
- Activation (when event becomes active)
- Week before (7 days before event)
- Day before (evening before event)
- Morning (day of event)
- 15-minute (before scheduled sessions)
- Event end (thank you after event)
- 3-month follow-up (opt-in by manager)
- 6-month follow-up (opt-in by manager)

Database migrations deployed, Edge Function updated and deployed, all cron jobs active.
  </what-built>
  <how-to-verify>
**Step 1: Check messages table for variety**
```sql
SELECT type, count(*)
FROM messages
WHERE type LIKE 'reminder_%'
GROUP BY type
ORDER BY type;
```
Expected: Multiple rows showing different reminder types (may be 0 for some if no eligible events).

**Step 2: Verify a reminder can be triggered**
```sql
-- Pick any type that has eligible events
SELECT trigger_reminder_job('day_before');
```
Expected: Returns JSON `{"success": true, "results": {"processed": N, "sent": N, "errors": 0}}`

**Step 3: Check Supabase Edge Functions logs**
1. Go to Supabase Dashboard > Edge Functions > send-reminder
2. Check recent invocations
3. Look for any error logs

Expected: Successful invocations, no errors.

**Step 4: Verify settings flags work**
```sql
-- Check an event's settings
SELECT name, settings
FROM events
WHERE status = 'active'
LIMIT 1;
```
Expected: settings JSONB includes all 8 reminder_* flags.

**Step 5: Check cron jobs are running**
```sql
SELECT jobname, schedule, active
FROM cron.job
WHERE jobname LIKE 'reminder_%'
ORDER BY jobname;
```
Expected: 8 rows, all active = true.

**If any test fails:**
1. Note which specific test failed
2. Copy error message or unexpected output
3. Include relevant query results
  </how-to-verify>
  <resume-signal>
Type "verified" if all 5 steps passed, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
Human verification confirms:
1. All 8 reminder types callable and working
2. Messages created with correct type values
3. No errors in Edge Function logs
4. Settings flags present in events table
5. All cron jobs active
</verification>

<success_criteria>
- [ ] All 8 trigger_reminder_job calls execute successfully
- [ ] Messages table contains entries for multiple reminder types
- [ ] Deduplication test passes (no duplicates)
- [ ] Settings flags test passes (false prevents sending)
- [ ] Cron jobs confirmed active
- [ ] Edge Function logs show no errors
- [ ] Human verification confirms all tests passed
- [ ] Test report documents results
</success_criteria>

<output>
After completion, create `.planning/phases/02-reminder-types/02-04-SUMMARY.md` documenting:
- Test suite results (8/8 types)
- Message counts per type
- Any edge cases discovered
- Verification outcome (all tests passed)
- Cron job status
</output>
