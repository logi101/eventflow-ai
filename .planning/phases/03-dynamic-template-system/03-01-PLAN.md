---
phase: 03-dynamic-template-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true

must_haves:
  truths:
    - "8 system templates exist in message_templates table (one per reminder type)"
    - "Each template has correct message_type enum value"
    - "Each template contains Hebrew content with {{variable}} placeholders"
    - "Each template has variables JSONB listing available placeholders"
  artifacts:
    - path: "Supabase migration: seed_reminder_templates"
      provides: "8 rows in message_templates with is_system=true"
  key_links:
    - from: "message_templates.message_type"
      to: "message_type enum"
      via: "enum constraint"
      pattern: "reminder_activation|reminder_week_before|reminder_day_before|reminder_morning|reminder_15min|reminder_event_end|reminder_follow_up_3mo|reminder_follow_up_6mo"
---

<objective>
Seed 8 default reminder templates into the message_templates table.

Purpose: Templates must exist in the database before send-reminder can fetch them. This is the data foundation for the dynamic template system.
Output: 8 rows in message_templates with is_system=true, one per reminder type.
</objective>

<execution_context>
@/Users/eliyawolfman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eliyawolfman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dynamic-template-system/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Seed 8 default reminder templates via Supabase migration</name>
  <files>Supabase migration (applied via MCP apply_migration)</files>
  <action>
Apply a Supabase migration named `seed_reminder_templates` using the `apply_migration` MCP tool on project `byhohetafnhlakqbydbj`.

The migration inserts 8 rows into `message_templates` with these exact values:

CRITICAL column name: The column is `message_type` (NOT `type`). The research file has some examples using `.eq('type', ...)` which is WRONG.

For each template:
- `organization_id`: NULL (system template)
- `name`: Hebrew name describing the template
- `message_type`: Exact enum value (see below)
- `channel`: 'whatsapp'
- `content`: Hebrew message with {{variable}} placeholders
- `variables`: JSONB array of available variable names
- `is_system`: TRUE
- `is_active`: TRUE

The 8 templates and their message_type enum values:

1. `reminder_activation` â€” Registration confirmation when event activates
   - Variables: participant_name, event_name, event_date, event_time, event_location
   - Content pattern: "×”×™×™ {{participant_name}}! × ×¨×©××ª ×‘×”×¦×œ×—×” ×œ××™×¨×•×¢: {{event_name}} ..." with date/time/location

2. `reminder_week_before` â€” One week before event
   - Variables: participant_name, event_name, event_date, event_time, event_location
   - Content: "×”×™×™ {{participant_name}}! ×¢×•×“ ×©×‘×•×¢ ×œ-{{event_name}} ..."

3. `reminder_day_before` â€” Day before event
   - Variables: participant_name, event_name, event_date, event_time, event_location
   - Content: "×”×™×™ {{participant_name}}! ×ª×–×›×•×¨×ª: ××—×¨ {{event_name}} ..."

4. `reminder_morning` â€” Morning of event day
   - Variables: participant_name, event_name, event_time, event_location
   - Content: "×‘×•×§×¨ ×˜×•×‘ {{participant_name}}! ×”×™×•× ×–×” ×”×–××Ÿ - {{event_name}} ..."
   - NOTE: No event_date variable (it's today, redundant)

5. `reminder_15min` â€” 15 minutes before session
   - Variables: participant_name, session_title, session_location, session_room, session_start_time, session_end_time, session_speaker
   - Content: Short format "{{participant_name}}, ×‘×¢×•×“ 15 ×“×§×•×ª: {{session_title}} ğŸ“{{session_location}}"

6. `reminder_event_end` â€” Thank you after event ends
   - Variables: participant_name, event_name
   - Content: "{{participant_name}} ×”×™×§×¨/×”, ×ª×•×“×” ×¨×‘×” ×¢×œ ×”×”×©×ª×ª×¤×•×ª ×‘-{{event_name}}! ..."

7. `reminder_follow_up_3mo` â€” 3 month follow-up
   - Variables: participant_name, event_name
   - Content: "×©×œ×•× {{participant_name}}! ×¢×‘×¨×• 3 ×—×•×“×©×™× ×××– {{event_name}} ..."

8. `reminder_follow_up_6mo` â€” 6 month follow-up
   - Variables: participant_name, event_name
   - Content: "×”×™×™ {{participant_name}}! ×—×¦×™ ×©× ×” ×¢×‘×¨×” ×××– {{event_name}} ..."

Match the existing hardcoded messages in send-reminder.ts v6 as closely as possible so the transition is seamless. Use the exact emoji patterns from the deployed function.

Use `INSERT INTO ... ON CONFLICT DO NOTHING` or wrap in a check to make the migration idempotent (re-runnable). Since there's no unique constraint on message_type for system templates, use a guard: `WHERE NOT EXISTS (SELECT 1 FROM message_templates WHERE is_system = true AND message_type = 'reminder_activation')` pattern, OR simply delete system templates first then re-insert.

Safer approach: Use a DO block that checks count first:
```sql
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM message_templates WHERE is_system = true AND message_type = 'reminder_activation') THEN
    INSERT INTO message_templates (...) VALUES (...), (...), ...;
  END IF;
END $$;
```
  </action>
  <verify>
Run this SQL via execute_sql MCP tool:
```sql
SELECT message_type, name, is_system, is_active, jsonb_array_length(variables) as var_count
FROM message_templates
WHERE is_system = true
ORDER BY
  CASE message_type
    WHEN 'reminder_activation' THEN 1
    WHEN 'reminder_week_before' THEN 2
    WHEN 'reminder_day_before' THEN 3
    WHEN 'reminder_morning' THEN 4
    WHEN 'reminder_15min' THEN 5
    WHEN 'reminder_event_end' THEN 6
    WHEN 'reminder_follow_up_3mo' THEN 7
    WHEN 'reminder_follow_up_6mo' THEN 8
  END;
```
Expected: 8 rows, all is_system=true, is_active=true, var_count between 2 and 7.

Also verify variable content:
```sql
SELECT message_type, content FROM message_templates WHERE is_system = true AND message_type = 'reminder_activation';
```
Expected: Hebrew content with {{participant_name}} and {{event_name}} placeholders.
  </verify>
  <done>8 system templates exist in message_templates table, one per reminder type, each with Hebrew content and correct variable metadata.</done>
</task>

</tasks>

<verification>
1. `SELECT count(*) FROM message_templates WHERE is_system = true` returns 8
2. All 8 message_type values match the enum: reminder_activation, reminder_week_before, reminder_day_before, reminder_morning, reminder_15min, reminder_event_end, reminder_follow_up_3mo, reminder_follow_up_6mo
3. Each template content contains at least {{participant_name}}
4. Variables JSONB matches placeholders in content
</verification>

<success_criteria>
- 8 rows in message_templates with is_system=true
- Each row has valid message_type enum value
- Each row has Hebrew content with {{variable}} placeholders
- Each row has variables JSONB array matching content placeholders
- Migration is idempotent (can be re-run safely)
</success_criteria>

<output>
After completion, create `.planning/phases/03-dynamic-template-system/03-01-SUMMARY.md`
</output>
