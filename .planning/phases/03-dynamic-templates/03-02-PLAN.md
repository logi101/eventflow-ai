---
phase: 03-dynamic-templates
plan: 02
type: verify
wave: 2
depends_on: ["03-01"]
files_modified:
  - eventflow-scaffold/functions/send-reminder.ts
autonomous: false

must_haves:
  truths:
    - "All 8 reminder types return HTTP 200 when triggered"
    - "Messages contain template content from database, not hardcoded strings"
    - "Variable substitution produces correct Hebrew text with participant names and event details"
    - "Templates display correctly in WhatsApp with Hebrew RTL"
    - "No {{placeholder}} text appears in any sent message"
  artifacts:
    - path: "eventflow-scaffold/functions/send-reminder.ts"
      provides: "Deployed Edge Function with dynamic template rendering"
      exports: ["serve"]
  key_links:
    - from: "message_templates table"
      to: "sent messages"
      via: "template fetch -> substitute -> send"
      pattern: "Loaded \\d+ templates from database"
---

<objective>
Deploy updated send-reminder Edge Function and verify all 8 reminder types work with database templates.

Purpose: Confirm the template engine integration is production-ready by deploying and testing each reminder type.
Output: Deployed Edge Function v7+ with verified template rendering for all 8 types.
</objective>

<execution_context>
@/Users/eliyawolfman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eliyawolfman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dynamic-templates/03-CONTEXT.md
@.planning/phases/03-dynamic-templates/03-RESEARCH.md
@.planning/phases/03-dynamic-templates/03-01-SUMMARY.md
@eventflow-scaffold/functions/send-reminder.ts
@eventflow-app/supabase/migrations/20260128000002_seed_reminder_templates.sql
</context>

<tasks>

<task type="auto">
  <name>Deploy updated send-reminder Edge Function</name>
  <files>eventflow-scaffold/functions/send-reminder.ts</files>
  <action>
Deploy the updated Edge Function with template engine to Supabase.

**Pre-deployment check:**
1. Verify send-reminder.ts has all template engine functions:
```bash
grep -c "renderReminderMessage\|fetchTemplateBatch\|substituteVariables\|buildEventTemplateVariables\|buildSessionTemplateVariables" eventflow-scaffold/functions/send-reminder.ts
```
Expected: 15+ occurrences (definitions + usage)

2. Deploy via Supabase CLI or MCP:
```bash
supabase functions deploy send-reminder --project-ref <project-ref>
```

3. Verify deployment succeeded - check function version incremented from v6.

**Post-deployment check:**
- Function status shows "active" in Supabase dashboard
- No deployment errors in logs
  </action>
  <verify>
```bash
# Check Edge Function is deployed and responding
curl -s -o /dev/null -w "%{http_code}" \
  -X POST "${SUPABASE_URL}/functions/v1/send-reminder" \
  -H "Authorization: Bearer ${SERVICE_ROLE_KEY}" \
  -H "Content-Type: application/json" \
  -d '{"type": "activation"}'
# Expected: 200
```
  </verify>
  <done>
- send-reminder Edge Function deployed (version 7+)
- Function active and responding to HTTP requests
- No deployment errors
  </done>
</task>

<task type="checkpoint">
  <name>Verify all 8 reminder types with database templates</name>
  <files>N/A (verification only)</files>
  <action>
Test each of the 8 reminder types via trigger_reminder_job and verify template content.

**Test 1: Verify templates exist in database**
```sql
SELECT message_type, name, is_active, is_system,
       length(content) as content_length,
       variables
FROM message_templates
WHERE is_system = true AND is_active = true
ORDER BY message_type;
```
Expected: 8 rows, all active system templates.

**Test 2: Trigger all 8 types and check responses**
```sql
-- Trigger each type one by one
SELECT trigger_reminder_job('activation');
SELECT trigger_reminder_job('week_before');
SELECT trigger_reminder_job('day_before');
SELECT trigger_reminder_job('morning');
SELECT trigger_reminder_job('15_min');
SELECT trigger_reminder_job('event_end');
SELECT trigger_reminder_job('follow_up_3mo');
SELECT trigger_reminder_job('follow_up_6mo');
```
Expected: All return HTTP 200 with `success: true`.

**Test 3: Check Edge Function logs for template loading**
Look for log line: `Loaded N templates from database`
Expected: N = 8 (all system templates loaded).

**Test 4: Verify message content uses template (not hardcoded)**
```sql
-- Check recent activation messages for template content markers
SELECT content, created_at
FROM messages
WHERE message_type = 'reminder_activation'
ORDER BY created_at DESC
LIMIT 3;
```
Expected: Messages should contain the template phrases like "נרשמת בהצלחה לאירוע" and have proper variable substitution (no {{placeholder}} text visible).

**Test 5: Check for no placeholder leaks**
```sql
-- CRITICAL: ensure no raw {{}} placeholders in sent messages
SELECT id, content, message_type
FROM messages
WHERE content LIKE '%{{%'
  AND created_at > now() - interval '1 hour';
```
Expected: 0 rows (no placeholder leaks).

**Test 6: Verify template-specific content per type**
Check that the activation message includes "שלח לוז" (the template has this but the hardcoded builder did NOT). This confirms the template is being used, not the fallback.
```sql
SELECT content
FROM messages
WHERE message_type = 'reminder_activation'
  AND content LIKE '%שלח "לוז"%'
ORDER BY created_at DESC
LIMIT 1;
```
Expected: At least 1 row. The seeded template includes `שלח "לוז" לצפייה בתוכנית האישית` which the hardcoded builder does NOT have. If this text appears, it proves the DB template is being used.

**CHECKPOINT: Review results before proceeding.**
Present test results table and wait for confirmation that all 8 types are working correctly.
  </action>
  <verify>
All 8 types verified:

| Type | HTTP Status | Template Loaded | Content Correct | No Placeholders |
|------|-------------|-----------------|-----------------|-----------------|
| activation | 200 | Yes | Yes | Yes |
| week_before | 200 | Yes | Yes | Yes |
| day_before | 200 | Yes | Yes | Yes |
| morning | 200 | Yes | Yes | Yes |
| 15_min | 200 | Yes | Yes | Yes |
| event_end | 200 | Yes | Yes | Yes |
| follow_up_3mo | 200 | Yes | Yes | Yes |
| follow_up_6mo | 200 | Yes | Yes | Yes |
  </verify>
  <done>
- All 8 reminder types return HTTP 200
- Templates loaded from database (log confirms "Loaded 8 templates")
- Variable substitution works correctly (no raw {{}} placeholders)
- Template content confirmed via "שלח לוז" marker text
- Hebrew RTL rendering correct in message content
- Messages table entries show template-sourced content
  </done>
</task>

</tasks>

<verification>
Phase 3 complete verification checklist:

1. Template engine deployed:
```sql
-- Trigger activation and check for template marker
SELECT trigger_reminder_job('activation');
SELECT content FROM messages
WHERE message_type = 'reminder_activation'
  AND content LIKE '%שלח "לוז"%'
ORDER BY created_at DESC LIMIT 1;
```

2. No placeholder leaks across entire messages table:
```sql
SELECT count(*) FROM messages WHERE content LIKE '%{{%';
```
Expected: 0

3. All 8 types callable:
```sql
SELECT trigger_reminder_job('activation');
SELECT trigger_reminder_job('week_before');
SELECT trigger_reminder_job('day_before');
SELECT trigger_reminder_job('morning');
SELECT trigger_reminder_job('15_min');
SELECT trigger_reminder_job('event_end');
SELECT trigger_reminder_job('follow_up_3mo');
SELECT trigger_reminder_job('follow_up_6mo');
```
All return 200.
</verification>

<success_criteria>
- [ ] send-reminder Edge Function deployed (version 7+)
- [ ] All 8 trigger_reminder_job calls return HTTP 200
- [ ] Edge Function logs show "Loaded 8 templates from database"
- [ ] Messages contain template content (verified via "שלח לוז" marker)
- [ ] No {{placeholder}} text in any message (verified via SQL query)
- [ ] Variable substitution correct: participant names, event names, dates, times, locations
- [ ] Hardcoded fallback not triggered (no "Using hardcoded fallback" in logs)
- [ ] Hebrew RTL text renders correctly in message content
</success_criteria>

<output>
After completion, create `.planning/phases/03-dynamic-templates/03-02-SUMMARY.md` documenting:
- Deployment version
- Test results table (all 8 types)
- Template loading confirmation
- Placeholder leak check results
- Sample message content showing template variables substituted
- Phase 3 completion status
</output>
