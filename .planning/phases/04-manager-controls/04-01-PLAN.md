---
phase: 04-manager-controls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - eventflow-app/src/types/index.ts
  - eventflow-app/src/modules/events/schemas/eventSettings.ts
  - eventflow-app/src/modules/events/components/EventSettingsPanel.tsx
  - eventflow-app/src/modules/events/components/MessagePreview.tsx
  - eventflow-app/src/pages/events/EventDetailPage.tsx
autonomous: true

must_haves:
  truths:
    - "Manager sees a 'הגדרות תזכורות' tab on EventDetailPage"
    - "Manager can toggle 8 reminder types on/off with checkboxes"
    - "Follow-up toggles (3mo, 6mo) are visually separated from standard reminders"
    - "Saving settings persists to events.settings JSONB in Supabase"
    - "Manager can preview activation message as WhatsApp-style bubble"
    - "Preview shows real event data (name, date, venue) substituted into template"
  artifacts:
    - path: "eventflow-app/src/modules/events/schemas/eventSettings.ts"
      provides: "Zod schema for event settings JSONB"
      contains: "eventSettingsSchema"
    - path: "eventflow-app/src/modules/events/components/EventSettingsPanel.tsx"
      provides: "Settings panel with 8 toggles and save button"
      contains: "EventSettingsPanel"
    - path: "eventflow-app/src/modules/events/components/MessagePreview.tsx"
      provides: "WhatsApp-style message preview with variable substitution"
      contains: "MessagePreview"
  key_links:
    - from: "eventflow-app/src/pages/events/EventDetailPage.tsx"
      to: "EventSettingsPanel"
      via: "New 'settings' tab rendering EventSettingsPanel component"
      pattern: "activeTab.*settings"
    - from: "EventSettingsPanel"
      to: "supabase.from('events').update"
      via: "useMutation for saving settings JSONB"
      pattern: "update.*settings"
    - from: "MessagePreview"
      to: "supabase.from('message_templates')"
      via: "useQuery fetching template by message_type"
      pattern: "message_templates.*message_type"
---

<objective>
Create the Event Settings Panel with reminder toggles and activation message preview.

Purpose: Managers need to control which reminders are enabled per event and preview what participants will receive. The backend (send-reminder v7) already checks events.settings flags, so this plan wires the frontend UI to those existing flags.

Output: EventSettingsPanel component with 8 toggle checkboxes, MessagePreview component showing WhatsApp-style bubble, and a new "settings" tab on EventDetailPage.
</objective>

<execution_context>
@/Users/eliyawolfman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eliyawolfman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dynamic-template-system/03-02-SUMMARY.md
@.planning/phases/04-manager-controls/04-RESEARCH.md
@.planning/codebase/CONVENTIONS.md

Key context from prior phases:
- send-reminder v7 checks `event.settings?.reminder_day_before` etc. for each type
- Follow-up reminders default to false (opt-in)
- Templates in message_templates table, queried by `message_type` column (NOT `type`)
- Use `.is('organization_id', null)` for system template fallback (NOT `.eq('organization_id', null)`)
- Variable substitution: {{participant_name}}, {{event_name}}, {{event_date}}, {{event_time}}, {{event_location}}

Key codebase patterns:
- EventDetailPage has tab system: array of {id, label, icon} → map to buttons, then `activeTab === 'id'` conditionals
- EventForm uses formData state + setFormData pattern (NOT React Hook Form)
- Event interface in types/index.ts does NOT have `settings` or `organization_id` — must add them
- EventContext's Event interface HAS `organization_id` — must keep in sync
- Path aliases: @/types, @/modules, @/lib, @/contexts
- Named exports only, PascalCase components, Hebrew labels, RTL-first
- Supabase client at `@/lib/supabase` (or relative `../../lib/supabase` in pages/)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zod schema and add settings/organization_id to Event type</name>
  <files>
    eventflow-app/src/modules/events/schemas/eventSettings.ts
    eventflow-app/src/types/index.ts
  </files>
  <action>
  1. Create the schemas directory if it doesn't exist: `eventflow-app/src/modules/events/schemas/`

  2. Create `eventSettings.ts` with Zod schema:
     ```typescript
     import { z } from 'zod'

     export const eventSettingsSchema = z.object({
       reminder_activation: z.boolean().default(true),
       reminder_week_before: z.boolean().default(true),
       reminder_day_before: z.boolean().default(true),
       reminder_morning: z.boolean().default(true),
       reminder_15min: z.boolean().default(true),
       reminder_event_end: z.boolean().default(false),
       reminder_follow_up_3mo: z.boolean().default(false),
       reminder_follow_up_6mo: z.boolean().default(false),
     })

     export type EventSettings = z.infer<typeof eventSettingsSchema>
     ```

  3. Add `settings` and `organization_id` to the Event interface in `eventflow-app/src/types/index.ts`:
     - Add `organization_id: string | null` field
     - Add `settings: Record<string, boolean> | null` field (generic JSON, Zod validates at usage)

  IMPORTANT: The EventContext at `eventflow-app/src/contexts/EventContext.tsx` has its own Event interface with `organization_id` already. Do NOT modify EventContext — only update the centralized types/index.ts. The executor should verify the EventContext's Event type also has `organization_id` (it does, confirmed).
  </action>
  <verify>
  - File `eventflow-app/src/modules/events/schemas/eventSettings.ts` exists and exports `eventSettingsSchema` and `EventSettings`
  - `eventflow-app/src/types/index.ts` Event interface has `settings` and `organization_id` fields
  - TypeScript compiles without errors: `cd eventflow-app && npx tsc --noEmit 2>&1 | head -20`
  </verify>
  <done>Zod schema defines 8 boolean reminder flags with correct defaults (follow-ups default false). Event type includes settings and organization_id.</done>
</task>

<task type="auto">
  <name>Task 2: Create EventSettingsPanel and MessagePreview components, add settings tab</name>
  <files>
    eventflow-app/src/modules/events/components/EventSettingsPanel.tsx
    eventflow-app/src/modules/events/components/MessagePreview.tsx
    eventflow-app/src/pages/events/EventDetailPage.tsx
  </files>
  <action>
  1. Create `MessagePreview.tsx` in `eventflow-app/src/modules/events/components/`:
     - Props: `eventId: string`, `organizationId: string | null`, `eventName: string`, `startDate: string`, `venueName: string | null`, `venueAddress: string | null`
     - Fetch template from `message_templates` table using useQuery:
       a) First try org-specific: `.eq('organization_id', organizationId).eq('message_type', 'reminder_activation').eq('is_active', true).maybeSingle()`
       b) If no result, fall back to system template: `.is('organization_id', null).eq('message_type', 'reminder_activation').eq('is_active', true).eq('is_system', true).maybeSingle()`
       CRITICAL: Use `.is('organization_id', null)` for NULL check (NOT `.eq`)
       CRITICAL: Use `message_type` column (NOT `type`)
     - Build variable map with sample participant name "דוגמה משתתף/ת":
       ```
       participant_name: "דוגמה משתתף/ת"
       event_name: eventName
       event_date: formatted with he-IL locale (EEEE, d MMMM pattern using toLocaleDateString)
       event_time: formatted HH:mm
       event_location: venueName + venueAddress (trimmed, fallback "לא צוין מיקום")
       ```
     - Substitute variables: regex replace `{{key}}` with value
     - Render WhatsApp-style bubble:
       - Dark container: `bg-zinc-900 rounded-lg p-4 border border-zinc-700`
       - Header with green circle icon + "תצוגה מקדימה" label
       - Green message bubble: `bg-[#005c4b] text-white rounded-lg p-3 rounded-tr-none max-w-md`
       - Pre-formatted text with `whitespace-pre-wrap font-['Heebo'] text-sm leading-relaxed`
       - Footer: "הודעה זו תישלח דרך WhatsApp" in zinc-400
     - Handle loading state ("טוען תצוגה מקדימה...") and no-template state ("לא נמצאה תבנית הודעה")
     - Import supabase from '@/lib/supabase' and useQuery from '@tanstack/react-query'

  2. Create `EventSettingsPanel.tsx` in `eventflow-app/src/modules/events/components/`:
     - Props: `event` object with id, name, start_date, venue_name, venue_address, organization_id, settings, status
     - Parse current settings using `eventSettingsSchema.parse(event.settings || {})` for defaults
     - Use local state (useState) for settings — NOT React Hook Form (match existing project pattern in EventForm)
     - 8 checkboxes grouped in sections:
       Section 1 "תזכורות אוטומטיות":
         - reminder_activation: "הודעת הפעלה (אחרי הפעלת אירוע)"
         - reminder_week_before: "תזכורת שבוע לפני"
         - reminder_day_before: "תזכורת יום לפני"
         - reminder_morning: "תזכורת בוקר האירוע"
         - reminder_15min: "תזכורת 15 דקות לפני"
         - reminder_event_end: "הודעה בסיום אירוע"
       Section 2 "תזכורות מעקב (אופציונליות)" - separated with border-t:
         - reminder_follow_up_3mo: "מעקב 3 חודשים"
         - reminder_follow_up_6mo: "מעקב 6 חודשים"
     - Checkbox pattern (from project conventions):
       ```html
       <label className="flex items-center gap-3 cursor-pointer">
         <input type="checkbox" checked={settings.reminder_X} onChange={...} className="w-4 h-4 rounded" />
         <span className="text-sm">Label</span>
       </label>
       ```
     - onChange: update local settings state (spread + override single key)
     - Save button: calls Supabase mutation
       ```typescript
       const handleSave = async () => {
         setSaving(true)
         const { error } = await supabase
           .from('events')
           .update({ settings })
           .eq('id', event.id)
         if (error) { showToast(...); setSaving(false); return }
         showToast('הגדרות נשמרו בהצלחה')
         setSaving(false)
       }
       ```
       IMPORTANT: Settings form replaces the ENTIRE settings object. This is safe because the form controls ALL settings keys, so no data is lost.
     - Dirty detection: compare current settings to parsed defaults using JSON.stringify
     - Include MessagePreview component below the save button, passing event props
     - Toast state for success/error feedback (inline, same pattern as EventDetailPage's showToast)

  3. Add "settings" tab to EventDetailPage:
     - Import EventSettingsPanel from `../../modules/events/components/EventSettingsPanel`
     - Import Settings icon from lucide-react (or use Zap which is already imported)
     - Add to the tabs array: `{ id: 'settings', label: 'הגדרות תזכורות', icon: <Zap size={18} /> }`
     - Add tab content conditional: `{activeTab === 'settings' && (<EventSettingsPanel event={event} />)}`
     - The event object from useEvent() is from EventContext which has organization_id but may not have settings. Need to handle: if event.settings is undefined, EventSettingsPanel's parse() handles it with defaults.

  IMPORTANT NOTES:
  - Do NOT use React Hook Form or zodResolver. Use plain useState + manual validation (matches EventForm pattern).
  - Hebrew labels throughout. RTL is handled by parent container's dir="rtl".
  - Use existing styling patterns: `bg-orange-500` for active tab, `hover:bg-gray-100` for inactive.
  - Use `supabase` import from relative path (`../../lib/supabase`) in pages/ or from `@/lib/supabase` in modules/
  </action>
  <verify>
  - `EventSettingsPanel.tsx` exists and renders 8 checkboxes grouped correctly
  - `MessagePreview.tsx` exists and fetches template from message_templates
  - EventDetailPage has 5 tabs including "הגדרות תזכורות"
  - TypeScript compiles: `cd eventflow-app && npx tsc --noEmit 2>&1 | head -30`
  - Dev server runs without errors: start dev server and check console
  </verify>
  <done>EventDetailPage shows settings tab with 8 reminder toggles. Follow-up toggles are visually separated. MessagePreview renders WhatsApp-style activation message with real event data. Save button persists settings to database.</done>
</task>

</tasks>

<verification>
1. Navigate to an event detail page → "הגדרות תזכורות" tab appears
2. Click tab → see 8 checkboxes with correct defaults (first 5 checked, event_end unchecked, follow-ups unchecked)
3. Toggle follow-up 3mo → save → refresh page → toggle persists
4. Activation message preview shows below with green WhatsApp bubble
5. Preview shows event name, formatted date, venue substituted into template
6. TypeScript compiles cleanly
</verification>

<success_criteria>
- Settings tab visible and functional on EventDetailPage
- 8 toggles render with correct Hebrew labels
- Follow-up section visually distinct from standard reminders
- Save persists to events.settings JSONB
- MessagePreview fetches template from DB and renders with substituted variables
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-manager-controls/04-01-SUMMARY.md`
</output>
