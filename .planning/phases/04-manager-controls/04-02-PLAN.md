---
phase: 04-manager-controls
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - eventflow-app/src/modules/events/hooks/useTestReminder.ts
  - eventflow-app/src/modules/events/components/TestReminderButton.tsx
  - eventflow-app/src/modules/events/components/EventSettingsPanel.tsx
autonomous: false

must_haves:
  truths:
    - "Manager can send a test reminder to their own phone number"
    - "Test reminder button shows loading state while sending"
    - "Success/failure feedback appears after test send"
    - "Test message is sent via send-reminder Edge Function with mode:'test'"
    - "Test message is flagged with is_test metadata in messages table"
  artifacts:
    - path: "eventflow-app/src/modules/events/hooks/useTestReminder.ts"
      provides: "TanStack mutation hook for calling send-reminder in test mode"
      contains: "useTestReminder"
    - path: "eventflow-app/src/modules/events/components/TestReminderButton.tsx"
      provides: "Button with loading/success/error states for sending test"
      contains: "TestReminderButton"
  key_links:
    - from: "TestReminderButton"
      to: "useTestReminder"
      via: "useMutation invocation on click"
      pattern: "mutate.*event_id.*reminder_type.*test_phone"
    - from: "useTestReminder"
      to: "supabase.functions.invoke('send-reminder')"
      via: "Edge Function call with mode:'test'"
      pattern: "functions\\.invoke.*send-reminder.*mode.*test"
    - from: "EventSettingsPanel"
      to: "TestReminderButton"
      via: "Rendered inside settings panel with event and phone props"
      pattern: "TestReminderButton"
---

<objective>
Add test reminder functionality so managers can verify reminder delivery before going live.

Purpose: Managers need confidence that reminders work before activating an event. A test button sends a single reminder to the manager's own phone, using the real template and variable substitution pipeline. This validates end-to-end delivery (template fetch, variable substitution, WhatsApp sending).

Output: TestReminderButton component integrated into EventSettingsPanel, useTestReminder hook calling send-reminder Edge Function with test mode, and Edge Function updated to handle test mode.
</objective>

<execution_context>
@/Users/eliyawolfman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eliyawolfman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-manager-controls/04-01-PLAN.md
@.planning/phases/04-manager-controls/04-RESEARCH.md

Key context:
- send-reminder v7 is deployed via MCP `deploy_edge_function` (NOT local Supabase CLI)
- The Edge Function currently handles 8 reminder types triggered by cron
- Supabase project ID: byhohetafnhlakqbydbj
- Edge Function uses: `const { type }: ReminderJob = await req.json()`
- Template functions exist: getMessageTemplate, substituteVariables, buildEventVariableMap
- Edge Function creates Supabase client with SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY env vars
- Frontend calls Edge Functions via: `supabase.functions.invoke('send-reminder', { body: {...} })`
- send-whatsapp Edge Function is the actual WhatsApp sender
- Test messages should have `metadata: { is_test: true }` to not pollute production message queries

Plan 01 SUMMARY context (will exist when this runs):
- EventSettingsPanel created at eventflow-app/src/modules/events/components/EventSettingsPanel.tsx
- Settings tab added to EventDetailPage
- MessagePreview component exists
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useTestReminder hook and TestReminderButton component</name>
  <files>
    eventflow-app/src/modules/events/hooks/useTestReminder.ts
    eventflow-app/src/modules/events/components/TestReminderButton.tsx
  </files>
  <action>
  1. Create hooks directory if it doesn't exist: `eventflow-app/src/modules/events/hooks/`

  2. Create `useTestReminder.ts`:
     ```typescript
     import { supabase } from '@/lib/supabase'
     import { useMutation } from '@tanstack/react-query'

     interface TestReminderRequest {
       event_id: string
       reminder_type: string
       test_phone: string
     }

     interface TestReminderResponse {
       success: boolean
       message?: string
     }

     export function useTestReminder() {
       return useMutation({
         mutationFn: async (request: TestReminderRequest): Promise<TestReminderResponse> => {
           const { data, error } = await supabase.functions.invoke('send-reminder', {
             body: {
               mode: 'test',
               type: request.reminder_type,
               event_id: request.event_id,
               test_phone: request.test_phone,
             }
           })

           if (error) throw error
           return data as TestReminderResponse
         }
       })
     }
     ```

  3. Create `TestReminderButton.tsx`:
     - Props: `eventId: string`, `reminderType: string` (default 'activation'), `testPhone: string`
     - Import useTestReminder hook
     - Import Loader2, Send, CheckCircle, AlertCircle from lucide-react
     - Local state: `status: 'idle' | 'success' | 'error'`
     - handleTest function:
       - Reset status to idle
       - Call `mutate(...)` with onSuccess (set 'success', auto-reset to 'idle' after 3s) and onError (set 'error', auto-reset after 5s)
     - Render:
       - Button with `className="flex items-center gap-2 px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white text-sm transition-colors disabled:opacity-50"`
       - When isPending: show Loader2 spinner + "שולח..."
       - When idle: show Send icon + "שלח הודעת בדיקה"
       - Disabled when: isPending OR !testPhone
       - Below button: success message (green CheckCircle + "הודעה נשלחה בהצלחה") or error message (red AlertCircle + "שליחה נכשלה - נסה שוב")
     - Phone input: Add a small input field for manager to enter their phone number
       - Label: "מספר טלפון לבדיקה"
       - Placeholder: "05X-XXXXXXX"
       - className: "input text-sm" (matches project pattern)
       - Local state for phone number
       - This way the manager enters their own number (no need to access user profile)

  IMPORTANT: The TestReminderButton should be self-contained with its own phone input. This avoids needing to wire up user profile data.
  </action>
  <verify>
  - `useTestReminder.ts` exists with exported function
  - `TestReminderButton.tsx` renders button with phone input
  - TypeScript compiles: `cd eventflow-app && npx tsc --noEmit 2>&1 | head -20`
  </verify>
  <done>useTestReminder hook calls send-reminder Edge Function with test mode. TestReminderButton has phone input, send button with loading/success/error states.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate TestReminderButton into EventSettingsPanel and update Edge Function</name>
  <files>
    eventflow-app/src/modules/events/components/EventSettingsPanel.tsx
  </files>
  <action>
  1. Add TestReminderButton to EventSettingsPanel:
     - Import TestReminderButton from './TestReminderButton'
     - Add a new section below the MessagePreview, separated with border-t:
       - Section header: "בדיקת תזכורות" with description "שלח הודעת בדיקה לטלפון שלך כדי לוודא שהכל עובד"
       - Render: `<TestReminderButton eventId={event.id} />`
       - No need to pass reminderType (defaults to 'activation') or testPhone (managed internally by component)

  2. Update send-reminder Edge Function to handle test mode:
     Deploy updated Edge Function via MCP `deploy_edge_function` tool.

     The Edge Function update adds a test handler at the top of the request processing:

     ```typescript
     // After parsing request body, check for test mode
     const body = await req.json()

     if (body.mode === 'test') {
       // Test mode: send a single test message to the specified phone
       const { event_id, test_phone, type: reminderType } = body

       if (!event_id || !test_phone) {
         return new Response(JSON.stringify({ success: false, message: 'Missing event_id or test_phone' }), {
           headers: { ...corsHeaders, 'Content-Type': 'application/json' },
           status: 400
         })
       }

       // Fetch event data
       const { data: event } = await supabase
         .from('events')
         .select('id, name, start_date, venue_name, venue_address, organization_id')
         .eq('id', event_id)
         .single()

       if (!event) {
         return new Response(JSON.stringify({ success: false, message: 'Event not found' }), {
           headers: { ...corsHeaders, 'Content-Type': 'application/json' },
           status: 404
         })
       }

       // Fetch template (same as production)
       const template = await getMessageTemplate(supabase, event.organization_id, `reminder_${reminderType || 'activation'}`)

       // Build test message
       const testParticipant = { first_name: 'בדיקה' }
       const variableMap = buildEventVariableMap(event, testParticipant)
       const message = template
         ? substituteVariables(template, variableMap)
         : `הודעת בדיקה עבור אירוע: ${event.name}`

       // Send via send-whatsapp function (fetch within Edge Function)
       const whatsappResponse = await fetch(
         `${Deno.env.get('SUPABASE_URL')}/functions/v1/send-whatsapp`,
         {
           method: 'POST',
           headers: {
             'Content-Type': 'application/json',
             'Authorization': `Bearer ${Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')}`
           },
           body: JSON.stringify({
             to: test_phone,
             message: message,
             organization_id: event.organization_id
           })
         }
       )

       // Log test message to messages table with is_test flag
       await supabase.from('messages').insert({
         event_id: event.id,
         participant_id: null,
         message_type: `reminder_${reminderType || 'activation'}`,
         subject: `test_reminder_${reminderType || 'activation'}`,
         content: message,
         recipient_phone: test_phone,
         status: whatsappResponse.ok ? 'sent' : 'failed',
         channel: 'whatsapp',
         metadata: { is_test: true }
       })

       return new Response(JSON.stringify({
         success: whatsappResponse.ok,
         message: whatsappResponse.ok ? 'Test message sent' : 'Failed to send test message'
       }), {
         headers: { ...corsHeaders, 'Content-Type': 'application/json' }
       })
     }

     // Existing production reminder logic continues below...
     const { type }: ReminderJob = body
     ```

     CRITICAL: The executor must read the CURRENT deployed send-reminder Edge Function from MCP (`get_edge_function`) before modifying. The scaffold version in the repo is outdated (v6). The actual deployed version is v7 with template functions. The executor MUST preserve ALL existing v7 code and only add the test mode handler at the top.

     CRITICAL: Use `message_type` column (NOT `type`) when inserting test message to messages table.

     CRITICAL: Deploy via MCP `deploy_edge_function` with project_id `byhohetafnhlakqbydbj` and verify_jwt: true.
  </action>
  <verify>
  - EventSettingsPanel renders TestReminderButton section
  - Edge Function deployed with test mode handler
  - TypeScript compiles: `cd eventflow-app && npx tsc --noEmit 2>&1 | head -20`
  </verify>
  <done>TestReminderButton appears in EventSettingsPanel. Edge Function handles mode:'test' requests by sending a single test message to specified phone.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
  Complete Manager Controls UI:
  1. Settings tab on EventDetailPage with 8 reminder toggles
  2. Activation message preview (WhatsApp-style bubble)
  3. Test reminder button that sends real WhatsApp message to manager's phone
  </what-built>
  <how-to-verify>
  1. Open http://localhost:5173 and navigate to any event detail page
  2. Verify "הגדרות תזכורות" tab appears in the tab bar
  3. Click the settings tab — see 8 checkboxes with correct labels
  4. Toggle a follow-up reminder → click save → refresh page → verify toggle persists
  5. Scroll down to see activation message preview (green WhatsApp bubble with event data)
  6. Scroll to test reminder section → enter your phone number → click "שלח הודעת בדיקה"
  7. Verify you receive WhatsApp message on your phone
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. Settings tab renders with 8 toggles on EventDetailPage
2. Follow-up toggles are in separate section with border
3. Save persists settings to events.settings JSONB
4. MessagePreview shows WhatsApp bubble with real event data
5. Test reminder button sends message to entered phone number
6. Test message logged in messages table with metadata.is_test = true
7. Edge Function handles both test mode and production mode correctly
</verification>

<success_criteria>
- TestReminderButton renders in EventSettingsPanel with phone input and send button
- useTestReminder hook calls send-reminder Edge Function with mode:'test'
- Edge Function test mode sends single WhatsApp message via send-whatsapp
- Test message has is_test metadata flag
- Loading/success/error states work correctly
- Manual test: manager receives WhatsApp message on entered phone
</success_criteria>

<output>
After completion, create `.planning/phases/04-manager-controls/04-02-SUMMARY.md`
</output>
