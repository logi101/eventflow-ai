---
phase: 05-reliability
plan: 01
title: Database safety net - unique constraint + retry columns
wave: 1
depends_on: []
files_modified:
  - migration (Supabase)
autonomous: true
---

# 05-01: Database Safety Net

## Objective

Add database-level protections for deduplication and error tracking. This covers REL-01 (unique constraint) and partial REL-02 (retry columns).

## Tasks

<task id="1">
Apply Supabase migration to add unique constraint on messages table.

The constraint must handle NULLable participant_id (some messages may not have a participant).

Use a partial unique index instead of a regular UNIQUE constraint:

```sql
CREATE UNIQUE INDEX IF NOT EXISTS idx_messages_dedup
ON messages (event_id, participant_id, message_type)
WHERE participant_id IS NOT NULL AND event_id IS NOT NULL;
```

This prevents duplicate reminders for the same participant+event+type combination.
</task>

<task id="2">
Add retry_count and last_retry_at columns to messages table via migration:

```sql
ALTER TABLE messages
ADD COLUMN IF NOT EXISTS retry_count INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS last_retry_at TIMESTAMPTZ;
```
</task>

<task id="3">
Verify the migration applied successfully by querying the messages table structure.

Check:
- Unique index exists
- retry_count column exists with default 0
- last_retry_at column exists
</task>

## Verification

- [ ] `idx_messages_dedup` index exists on messages table
- [ ] `retry_count` column exists with DEFAULT 0
- [ ] `last_retry_at` column exists
- [ ] Existing 405 messages are unaffected (no duplicates should exist)
- [ ] Attempting to insert a duplicate (same event_id, participant_id, message_type) fails

## must_haves
- Database-level dedup constraint prevents duplicate reminders
- retry_count and last_retry_at columns exist for error tracking
