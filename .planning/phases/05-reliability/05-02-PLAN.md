---
phase: 05-reliability
plan: 02
title: Rate limit handling + basic retry in send-reminder
wave: 2
depends_on: [05-01]
files_modified:
  - eventflow-scaffold/functions/send-reminder.ts
autonomous: true
---

# 05-02: Rate Limit Handling + Basic Retry

## Objective

Update send-reminder Edge Function to handle rate limiting gracefully and add basic retry for transient failures. Covers REL-03 (retry) and REL-04 (rate limit respect).

## Tasks

<task id="1">
Read the current send-reminder.ts (deployed v13, synced locally at eventflow-scaffold/functions/send-reminder.ts).

Identify:
- The sendWhatsApp helper function (bottom of file)
- All 8 handler sections that call sendWhatsApp
- The error handling pattern after sendWhatsApp returns
</task>

<task id="2">
Update the `sendWhatsApp` helper function to:

1. **Add a delay between calls** — sleep 2100ms after each send (ensures <=28 msgs/min, safely under 30/min limit)
2. **Retry once on transient failure** — if first attempt fails with network/rate-limit error, wait 3s and retry
3. **Update retry_count** — increment retry_count in messages table on retry
4. **Classify errors** — network timeout or 429 = transient (retry), everything else = permanent (don't retry)

Implementation approach for the sendWhatsApp helper:

```typescript
async function sendWhatsApp(
  supabase: any,
  organizationId: string,
  phone: string,
  message: string,
  messageId?: string
): Promise<{ success: boolean; error?: string }> {
  // Throttle: 2.1s between sends → max ~28/min per org
  await new Promise(r => setTimeout(r, 2100))

  const doSend = async () => {
    try {
      const response = await fetch(...)
      return await response.json()
    } catch (error) {
      return { success: false, error: error.message, transient: true }
    }
  }

  let result = await doSend()

  // One retry for transient failures
  if (!result.success && (result.transient || result.error?.includes('rate') || result.error?.includes('timeout'))) {
    await new Promise(r => setTimeout(r, 3000))

    if (messageId) {
      await supabase.from('messages').update({
        retry_count: 1,
        last_retry_at: new Date().toISOString()
      }).eq('id', messageId)
    }

    result = await doSend()
  }

  return result
}
```

Keep the change MINIMAL — only modify the sendWhatsApp helper, not the 8 handler sections.
</task>

<task id="3">
Deploy the updated send-reminder function to Supabase using mcp__supabase__deploy_edge_function.

Read the full updated file and deploy as the new version.
</task>

<task id="4">
Verify deployment:
- Function status is ACTIVE
- Test mode still works (body.mode === 'test')
- Check function includes throttle delay and retry logic
</task>

## Verification

- [ ] sendWhatsApp includes 2.1s throttle between sends
- [ ] sendWhatsApp retries once on transient failure with 3s delay
- [ ] retry_count updated in messages table on retry
- [ ] Deployed to Supabase successfully
- [ ] Test mode still functional
- [ ] All 8 handlers unmodified (only sendWhatsApp helper changed)

## must_haves
- Rate limiting respected: max ~28 msgs/min per function invocation
- Transient failures get one retry with backoff
- retry_count tracked in database
- Existing handler logic untouched
