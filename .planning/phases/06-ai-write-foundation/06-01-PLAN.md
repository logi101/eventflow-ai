---
phase: 06-ai-write-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - eventflow-scaffold/migrations/006_ai_write_foundation.sql
autonomous: true

must_haves:
  truths:
    - "ai_insights_log table exists with correct columns and RLS policies"
    - "PostgreSQL exclusion constraint prevents room double-booking on schedules table"
    - "check_speaker_conflicts function returns overlapping schedules for same speaker"
    - "All new database objects respect multi-tenant isolation via RLS"
  artifacts:
    - path: "eventflow-scaffold/migrations/006_ai_write_foundation.sql"
      provides: "Complete SQL migration for Phase 6 database layer"
      contains: "ai_insights_log, btree_gist, no_room_overlap, check_speaker_conflicts"
  key_links:
    - from: "ai_insights_log"
      to: "user_profiles"
      via: "user_id REFERENCES user_profiles(id)"
      pattern: "user_id UUID.*REFERENCES user_profiles"
    - from: "ai_insights_log"
      to: "events"
      via: "event_id REFERENCES events(id)"
      pattern: "event_id UUID.*REFERENCES events"
    - from: "schedules exclusion constraint"
      to: "btree_gist extension"
      via: "EXCLUDE USING GIST"
      pattern: "EXCLUDE USING GIST"
---

<objective>
Create the database foundation for AI write operations: audit logging table, schedule conflict detection constraints, and speaker overlap detection.

Purpose: All subsequent plans depend on this database layer. The ai_insights_log table stores the full lifecycle of AI suggestions (suggested -> approved/rejected -> executed/failed). The exclusion constraint provides atomic room double-booking prevention. The speaker conflict function provides application-level overlap detection.

Output: A single SQL migration file that can be run in Supabase SQL Editor.
</objective>

<execution_context>
@/Users/eliyawolfman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eliyawolfman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@eventflow-scaffold/schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Phase 6 database migration</name>
  <files>eventflow-scaffold/migrations/006_ai_write_foundation.sql</files>
  <action>
Create a comprehensive SQL migration file with the following sections:

1. **btree_gist extension** - `CREATE EXTENSION IF NOT EXISTS btree_gist;`

2. **ai_insights_log table** with these columns:
   - id UUID PRIMARY KEY DEFAULT uuid_generate_v4()
   - user_id UUID NOT NULL REFERENCES user_profiles(id)
   - event_id UUID REFERENCES events(id)
   - action_type TEXT NOT NULL (e.g. 'schedule_create', 'schedule_update', 'schedule_delete')
   - action_data JSONB NOT NULL (full details of suggested/executed action including current_state, proposed_state, conflicts_detected, vip_affected)
   - suggested_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
   - approved_at TIMESTAMPTZ
   - approved_by UUID REFERENCES user_profiles(id)
   - executed_at TIMESTAMPTZ
   - execution_status TEXT NOT NULL DEFAULT 'suggested' CHECK (execution_status IN ('suggested', 'approved', 'rejected', 'executed', 'failed'))
   - execution_error TEXT
   - created_at TIMESTAMPTZ DEFAULT NOW()

3. **RLS on ai_insights_log**:
   - Enable RLS
   - SELECT policy: Users can view audit logs for events in their organization (join through events -> organization_id = auth.user_org_id())
   - INSERT policy: Users can insert audit logs for events in their organization
   - UPDATE policy: Users can update audit logs they created (user_id = auth.uid()) or logs for events in their organization

4. **Indexes on ai_insights_log**:
   - idx_ai_insights_log_event_id ON ai_insights_log(event_id)
   - idx_ai_insights_log_user_id ON ai_insights_log(user_id)
   - idx_ai_insights_log_status ON ai_insights_log(execution_status)
   - idx_ai_insights_log_created_at ON ai_insights_log(created_at DESC)

5. **Schedule conflict exclusion constraint**:
   ```sql
   ALTER TABLE schedules ADD CONSTRAINT no_room_overlap
     EXCLUDE USING GIST (
       event_id WITH =,
       room WITH =,
       tstzrange(start_time, end_time) WITH &&
     )
     WHERE (room IS NOT NULL);
   ```

6. **Speaker overlap index** (for application-level conflict detection):
   ```sql
   CREATE INDEX idx_schedules_speaker_time ON schedules (
     event_id, speaker_name, start_time, end_time
   ) WHERE speaker_name IS NOT NULL;
   ```

7. **check_speaker_conflicts function**:
   ```sql
   CREATE OR REPLACE FUNCTION check_speaker_conflicts(
     p_event_id UUID,
     p_speaker_name TEXT,
     p_start_time TIMESTAMPTZ,
     p_end_time TIMESTAMPTZ,
     p_exclude_schedule_id UUID DEFAULT NULL
   )
   RETURNS TABLE (
     conflict_id UUID,
     conflict_title TEXT,
     conflict_start TIMESTAMPTZ,
     conflict_end TIMESTAMPTZ
   ) AS $$
   BEGIN
     RETURN QUERY
     SELECT s.id, s.title, s.start_time, s.end_time
     FROM schedules s
     WHERE s.event_id = p_event_id
       AND s.speaker_name ILIKE p_speaker_name
       AND s.id IS DISTINCT FROM p_exclude_schedule_id
       AND s.start_time < p_end_time
       AND s.end_time > p_start_time;
   END;
   $$ LANGUAGE plpgsql STABLE;
   ```

IMPORTANT: Wrap all operations that might fail (like ADD CONSTRAINT if already exists) with appropriate guards. Use `DO $$ BEGIN ... EXCEPTION WHEN ... END $$` blocks for idempotent constraint creation. Comment each section clearly in Hebrew and English.

Do NOT modify any existing tables, columns, or constraints. Only ADD new objects. The schedules table columns (event_id, room, start_time, end_time, speaker_name) already exist per schema.sql.
  </action>
  <verify>
Review the migration file for:
1. All SQL statements are syntactically valid
2. ai_insights_log table has all required columns with correct types
3. RLS policies correctly reference auth.user_org_id() and auth.uid()
4. Exclusion constraint uses correct GIST syntax
5. check_speaker_conflicts function has correct parameter types and return type
6. All operations are idempotent (safe to run multiple times)
  </verify>
  <done>
Migration file exists at eventflow-scaffold/migrations/006_ai_write_foundation.sql with:
- ai_insights_log table with RLS and indexes
- btree_gist extension enabled
- no_room_overlap exclusion constraint on schedules
- check_speaker_conflicts function
- Speaker time index on schedules
  </done>
</task>

</tasks>

<verification>
1. Migration file exists and is valid SQL
2. ai_insights_log table has all columns from research spec
3. RLS policies enforce multi-tenant isolation (organization_id check)
4. Exclusion constraint prevents overlapping time ranges for same event+room
5. Speaker conflict function returns correct overlapping schedules
6. No existing v1.0 database objects are modified or removed
</verification>

<success_criteria>
The migration file can be run in Supabase SQL Editor to create all Phase 6 database objects. All objects support the suggest -> confirm -> execute workflow with audit trail and conflict detection. Existing v1.0 functionality (reminders, templates, cron jobs) is completely unaffected.
</success_criteria>

<output>
After completion, create `.planning/phases/06-ai-write-foundation/06-01-SUMMARY.md`
</output>
