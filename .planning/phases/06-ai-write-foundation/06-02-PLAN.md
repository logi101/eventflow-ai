---
phase: 06-ai-write-foundation
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - eventflow-scaffold/supabase/functions/ai-chat/index.ts
autonomous: true

must_haves:
  truths:
    - "AI chat responds to schedule management requests by returning pending_approval actions"
    - "AI detects room double-booking and speaker overlap before suggesting schedule changes"
    - "AI mentions VIP status when schedule changes affect VIP participants"
    - "Existing 7 tools (search_events, search_vendors, get_event_details, suggest_schedule, create_event_draft, add_checklist_items, assign_vendors) continue working unchanged"
    - "AI maintains correct event context (event_id) throughout conversation"
  artifacts:
    - path: "eventflow-scaffold/supabase/functions/ai-chat/index.ts"
      provides: "Extended AI chat Edge Function with schedule management tools and VIP awareness"
      contains: "create_schedule_item, update_schedule_item, delete_schedule_item, pending_approval, detectScheduleConflicts, VIP"
  key_links:
    - from: "ai-chat/index.ts new tools"
      to: "ai_insights_log table"
      via: "INSERT into ai_insights_log for audit trail"
      pattern: "ai_insights_log.*insert"
    - from: "ai-chat/index.ts conflict detection"
      to: "schedules table"
      via: "Query for overlapping room/speaker schedules"
      pattern: "schedules.*room.*start_time"
    - from: "ai-chat/index.ts"
      to: "participants table"
      via: "Query is_vip flag for affected participants"
      pattern: "participants.*is_vip"
---

<objective>
Extend the existing ai-chat Edge Function with schedule management tools (create, update, delete) that return pending_approval actions instead of executing writes directly. Add conflict detection and VIP awareness to the suggestion flow.

Purpose: This is the AI "suggestion" phase of the suggest -> confirm -> execute pattern. Gemini calls new tools to propose schedule changes, the Edge Function detects conflicts, logs the suggestion to ai_insights_log, and returns structured pending_approval actions for the frontend to present.

Output: Updated ai-chat Edge Function with 10 tools (7 existing + 3 new schedule tools) and VIP-enhanced system prompt.
</objective>

<execution_context>
@/Users/eliyawolfman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eliyawolfman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ai-write-foundation/06-RESEARCH.md
@.planning/phases/06-ai-write-foundation/06-01-SUMMARY.md
@eventflow-scaffold/supabase/functions/ai-chat/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add schedule management tool declarations and conflict detection</name>
  <files>eventflow-scaffold/supabase/functions/ai-chat/index.ts</files>
  <action>
EXTEND (do not rewrite) the existing ai-chat Edge Function. Add the following IN ADDITION to all existing code:

**1. Add 3 new tool declarations to TOOL_DECLARATIONS array:**

- `create_schedule_item`: Parameters: event_id (STRING, required), title (STRING, required), start_time (STRING ISO, required), end_time (STRING ISO, required), room (STRING), speaker_name (STRING), max_capacity (INTEGER), description (STRING), is_mandatory (BOOLEAN). Description in Hebrew: "יצירת פריט חדש בלוח הזמנים (הרצאה, סדנה, הפסקה). מחזיר הצעה הדורשת אישור מנהל."

- `update_schedule_item`: Parameters: schedule_id (STRING, required), changes (OBJECT with optional: title, start_time, end_time, room, speaker_name, max_capacity, description). Description: "עדכון פריט קיים בלוח הזמנים. מחזיר הצעה עם שינויים וקונפליקטים הדורשת אישור."

- `delete_schedule_item`: Parameters: schedule_id (STRING, required), reason (STRING). Description: "מחיקת פריט מלוח הזמנים. מחזיר הצעה הדורשת אישור."

**2. Add detectScheduleConflicts function** (before executeTool):

```typescript
interface ScheduleConflict {
  type: 'room_overlap' | 'speaker_overlap' | 'capacity_overflow'
  severity: 'error' | 'warning'
  message: string
  conflicting_item?: {
    id: string
    title: string
    start_time: string
    end_time: string
  }
}

async function detectScheduleConflicts(
  supabase: SupabaseClient,
  proposed: {
    event_id: string
    start_time: string
    end_time: string
    room?: string
    speaker_name?: string
    max_capacity?: number
    exclude_schedule_id?: string
  }
): Promise<ScheduleConflict[]>
```

Check for:
- Room overlap: Query schedules table for same event_id + room where time ranges overlap. Use `.lt('start_time', proposed.end_time).gt('end_time', proposed.start_time)` for overlap logic. If exclude_schedule_id provided, filter it out with `.neq('id', exclude_schedule_id)`. Severity: 'error'.
- Speaker overlap: Same pattern but match on speaker_name (case-insensitive via .ilike). Severity: 'error'.
- Capacity: If max_capacity provided and updating an existing schedule, check participant_schedules count vs capacity. Severity: 'warning'.

**3. Add 3 tool execution functions:**

Each function:
a. Validates input arguments
b. For update/delete: fetches current schedule item to verify it exists and get current state
c. Calls detectScheduleConflicts with proposed state
d. Checks for VIP impact: query participant_schedules -> participants(is_vip, full_name) for affected schedule items
e. Logs suggestion to ai_insights_log via INSERT with execution_status='suggested'
f. Returns ToolResult with `data.status = 'pending_approval'` containing:
   - action_id (from ai_insights_log insert)
   - type ('schedule_create' | 'schedule_update' | 'schedule_delete')
   - status: 'pending_approval'
   - data: { relevant fields, current_state for updates }
   - conflicts: ScheduleConflict[]
   - impact: { affected_participants, vip_count, requires_notifications }
   - label: Hebrew description of action
   - vip_warning: Hebrew message if VIPs affected (or undefined)

IMPORTANT: These functions do NOT execute the actual write. They only detect conflicts, log the suggestion, and return a preview.

**4. Register new tools in executeTool switch statement:**
Add cases for 'create_schedule_item', 'update_schedule_item', 'delete_schedule_item' calling their respective execution functions.

**5. Add extractActions cases for new tools:**
In the extractActions function, add cases for the 3 new tools. When tool result has `data.status === 'pending_approval'`, create ActionItem with status: 'pending_approval' and include the full action data (action_id, conflicts, impact, label, vip_warning).

**6. Enhance system prompt for VIP handling (AIAG-04 event context + VIP-03):**
Append to SYSTEM_PROMPT:

```
## טיפול במשתתפי VIP
כאשר משתמש מזכיר משתתף או כששינוי בלוח זמנים משפיע על משתתפים:
1. בדוק אם יש משתתפי VIP מושפעים
2. אם כן, ציין זאת במפורש בתשובה
3. הצע פתרונות מיוחדים או התאמות אישיות ל-VIP
4. התריע אם יש קונפליקט שמשפיע על VIP

## ניהול לוח זמנים
כשמשתמש מבקש לשנות לוח זמנים (להוסיף, לעדכן, למחוק פעילות):
1. השתמש בכלים create_schedule_item, update_schedule_item, delete_schedule_item
2. הכלים יחזירו הצעה שדורשת אישור - הסבר למשתמש מה ההצעה כוללת
3. אם יש קונפליקטים, הסבר אותם בבירור
4. המתן לאישור המשתמש לפני ביצוע
```

**Critical constraints:**
- Do NOT modify any existing tool declarations or execution functions
- Do NOT change the existing system prompt (only append to it)
- Do NOT change the main serve() handler structure
- Do NOT change callGemini() or the tool call loop
- The 7 existing tools must continue to work exactly as before
- Use the same SupabaseClient (service_role_key) already created in serve() handler for reads and audit inserts
  </action>
  <verify>
1. All 7 existing tools still present and unchanged in TOOL_DECLARATIONS
2. 3 new tool declarations added with correct parameter types
3. detectScheduleConflicts function handles room, speaker, and capacity checks
4. New tool execution functions return pending_approval status (never execute writes)
5. extractActions handles new tool types
6. System prompt has VIP and schedule management sections appended
7. TypeScript compiles without errors (no type mismatches)
  </verify>
  <done>
ai-chat Edge Function has 10 tools (7 existing + 3 new). Schedule management requests return pending_approval actions with conflict detection and VIP impact assessment. Suggestions are logged to ai_insights_log. Existing tools are completely unchanged.
  </done>
</task>

</tasks>

<verification>
1. Existing 7 tools work identically to before
2. "Add workshop at 2pm in Room A" triggers create_schedule_item tool
3. Tool returns pending_approval action with room conflict detection
4. VIP participants flagged in action response when affected
5. ai_insights_log receives INSERT with execution_status='suggested'
6. No schedule writes are executed by ai-chat (suggestion only)
</verification>

<success_criteria>
The ai-chat Edge Function can be deployed as an update to the existing function. When a manager asks to create/update/delete a schedule item, Gemini calls the appropriate tool, the function detects conflicts, checks VIP impact, logs the suggestion, and returns a structured pending_approval action for the frontend. All existing functionality (event search, vendor search, event creation, checklist, vendor assignment) continues working without any changes.
</success_criteria>

<output>
After completion, create `.planning/phases/06-ai-write-foundation/06-02-SUMMARY.md`
</output>
