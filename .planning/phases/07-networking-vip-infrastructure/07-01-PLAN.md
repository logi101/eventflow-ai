---
phase: 07-networking-vip-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - eventflow-scaffold/migrations/007_networking_vip_foundation.sql
autonomous: true

must_haves:
  truths:
    - "participants table has networking_opt_in column with configurable default per event"
    - "table_assignments table stores seating plan with event_id, participant_id, table_number"
    - "track_statistics view shows participant count, VIP count, and percentage per track"
  artifacts:
    - path: "eventflow-scaffold/migrations/007_networking_vip_foundation.sql"
      provides: "Database foundation for networking and table seating"
      contains: "CREATE TABLE table_assignments"
  key_links:
    - from: "table_assignments"
      to: "participants"
      via: "participant_id foreign key"
      pattern: "REFERENCES participants"
---

<objective>
Create database foundation for networking engine and table seating system

Purpose: Enable track assignment, table seating, and room assignment features by establishing required database schema
Output: SQL migration with networking_opt_in column, table_assignments table, track_statistics view, and RLS policies
</objective>

<execution_context>
@/Users/eliyawolfman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eliyawolfman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-networking-vip-infrastructure/07-RESEARCH.md
@eventflow-app/supabase/migrations/20260120_program_management.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Phase 7 database migration</name>
  <files>eventflow-scaffold/migrations/007_networking_vip_foundation.sql</files>
  <action>
Create idempotent SQL migration with:

1. **Add networking_opt_in to participants:**
   ```sql
   ALTER TABLE participants
   ADD COLUMN IF NOT EXISTS networking_opt_in BOOLEAN DEFAULT FALSE;
   ```
   - Default false (opt-in behavior as per CONTEXT.md decision)
   - Event-level default stored in events.settings JSONB: `default_networking_opt_in`

2. **Create table_assignments table:**
   ```sql
   CREATE TABLE IF NOT EXISTS table_assignments (
     id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
     event_id UUID NOT NULL REFERENCES events(id) ON DELETE CASCADE,
     participant_id UUID NOT NULL REFERENCES participants(id) ON DELETE CASCADE,
     table_number INTEGER NOT NULL,
     seat_number INTEGER, -- Optional: specific seat at table
     is_vip_table BOOLEAN DEFAULT FALSE,
     assigned_by TEXT DEFAULT 'ai', -- 'ai' | 'manager' | 'auto'
     assigned_at TIMESTAMPTZ DEFAULT NOW(),
     notes TEXT,
     created_at TIMESTAMPTZ DEFAULT NOW(),
     updated_at TIMESTAMPTZ DEFAULT NOW(),
     UNIQUE(event_id, participant_id)
   );
   ```

3. **Create indexes for table_assignments:**
   - idx_table_assignments_event ON table_assignments(event_id)
   - idx_table_assignments_table ON table_assignments(event_id, table_number)

4. **Create RLS policies for table_assignments:**
   - Enable RLS on table_assignments
   - SELECT policy: Users can view table assignments for events in their organization
   - ALL policy: Users can manage table assignments for their events

5. **Create track_statistics view:**
   ```sql
   CREATE OR REPLACE VIEW track_statistics AS
   SELECT
     t.id AS track_id,
     t.event_id,
     t.name AS track_name,
     t.color,
     COUNT(pt.participant_id) AS participant_count,
     COUNT(pt.participant_id) FILTER (WHERE p.is_vip) AS vip_count,
     COUNT(pt.participant_id) FILTER (WHERE pt.is_primary) AS primary_count,
     ROUND(COUNT(pt.participant_id)::numeric / NULLIF(
       (SELECT COUNT(*) FROM participant_tracks WHERE track_id IN (SELECT id FROM tracks WHERE event_id = t.event_id)),
       0
     ) * 100, 1) AS percentage
   FROM tracks t
   LEFT JOIN participant_tracks pt ON t.id = pt.track_id
   LEFT JOIN participants p ON pt.participant_id = p.id
   GROUP BY t.id, t.event_id, t.name, t.color;
   ```

6. **Add update trigger for table_assignments:**
   - Create trigger to auto-update updated_at timestamp

7. **Add validation queries:**
   - Verify networking_opt_in column exists
   - Verify table_assignments table created
   - Verify track_statistics view works

Include Hebrew comments for documentation. Make all operations idempotent (safe to run multiple times).
  </action>
  <verify>
Run validation queries at end of migration:
- SELECT column_name FROM information_schema.columns WHERE table_name = 'participants' AND column_name = 'networking_opt_in';
- SELECT COUNT(*) FROM table_assignments; -- Should return 0, no error
- SELECT * FROM track_statistics LIMIT 1; -- Should work without error
  </verify>
  <done>Migration file exists with all schema changes; validation queries pass when run in Supabase SQL editor</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Migration file exists at eventflow-scaffold/migrations/007_networking_vip_foundation.sql
2. File contains all required CREATE/ALTER statements
3. All operations are idempotent (IF NOT EXISTS, CREATE OR REPLACE)
4. RLS policies follow existing patterns from 006_ai_write_foundation.sql
5. Validation queries included at end of file
</verification>

<success_criteria>
- networking_opt_in column added to participants (default false)
- table_assignments table created with proper foreign keys and constraints
- track_statistics view provides participant distribution per track
- RLS policies enforce organization isolation
- Migration is idempotent and safe to run multiple times
</success_criteria>

<output>
After completion, create `.planning/phases/07-networking-vip-infrastructure/07-01-SUMMARY.md`
</output>
