---
phase: 07-networking-vip-infrastructure
plan: 04
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - eventflow-app/src/modules/networking/services/seatingAlgorithm.ts
  - eventflow-app/src/modules/networking/services/seatingService.ts
  - eventflow-app/src/modules/networking/types.ts
  - eventflow-app/src/components/networking/SeatingPlanView.tsx
  - eventflow-app/src/components/networking/TableCard.tsx
  - eventflow-app/src/components/networking/DraggableParticipant.tsx
autonomous: true

must_haves:
  truths:
    - "Seating algorithm places participants with shared interests together at tables"
    - "VIP participants are spread across tables with priority placement"
    - "Companions who came together sit together at same table"
    - "Manager can view seating plan and drag participants between tables"
  artifacts:
    - path: "eventflow-app/src/modules/networking/services/seatingAlgorithm.ts"
      provides: "CSP-based seating optimization with greedy fallback"
      exports: ["generateTableSeating", "greedyTableSeating"]
    - path: "eventflow-app/src/components/networking/SeatingPlanView.tsx"
      provides: "Table seating visualization with drag-drop override"
      min_lines: 100
    - path: "eventflow-app/src/components/networking/TableCard.tsx"
      provides: "Single table card showing assigned participants"
      min_lines: 40
  key_links:
    - from: "SeatingPlanView.tsx"
      to: "table_assignments"
      via: "seatingService update"
      pattern: "table_assignments"
    - from: "seatingAlgorithm.ts"
      to: "participant_tracks"
      via: "shared interest calculation"
      pattern: "tracks"
---

<objective>
Implement seating algorithm and seating plan UI with manual override capability

Purpose: Generate intelligent table seating based on shared interests, diversity, VIP priority, and companion grouping, with manager override
Output: CSP-based seating algorithm, seating service for CRUD, and drag-drop seating plan visualization
</objective>

<execution_context>
@/Users/eliyawolfman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eliyawolfman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-networking-vip-infrastructure/07-CONTEXT.md
@.planning/phases/07-networking-vip-infrastructure/07-RESEARCH.md
@.planning/phases/07-networking-vip-infrastructure/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create seating types and service</name>
  <files>eventflow-app/src/modules/networking/types.ts, eventflow-app/src/modules/networking/services/seatingService.ts</files>
  <action>
1. **Create networking types.ts:**
   ```typescript
   export interface SeatingConstraints {
     maxTableSize: number
     variableTableSizes?: Map<number, number> // table_number -> capacity
     minSharedInterests: number // Min participants with shared track per table
     maxSameTrack: number // Max from same track per table (diversity)
     companionsTogether: boolean
     vipSpread: boolean // Spread VIPs across tables
     vipPriorityTables?: number[] // VIP-designated tables
   }

   export interface TableAssignment {
     id: string
     event_id: string
     participant_id: string
     table_number: number
     seat_number?: number
     is_vip_table: boolean
     assigned_by: 'ai' | 'manager' | 'auto'
     assigned_at: string
     notes?: string
   }

   export interface SeatingParticipant {
     id: string
     first_name: string
     last_name: string
     tracks: string[] // Track IDs
     is_vip: boolean
     companion_id?: string
     networking_opt_in: boolean
   }

   export interface TableWithParticipants {
     tableNumber: number
     capacity: number
     isVipTable: boolean
     participants: SeatingParticipant[]
   }
   ```

2. **Create seatingService.ts:**
   - fetchTableAssignments(eventId): Get all assignments for event
   - saveTableAssignment(assignment): Upsert single assignment
   - saveAllTableAssignments(eventId, assignments): Bulk save (delete existing first)
   - updateParticipantTable(eventId, participantId, newTableNumber): Move participant
   - Uses Supabase client, invalidates React Query cache
  </action>
  <verify>
- TypeScript compiles without errors
- Types match table_assignments schema from 07-01
- Service methods use correct Supabase operations
  </verify>
  <done>Seating types and service layer ready for algorithm and UI</done>
</task>

<task type="auto">
  <name>Task 2: Create seating algorithm</name>
  <files>eventflow-app/src/modules/networking/services/seatingAlgorithm.ts</files>
  <action>
Implement seating algorithm following 07-RESEARCH.md patterns:

1. **Main function generateTableSeating:**
   - Input: participants (SeatingParticipant[]), constraints (SeatingConstraints)
   - Output: Map<number, SeatingParticipant[]> (table_number -> participants)
   - Filter to only networking_opt_in participants
   - Calculate number of tables needed based on participant count and max capacity

2. **Greedy algorithm (primary - fast and reliable):**
   - Sort participants: VIPs first, then by track count (more tracks = more connection potential)
   - For each participant, find best table:
     a. Check table not full
     b. Score based on shared tracks with existing table members
     c. Check companion constraint (if companion already assigned, must join same table)
     d. Check VIP spread (max 2 VIPs per table if vipSpread enabled)
     e. Check diversity (maxSameTrack per table)
   - If no good match, create new table

3. **Companion grouping (hard constraint):**
   - When processing participant with companion_id, check if companion already assigned
   - If yes, force same table (or error if table full)
   - Process companions together as a unit

4. **VIP handling:**
   - VIPs processed first (sorted to top)
   - vipPriorityTables: VIPs prefer these table numbers when available
   - vipSpread: Max 2 VIPs per table to distribute networking opportunities

5. **Return format:**
   - Map keyed by table number (1-based)
   - Each entry is array of participants at that table
   - Include unassigned count if not all fit

Note: Skip CSP library for v1 - greedy algorithm is sufficient for typical event sizes (<500 participants). Add CSP optimization later if needed.
  </action>
  <verify>
- TypeScript compiles without errors
- Algorithm handles edge cases (empty input, all VIPs, companions without match)
- VIPs spread across tables
- Companions kept together
  </verify>
  <done>Seating algorithm generates table assignments respecting all constraints</done>
</task>

<task type="auto">
  <name>Task 3: Create seating plan UI components</name>
  <files>eventflow-app/src/components/networking/SeatingPlanView.tsx, eventflow-app/src/components/networking/TableCard.tsx, eventflow-app/src/components/networking/DraggableParticipant.tsx</files>
  <action>
Install dnd-kit if not present: `npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities`

1. **Create DraggableParticipant.tsx:**
   - Uses useDraggable from @dnd-kit/core
   - Shows participant name with VIPBadge if is_vip
   - Shows track color indicators (small dots)
   - Cursor changes to grab/grabbing based on drag state
   - Disabled prop for non-edit mode

2. **Create TableCard.tsx:**
   - Uses useDroppable from @dnd-kit/core
   - Shows table number and capacity (e.g., "שולחן 5 - 6/8")
   - VIP count indicator if table has VIPs
   - Lists participants as DraggableParticipant
   - Visual highlight when being dragged over

3. **Create SeatingPlanView.tsx:**
   - Main container with DndContext from @dnd-kit/core
   - Header with "יצירת שיבוץ חכם" button and "עריכה ידנית" toggle
   - Grid layout of TableCard components (3 columns on desktop)
   - handleDragEnd: Update participant's table via seatingService
   - "Generate" button calls seatingAlgorithm then saves via seatingService
   - Edit mode toggle enables/disables drag functionality
   - RTL layout, Hebrew labels

All components must:
- Follow EventFlow design system (Tailwind classes)
- Be RTL-first
- Use VIPBadge from 07-02 for VIP indicators
- Handle loading and error states
  </action>
  <verify>
- All components render without errors
- Drag and drop works between tables
- Algorithm generation populates table grid
- VIP badges display correctly
  </verify>
  <done>Seating plan UI shows table assignments with drag-drop manual override capability</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. seatingAlgorithm.ts generates valid table assignments
2. Companions are kept together at same table
3. VIPs are spread across tables (max 2 per table)
4. Shared interests are considered in placement
5. Manager can drag participants between tables
6. Changes persist to database via seatingService
</verification>

<success_criteria>
- Seating algorithm assigns participants based on shared interests + diversity (NETW-03)
- Table assignments stored in table_assignments table (NETW-04)
- Manager can view and manually override AI seating plan (NETW-05)
- VIP participants get priority seating spread across tables (NETW-06)
- Companions grouped together (CONTEXT.md decision)
</success_criteria>

<output>
After completion, create `.planning/phases/07-networking-vip-infrastructure/07-04-SUMMARY.md`
</output>
