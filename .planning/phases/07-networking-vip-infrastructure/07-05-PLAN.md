---
phase: 07-networking-vip-infrastructure
plan: 05
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - eventflow-app/supabase/functions/ai-chat/index.ts
  - eventflow-app/src/components/rooms/RoomGridView.tsx
  - eventflow-app/src/components/rooms/RoomListView.tsx
  - eventflow-app/src/components/rooms/RoomAssignmentPanel.tsx
autonomous: true

must_haves:
  truths:
    - "AI chat can suggest room assignments based on VIP status, accessibility, and bed preferences"
    - "Manager sees room availability preview before approving AI suggestion"
    - "Room panel supports both grid and list view toggle"
  artifacts:
    - path: "eventflow-app/supabase/functions/ai-chat/index.ts"
      provides: "Extended AI chat with room assignment tool"
      contains: "suggest_room_assignments"
    - path: "eventflow-app/src/components/rooms/RoomGridView.tsx"
      provides: "Floor plan grid visualization of rooms"
      min_lines: 80
    - path: "eventflow-app/src/components/rooms/RoomAssignmentPanel.tsx"
      provides: "Enhanced room panel with grid/list toggle"
      contains: "viewMode"
  key_links:
    - from: "ai-chat/index.ts"
      to: "ai_insights_log"
      via: "pending_approval action"
      pattern: "ai_insights_log.*insert"
    - from: "RoomAssignmentPanel.tsx"
      to: "RoomGridView"
      via: "conditional render"
      pattern: "viewMode.*grid"
---

<objective>
Extend AI chat with room assignment suggestions and enhance room UI with grid/list views

Purpose: Enable AI-powered room assignment suggestions following Phase 6 suggest+confirm pattern, with improved room visualization
Output: AI room assignment tool, RoomGridView component, enhanced RoomAssignmentPanel with view toggle
</objective>

<execution_context>
@/Users/eliyawolfman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eliyawolfman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-networking-vip-infrastructure/07-CONTEXT.md
@.planning/phases/07-networking-vip-infrastructure/07-RESEARCH.md
@.planning/phases/06-ai-write-foundation/06-02-SUMMARY.md
@.planning/phases/06-ai-write-foundation/06-03-SUMMARY.md
@eventflow-app/src/components/rooms/RoomAssignmentPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add room assignment tool to AI chat</name>
  <files>eventflow-app/supabase/functions/ai-chat/index.ts</files>
  <action>
Extend ai-chat Edge Function with suggest_room_assignments tool following Phase 6 patterns:

1. **Add ROOM_ASSIGNMENT_TOOL definition:**
   ```typescript
   const ROOM_ASSIGNMENT_TOOL = {
     name: 'suggest_room_assignments',
     description: 'הצעת שיבוץ חדרים למשתתפים על בסיס סטטוס VIP, צרכי נגישות, והעדפות מיטה',
     parameters: {
       type: 'OBJECT',
       properties: {
         event_id: { type: 'STRING', description: 'מזהה האירוע' },
         criteria: {
           type: 'OBJECT',
           properties: {
             prioritize_vip: { type: 'BOOLEAN', description: 'תן עדיפות לחדרים טובים ל-VIP' },
             group_companions: { type: 'BOOLEAN', description: 'שבץ companions בחדרים סמוכים' },
             match_accessibility: { type: 'BOOLEAN', description: 'התאם חדרים נגישים לצרכים' }
           }
         }
       },
       required: ['event_id']
     }
   }
   ```

2. **Implement executeSuggestRoomAssignments:**
   - Fetch unassigned participants (no participant_rooms entry)
   - Fetch available rooms from rooms table
   - Sort participants: VIPs first, then accessibility needs, then rest
   - Sort rooms: Best rooms first (lower floor, better building)
   - Match participants to rooms based on criteria
   - Consider accessibility_features in rooms vs participant needs
   - Log suggestion to ai_insights_log with execution_status: 'suggested'
   - Return pending_approval response with suggestions array

3. **Response format (per Phase 6 pattern):**
   ```typescript
   return {
     success: true,
     data: {
       action_id: auditEntry.id,
       type: 'room_assignment_bulk',
       status: 'pending_approval',
       data: {
         suggestions: [
           { participant_id, participant_name, room_number, building, floor, reason }
         ],
         unassigned: remainingCount
       },
       label: `שיבוץ ${count} משתתפים לחדרים`,
       impact: { affected_participants, vip_count }
     }
   }
   ```

4. **Add tool to TOOLS array and route to executor**
  </action>
  <verify>
- Edge Function deploys without errors
- Tool appears in available tools list
- Suggestion returns pending_approval with action_id
- ai_insights_log entry created
  </verify>
  <done>AI chat can suggest room assignments with VIP priority and accessibility matching</done>
</task>

<task type="auto">
  <name>Task 2: Create RoomGridView and RoomListView components</name>
  <files>eventflow-app/src/components/rooms/RoomGridView.tsx, eventflow-app/src/components/rooms/RoomListView.tsx</files>
  <action>
1. **Create RoomGridView.tsx:**
   - Simple CSS grid layout (not React-Grid-Layout for v1 simplicity)
   - 10-column grid representing floors/sections
   - Room boxes showing:
     - Room number (bold)
     - Assigned participant name (if any)
     - VIP diamond if participant is VIP
     - Color coding: purple-100 for VIP, blue-100 for assigned, white for empty
   - Click handler for room selection
   - Props: rooms (Room[]), onRoomClick (room) => void

   Grid positioning:
   - Use room.floor for y position
   - Use room.name last digit(s) for x position
   - Fallback to simple row-based layout if floor not set

2. **Create RoomListView.tsx:**
   - Table/list view of rooms
   - Columns: Room #, Building, Floor, Status, Participant
   - Filter by: All, Assigned, Available
   - Sort by room number
   - VIPBadge for VIP participants
   - Click row to edit assignment
   - Props: rooms (Room[]), onRoomClick (room) => void

Both components:
- RTL layout
- Hebrew labels
- Loading skeleton state
- Empty state message
  </action>
  <verify>
- TypeScript compiles without errors
- Grid view displays rooms in grid layout
- List view shows all room details in table
- Both views handle click events
  </verify>
  <done>RoomGridView and RoomListView components provide two visualization options for room assignments</done>
</task>

<task type="auto">
  <name>Task 3: Enhance RoomAssignmentPanel with view toggle</name>
  <files>eventflow-app/src/components/rooms/RoomAssignmentPanel.tsx</files>
  <action>
Extend existing RoomAssignmentPanel to support grid/list view toggle:

1. **Add view mode state:**
   ```typescript
   const [viewMode, setViewMode] = useState<'grid' | 'list'>('list')
   ```

2. **Add view toggle buttons in header:**
   - Two buttons: "רשימה" (list) and "רשת" (grid)
   - Active state styling (bg-blue-100 or similar)
   - Place next to existing search/filter controls

3. **Conditional render based on viewMode:**
   - list: Keep existing participant-centric list (current implementation)
   - grid: Render RoomGridView component

4. **Add room availability summary:**
   - Show "X חדרים פנויים מתוך Y" in header stats
   - Count rooms without participant_rooms entry

5. **Integrate with AI suggestion flow (optional enhancement):**
   - If AI pending action exists for room assignment, show banner
   - Link to confirmation dialog

Preserve all existing functionality:
- Search by participant name/phone
- Filter by assigned/unassigned
- Edit individual assignments
- Stats display
  </action>
  <verify>
- Toggle between grid and list views works
- Existing list functionality preserved
- New grid view shows room layout
- Room availability count displays correctly
  </verify>
  <done>RoomAssignmentPanel supports both grid and list views with easy toggle</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. AI chat responds to room assignment requests with suggestions
2. Suggestions follow Phase 6 pending_approval pattern
3. Grid view shows visual room layout
4. List view shows detailed room table
5. View toggle preserves state and selection
6. VIP and accessibility priorities reflected in AI suggestions
</verification>

<success_criteria>
- AI suggests room assignments based on VIP status, bed preferences, accessibility needs (ROOM-01)
- Manager sees room availability and capacity before approving AI suggestion (ROOM-02)
- Room panel supports grid and list view toggle (CONTEXT.md decision)
- AI suggestions use Phase 6 suggest+confirm+execute pattern
</success_criteria>

<output>
After completion, create `.planning/phases/07-networking-vip-infrastructure/07-05-SUMMARY.md`
</output>
