---
phase: 07
plan: 06
type: gap_closure
wave: 3
depends_on: ["07-03", "07-04", "07-05"]
gap_closure: true
files_modified:
  - eventflow-app/src/pages/guests/GuestsPage.tsx
  - eventflow-app/src/pages/events/EventDetailPage.tsx
autonomous: true
must_haves:
  - truth: "GuestsPage renders checkboxes for participant selection"
    verify: "grep -q 'selectedParticipantIds' GuestsPage.tsx && grep -q 'checkbox' GuestsPage.tsx"
  - truth: "TrackAssignmentBulk component renders at bottom of GuestsPage when participants selected"
    verify: "grep -q 'TrackAssignmentBulk' GuestsPage.tsx && grep -q 'import.*TrackAssignmentBulk' GuestsPage.tsx"
  - truth: "EventDetailPage has a 'seating' tab option visible in tab list"
    verify: "grep -q \"id: 'seating'\" EventDetailPage.tsx"
  - truth: "SeatingPlanView component renders when seating tab is active"
    verify: "grep -q 'SeatingPlanView' EventDetailPage.tsx && grep -q 'import.*SeatingPlanView' EventDetailPage.tsx"
  - truth: "useVIPSorting hook used to sort participant list with VIPs first"
    verify: "grep -q 'useVIPSorting' GuestsPage.tsx"
---

# Phase 7, Plan 6: UI Integration Gap Closure

**Objective:** Wire existing orphaned components (TrackAssignmentBulk, SeatingPlanView, useVIPSorting) into their respective parent pages to complete Phase 7 functionality.

**Context:** Phase 7 verification found 2 critical gaps and 1 orphaned hook:
1. TrackAssignmentBulk (108 lines) - exists but not integrated into GuestsPage
2. SeatingPlanView (302 lines) - exists but not routed in EventDetailPage
3. useVIPSorting (46 lines) - exists but never imported

All components are complete and functional. This plan only adds imports, state, and render calls.

---

## Task 1: Integrate Track Assignment into GuestsPage

<task id="1" name="wire-track-assignment">
<context>
GuestsPage.tsx (754 lines) manages participant list with filters, search, and CRUD.
TrackAssignmentBulk.tsx (108 lines) needs:
- eventId: string
- selectedParticipantIds: string[]
- onClearSelection: () => void

The component auto-hides when selectedParticipantIds.length === 0.
</context>

<instructions>
1. Add imports at top of GuestsPage.tsx:
   ```typescript
   import { TrackAssignmentBulk } from '@/components/participants/TrackAssignmentBulk'
   import { useVIPSorting } from '@/hooks/useVIPSorting'
   ```

2. Add selection state after existing useState declarations (~line 24):
   ```typescript
   const [selectedParticipantIds, setSelectedParticipantIds] = useState<string[]>([])
   ```

3. Add selection handlers after existing handlers:
   ```typescript
   const handleSelectParticipant = (id: string, selected: boolean) => {
     if (selected) {
       setSelectedParticipantIds(prev => [...prev, id])
     } else {
       setSelectedParticipantIds(prev => prev.filter(p => p !== id))
     }
   }

   const handleSelectAll = (selected: boolean) => {
     if (selected) {
       setSelectedParticipantIds(filteredParticipants.map(p => p.id))
     } else {
       setSelectedParticipantIds([])
     }
   }

   const handleClearSelection = () => {
     setSelectedParticipantIds([])
   }
   ```

4. Apply VIP sorting to filtered participants:
   ```typescript
   // After const filteredParticipants = ... (line ~303)
   const sortedParticipants = useVIPSorting(filteredParticipants)
   ```

5. Replace `filteredParticipants` with `sortedParticipants` in the render loop (line ~460).

6. Add "select all" checkbox in the filter bar header (inside the filters div, ~line 395):
   ```tsx
   <label className="flex items-center gap-2 cursor-pointer">
     <input
       type="checkbox"
       checked={selectedParticipantIds.length === filteredParticipants.length && filteredParticipants.length > 0}
       onChange={(e) => handleSelectAll(e.target.checked)}
       className="w-4 h-4 rounded border-white/20"
     />
     <span className="text-sm text-zinc-400">בחר הכל</span>
   </label>
   ```

7. Add checkbox to each participant card (inside the card div, before the avatar):
   ```tsx
   <input
     type="checkbox"
     checked={selectedParticipantIds.includes(participant.id)}
     onChange={(e) => {
       e.stopPropagation()
       handleSelectParticipant(participant.id, e.target.checked)
     }}
     onClick={(e) => e.stopPropagation()}
     className="w-5 h-5 rounded border-white/20 flex-shrink-0"
   />
   ```

8. Add TrackAssignmentBulk at the end of the component, before closing div:
   ```tsx
   {selectedEventId && (
     <TrackAssignmentBulk
       eventId={selectedEventId}
       selectedParticipantIds={selectedParticipantIds}
       onClearSelection={handleClearSelection}
     />
   )}
   ```
</instructions>

<verification>
- [ ] GuestsPage imports TrackAssignmentBulk and useVIPSorting
- [ ] Selection state exists: selectedParticipantIds
- [ ] Each participant card has a checkbox
- [ ] "Select all" checkbox exists in filter bar
- [ ] VIP participants appear at top of list
- [ ] TrackAssignmentBulk renders when participants selected
- [ ] Selecting participants shows bulk assignment bar at bottom
</verification>
</task>

---

## Task 2: Add Seating Tab to EventDetailPage

<task id="2" name="wire-seating-plan">
<context>
EventDetailPage.tsx has tabs: overview, program, contingencies, changes, settings.
SeatingPlanView.tsx (302 lines) needs:
- eventId: string
- participants: SeatingParticipant[]
- numberOfTables: number
- Optional: defaultTableCapacity, vipTables, trackColors, onAssignmentsSaved

The tab system uses activeTab state and conditional rendering.
</context>

<instructions>
1. Add imports at top of EventDetailPage.tsx:
   ```typescript
   import { SeatingPlanView } from '@/components/networking/SeatingPlanView'
   import type { SeatingParticipant } from '@/modules/networking/types'
   ```

2. Add state for seating data after existing state declarations:
   ```typescript
   const [seatingParticipants, setSeatingParticipants] = useState<SeatingParticipant[]>([])
   const [numberOfTables, setNumberOfTables] = useState(10) // Default 10 tables
   ```

3. Add function to load seating data:
   ```typescript
   async function loadSeatingData() {
     if (!eventId) return

     const { data, error } = await supabase
       .from('participants')
       .select(`
         id, first_name, last_name, is_vip, has_companion, companion_name,
         participant_tracks(track_id)
       `)
       .eq('event_id', eventId)
       .eq('status', 'confirmed')

     if (error) {
       console.error('Error loading seating data:', error)
       return
     }

     const participants: SeatingParticipant[] = (data || []).map(p => ({
       id: p.id,
       first_name: p.first_name,
       last_name: p.last_name,
       is_vip: p.is_vip,
       has_companion: p.has_companion,
       companion_name: p.companion_name,
       trackIds: p.participant_tracks?.map((pt: { track_id: string }) => pt.track_id) || []
     }))

     setSeatingParticipants(participants)
   }
   ```

4. Add useEffect to load seating data when tab active:
   ```typescript
   useEffect(() => {
     if (activeTab === 'seating' && eventId) {
       loadSeatingData()
     }
   }, [activeTab, eventId])
   ```

5. Add seating tab to tabs array (line ~612, after 'contingencies'):
   ```typescript
   { id: 'seating', label: 'שיבוץ לשולחנות', icon: <Grid3X3 size={18} /> },
   ```

6. Add seating tab content (after contingencies tab content, ~line 1398):
   ```tsx
   {activeTab === 'seating' && (
     <div className="card">
       <div className="flex items-center justify-between mb-4">
         <h2 className="text-xl font-bold">שיבוץ לשולחנות</h2>
         <div className="flex items-center gap-2">
           <label className="text-sm text-zinc-400">מספר שולחנות:</label>
           <input
             type="number"
             value={numberOfTables}
             onChange={(e) => setNumberOfTables(Math.max(1, parseInt(e.target.value) || 10))}
             className="w-20 px-2 py-1 bg-zinc-800 rounded border border-white/10"
             min="1"
             max="100"
           />
         </div>
       </div>

       {seatingParticipants.length === 0 ? (
         <div className="text-center py-8 text-zinc-500">
           <p>אין משתתפים מאושרים לשיבוץ</p>
           <p className="text-sm mt-2">רק משתתפים עם סטטוס "אישר הגעה" יופיעו כאן</p>
         </div>
       ) : (
         <SeatingPlanView
           eventId={eventId!}
           participants={seatingParticipants}
           numberOfTables={numberOfTables}
           defaultTableCapacity={8}
           onAssignmentsSaved={() => showToast('שיבוצים נשמרו בהצלחה')}
         />
       )}
     </div>
   )}
   ```
</instructions>

<verification>
- [ ] EventDetailPage imports SeatingPlanView
- [ ] "seating" tab appears in tab list with Grid3X3 icon
- [ ] Tab label is "שיבוץ לשולחנות" (Hebrew RTL)
- [ ] Clicking seating tab loads confirmed participants
- [ ] SeatingPlanView renders with participants data
- [ ] Number of tables input adjusts the table count
- [ ] Empty state shows when no confirmed participants
</verification>
</task>

---

## Task 3: Verify End-to-End Integration

<task id="3" name="verify-integration">
<context>
After Tasks 1-2, all Phase 7 UI components should be accessible.
</context>

<instructions>
1. Verify TrackAssignmentBulk integration:
   - Open GuestsPage
   - Select multiple participants via checkboxes
   - Verify bulk assignment bar appears at bottom
   - Verify track buttons are visible
   - Verify "cancel selection" button works

2. Verify SeatingPlanView integration:
   - Open EventDetailPage for any event
   - Click "שיבוץ לשולחנות" tab
   - Verify table grid renders
   - Verify "יצירת שיבוץ חכם" button works
   - Verify drag-drop works when edit mode enabled

3. Verify VIP sorting:
   - Create or identify VIP participants
   - View GuestsPage
   - Verify VIP participants appear at top of list

4. Run TypeScript compilation to catch any type errors:
   ```bash
   cd eventflow-app && npx tsc --noEmit
   ```
</instructions>

<verification>
- [ ] No TypeScript errors
- [ ] Track assignment bar appears on selection
- [ ] Seating tab accessible and functional
- [ ] VIPs sort to top of participant list
- [ ] All Phase 7 requirements now SATISFIED (not PARTIAL)
</verification>
</task>

---

## Summary

| Task | Action | Files | Estimated |
|------|--------|-------|-----------|
| 1 | Wire TrackAssignmentBulk + useVIPSorting into GuestsPage | GuestsPage.tsx | ~50 lines added |
| 2 | Add seating tab with SeatingPlanView to EventDetailPage | EventDetailPage.tsx | ~60 lines added |
| 3 | Verify integration end-to-end | N/A | Manual verification |

**Expected Outcome:** Phase 7 verification score improves from 4/5 to 5/5 must-haves. All 11 requirements become SATISFIED.
