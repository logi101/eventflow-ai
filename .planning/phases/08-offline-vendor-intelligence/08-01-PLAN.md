---
phase: 08-offline-vendor-intelligence
plan: 01
type: database
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/008_budget_alerts.sql
  - src/types/vendor.ts
autonomous: true
must_haves:
  - checklist_items table has budget_allocation column (DECIMAL(12,2))
  - budget_alert_history table tracks sent alerts per checklist item
  - event_vendors table has approved_amount column (DECIMAL(12,2))
  - RLS policies enforce organization isolation on new tables
  - Migration is idempotent (safe to run multiple times)
---

# Plan 08-01: Database Foundation for Budget Alerts

## Objective

Add database support for linking vendors to checklist items with budget tracking, and create alert history to prevent duplicate notifications.

## Context

**From CONTEXT.md:**
- Two-tier alerts: 80% = warning, 100% = critical
- Budget alerts via in-app badge AND WhatsApp to manager
- Track alert_sent_at to prevent duplicate alerts

**From RESEARCH.md:**
- Store alert_sent_at timestamp on checklist_items or separate table
- Reset alert status when manager acknowledges or adjusts budget

**Existing schema:**
- `checklist_items` has `assigned_vendor_id UUID REFERENCES event_vendors(id)` but NO budget field
- `event_vendors` has `quoted_amount` but needs `approved_amount` for actual tracking
- `events` has global `budget DECIMAL(12,2)` but no per-item budgets

## Tasks

<task id="1" title="Create Migration File">
Create migration `008_budget_alerts.sql` with:

1. Add `budget_allocation DECIMAL(12,2)` to `checklist_items`
2. Add `approved_amount DECIMAL(12,2)` to `event_vendors`
3. Create `budget_alert_history` table:
   - id, checklist_item_id, event_id, organization_id
   - alert_type ('warning' | 'critical')
   - threshold_percentage (80 or 100)
   - current_amount, budget_amount
   - sent_at, sent_via ('app' | 'whatsapp' | 'both')
   - acknowledged_at (nullable, for manager acknowledgment)
4. Create index on budget_alert_history(checklist_item_id, alert_type)
5. RLS policies: organization isolation via event_id → events → organization_id

Migration must be idempotent:
```sql
-- Add column if not exists
ALTER TABLE checklist_items ADD COLUMN IF NOT EXISTS budget_allocation DECIMAL(12,2);
```

</task>

<task id="2" title="Update TypeScript Types">
Update `src/types/vendor.ts` (or appropriate types file):

1. Add `budget_allocation?: number` to ChecklistItem type
2. Add `approved_amount?: number` to EventVendor type
3. Create `BudgetAlert` type:
   ```typescript
   interface BudgetAlert {
     id: string
     checklistItemId: string
     eventId: string
     alertType: 'warning' | 'critical'
     thresholdPercentage: number
     currentAmount: number
     budgetAmount: number
     sentAt: string
     sentVia: 'app' | 'whatsapp' | 'both'
     acknowledgedAt?: string
   }
   ```
4. Create `BudgetAlertThreshold` enum: `{ WARNING = 80, CRITICAL = 100 }`

</task>

<task id="3" title="Apply Migration">
Apply migration to Supabase:
1. Run migration via Supabase MCP or SQL editor
2. Verify columns exist: `SELECT column_name FROM information_schema.columns WHERE table_name = 'checklist_items' AND column_name = 'budget_allocation'`
3. Verify RLS: `SELECT * FROM pg_policies WHERE tablename = 'budget_alert_history'`

</task>

## Verification

```bash
# Verify budget_allocation column
SELECT column_name, data_type FROM information_schema.columns
WHERE table_name = 'checklist_items' AND column_name = 'budget_allocation';

# Verify budget_alert_history table
SELECT table_name FROM information_schema.tables
WHERE table_name = 'budget_alert_history';

# Verify RLS enabled
SELECT tablename, rowsecurity FROM pg_tables
WHERE tablename = 'budget_alert_history' AND rowsecurity = true;
```

## Notes

- This migration is independent of offline check-in work
- No API changes needed yet (backend plan 08-04 will use these)
- Alert history allows tracking which alerts were sent to prevent spam
