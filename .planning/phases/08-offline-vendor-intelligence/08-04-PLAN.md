---
phase: 08-offline-vendor-intelligence
plan: 04
type: backend
wave: 2
depends_on:
  - 08-01
files_modified:
  - supabase/functions/budget-alerts/index.ts
  - src/modules/vendors/services/budgetService.ts
  - src/modules/vendors/hooks/useBudgetAlerts.ts
autonomous: true
must_haves:
  - Edge Function checks budget thresholds (80% warning, 100% critical)
  - Alerts sent via in-app (database record) AND WhatsApp to manager
  - Duplicate alerts prevented via budget_alert_history check
  - Frontend hook exposes active alerts for UI badge
  - Alert acknowledges removes badge but keeps history
---

# Plan 08-04: Budget Threshold Alert System

## Objective

Create the backend system for detecting when vendor quotes exceed budget thresholds and alerting the manager via multiple channels.

## Context

**From CONTEXT.md:**
- Two-tier alerts: 80% = warning (yellow), 100% = critical (red)
- Alerts appear both in-app (badge on vendor section) AND via WhatsApp to manager
- Budget alerts should feel urgent at 100% - manager needs to act

**From RESEARCH.md:**
- Track alert_sent_at timestamp per checklist item per threshold
- Only alert once per threshold per item
- Reset alert status when manager acknowledges or adjusts budget

**Database (from 08-01):**
- `checklist_items.budget_allocation` - per-item budget
- `event_vendors.approved_amount` - accepted quote amount
- `budget_alert_history` - tracks sent alerts

## Tasks

<task id="1" title="Create Budget Alerts Edge Function">
Create `supabase/functions/budget-alerts/index.ts`:

```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

interface BudgetCheckResult {
  checklistItemId: string
  title: string
  budgetAmount: number
  currentAmount: number
  percentage: number
  threshold: 'warning' | 'critical'
  alreadySent: boolean
}

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const supabaseUrl = Deno.env.get('SUPABASE_URL')!
    const serviceRoleKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
    const supabase = createClient(supabaseUrl, serviceRoleKey)

    const { eventId, organizationId, checkNow } = await req.json()

    if (!eventId) {
      return new Response(JSON.stringify({ error: 'eventId required' }), {
        status: 400,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      })
    }

    // Fetch checklist items with budgets and linked vendor quotes
    const { data: items, error: itemsError } = await supabase
      .from('checklist_items')
      .select(`
        id,
        title,
        budget_allocation,
        event_vendors!assigned_vendor_id (
          id,
          quoted_amount,
          approved_amount,
          status
        )
      `)
      .eq('event_id', eventId)
      .not('budget_allocation', 'is', null)
      .not('assigned_vendor_id', 'is', null)

    if (itemsError) throw itemsError

    // Check existing alerts
    const { data: existingAlerts } = await supabase
      .from('budget_alert_history')
      .select('checklist_item_id, alert_type, acknowledged_at')
      .eq('event_id', eventId)
      .is('acknowledged_at', null)  // Only unacknowledged

    const alertMap = new Map<string, Set<string>>()
    existingAlerts?.forEach(a => {
      if (!alertMap.has(a.checklist_item_id)) {
        alertMap.set(a.checklist_item_id, new Set())
      }
      alertMap.get(a.checklist_item_id)!.add(a.alert_type)
    })

    const alerts: BudgetCheckResult[] = []
    const newAlertsToSend: BudgetCheckResult[] = []

    for (const item of items || []) {
      if (!item.event_vendors) continue

      // Use approved_amount if available, otherwise quoted_amount
      const vendorData = item.event_vendors as any
      const currentAmount = vendorData.approved_amount || vendorData.quoted_amount || 0
      const percentage = (currentAmount / item.budget_allocation) * 100

      const existingForItem = alertMap.get(item.id) || new Set()

      // Check critical threshold (100%)
      if (percentage >= 100) {
        const alreadySent = existingForItem.has('critical')
        alerts.push({
          checklistItemId: item.id,
          title: item.title,
          budgetAmount: item.budget_allocation,
          currentAmount,
          percentage,
          threshold: 'critical',
          alreadySent
        })
        if (!alreadySent) {
          newAlertsToSend.push({
            checklistItemId: item.id,
            title: item.title,
            budgetAmount: item.budget_allocation,
            currentAmount,
            percentage,
            threshold: 'critical',
            alreadySent: false
          })
        }
      }
      // Check warning threshold (80%)
      else if (percentage >= 80) {
        const alreadySent = existingForItem.has('warning')
        alerts.push({
          checklistItemId: item.id,
          title: item.title,
          budgetAmount: item.budget_allocation,
          currentAmount,
          percentage,
          threshold: 'warning',
          alreadySent
        })
        if (!alreadySent) {
          newAlertsToSend.push({
            checklistItemId: item.id,
            title: item.title,
            budgetAmount: item.budget_allocation,
            currentAmount,
            percentage,
            threshold: 'warning',
            alreadySent: false
          })
        }
      }
    }

    // If checkNow flag, send new alerts
    if (checkNow && newAlertsToSend.length > 0) {
      // Get event manager phone for WhatsApp
      const { data: event } = await supabase
        .from('events')
        .select('organization_id, user_profiles!events_created_by_fkey(phone_normalized)')
        .eq('id', eventId)
        .single()

      const managerPhone = (event?.user_profiles as any)?.phone_normalized

      for (const alert of newAlertsToSend) {
        // Record in alert history
        await supabase.from('budget_alert_history').insert({
          checklist_item_id: alert.checklistItemId,
          event_id: eventId,
          organization_id: organizationId || event?.organization_id,
          alert_type: alert.threshold,
          threshold_percentage: alert.threshold === 'critical' ? 100 : 80,
          current_amount: alert.currentAmount,
          budget_amount: alert.budgetAmount,
          sent_via: managerPhone ? 'both' : 'app'
        })

        // Send WhatsApp if manager phone available
        if (managerPhone) {
          const message = alert.threshold === 'critical'
            ? `ğŸš¨ *×ª×§×¦×™×‘ ×—×¨×’!*\n\n×¤×¨×™×˜: ${alert.title}\nğŸ“Š ${Math.round(alert.percentage)}% ××”×ª×§×¦×™×‘\nğŸ’° ${alert.currentAmount.toLocaleString()} â‚ª ××ª×•×š ${alert.budgetAmount.toLocaleString()} â‚ª\n\n×™×© ×œ×¤×¢×•×œ ××™×“.`
            : `âš ï¸ *××–×”×¨×ª ×ª×§×¦×™×‘*\n\n×¤×¨×™×˜: ${alert.title}\nğŸ“Š ${Math.round(alert.percentage)}% ××”×ª×§×¦×™×‘\nğŸ’° ${alert.currentAmount.toLocaleString()} â‚ª ××ª×•×š ${alert.budgetAmount.toLocaleString()} â‚ª`

          // Call send-whatsapp edge function
          await supabase.functions.invoke('send-whatsapp', {
            body: {
              recipientPhone: managerPhone,
              message,
              eventId
            }
          })
        }
      }
    }

    return new Response(JSON.stringify({
      alerts,
      newAlertsSent: newAlertsToSend.length,
      totalChecked: items?.length || 0
    }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    })

  } catch (error) {
    console.error('Budget alert error:', error)
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    })
  }
})
```

</task>

<task id="2" title="Create Budget Service">
Create `src/modules/vendors/services/budgetService.ts`:

```typescript
import { supabase } from '../../../lib/supabase'

export interface BudgetAlert {
  checklistItemId: string
  title: string
  budgetAmount: number
  currentAmount: number
  percentage: number
  threshold: 'warning' | 'critical'
  alreadySent: boolean
}

export interface BudgetCheckResult {
  alerts: BudgetAlert[]
  newAlertsSent: number
  totalChecked: number
}

// Check budget thresholds for an event
export async function checkBudgetAlerts(
  eventId: string,
  options: { sendAlerts?: boolean } = {}
): Promise<BudgetCheckResult> {
  const { data, error } = await supabase.functions.invoke('budget-alerts', {
    body: {
      eventId,
      checkNow: options.sendAlerts ?? false
    }
  })

  if (error) throw error
  return data as BudgetCheckResult
}

// Get active (unacknowledged) alerts for an event
export async function getActiveAlerts(eventId: string): Promise<BudgetAlert[]> {
  const { data, error } = await supabase
    .from('budget_alert_history')
    .select(`
      id,
      checklist_item_id,
      alert_type,
      threshold_percentage,
      current_amount,
      budget_amount,
      checklist_items!checklist_item_id (title)
    `)
    .eq('event_id', eventId)
    .is('acknowledged_at', null)
    .order('created_at', { ascending: false })

  if (error) throw error

  return (data || []).map(row => ({
    checklistItemId: row.checklist_item_id,
    title: (row.checklist_items as any)?.title || 'Unknown',
    budgetAmount: row.budget_amount,
    currentAmount: row.current_amount,
    percentage: (row.current_amount / row.budget_amount) * 100,
    threshold: row.alert_type as 'warning' | 'critical',
    alreadySent: true
  }))
}

// Acknowledge an alert (dismiss badge but keep history)
export async function acknowledgeAlert(alertId: string): Promise<void> {
  const { error } = await supabase
    .from('budget_alert_history')
    .update({ acknowledged_at: new Date().toISOString() })
    .eq('id', alertId)

  if (error) throw error
}

// Acknowledge all alerts for a checklist item
export async function acknowledgeItemAlerts(
  eventId: string,
  checklistItemId: string
): Promise<void> {
  const { error } = await supabase
    .from('budget_alert_history')
    .update({ acknowledged_at: new Date().toISOString() })
    .eq('event_id', eventId)
    .eq('checklist_item_id', checklistItemId)
    .is('acknowledged_at', null)

  if (error) throw error
}
```

</task>

<task id="3" title="Create Budget Alerts Hook">
Create `src/modules/vendors/hooks/useBudgetAlerts.ts`:

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import {
  checkBudgetAlerts,
  getActiveAlerts,
  acknowledgeAlert,
  acknowledgeItemAlerts,
  BudgetAlert
} from '../services/budgetService'

export function useBudgetAlerts(eventId: string | undefined) {
  const queryClient = useQueryClient()

  // Get active (unacknowledged) alerts
  const {
    data: alerts,
    isLoading,
    error,
    refetch
  } = useQuery({
    queryKey: ['budgetAlerts', eventId],
    queryFn: () => getActiveAlerts(eventId!),
    enabled: !!eventId,
    refetchInterval: 5 * 60 * 1000  // Refetch every 5 minutes
  })

  // Check and send new alerts
  const checkAlerts = useMutation({
    mutationFn: () => checkBudgetAlerts(eventId!, { sendAlerts: true }),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['budgetAlerts', eventId] })
    }
  })

  // Acknowledge single alert
  const acknowledge = useMutation({
    mutationFn: acknowledgeAlert,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['budgetAlerts', eventId] })
    }
  })

  // Acknowledge all alerts for a checklist item
  const acknowledgeItem = useMutation({
    mutationFn: (checklistItemId: string) =>
      acknowledgeItemAlerts(eventId!, checklistItemId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['budgetAlerts', eventId] })
    }
  })

  // Computed values
  const criticalAlerts = alerts?.filter(a => a.threshold === 'critical') || []
  const warningAlerts = alerts?.filter(a => a.threshold === 'warning') || []
  const hasAlerts = (alerts?.length || 0) > 0
  const hasCritical = criticalAlerts.length > 0

  return {
    alerts: alerts || [],
    criticalAlerts,
    warningAlerts,
    hasAlerts,
    hasCritical,
    isLoading,
    error,
    refetch,
    checkAlerts,
    acknowledge,
    acknowledgeItem
  }
}

// Lightweight hook just for badge count
export function useBudgetAlertCount(eventId: string | undefined) {
  const { data: alerts } = useQuery({
    queryKey: ['budgetAlerts', eventId],
    queryFn: () => getActiveAlerts(eventId!),
    enabled: !!eventId,
    staleTime: 60 * 1000  // 1 minute
  })

  return {
    count: alerts?.length || 0,
    hasCritical: alerts?.some(a => a.threshold === 'critical') || false
  }
}
```

</task>

<task id="4" title="Deploy Edge Function">
Deploy the budget-alerts Edge Function:

```bash
cd eventflow-app
supabase functions deploy budget-alerts --no-verify-jwt
```

Or via MCP if available.

</task>

## Verification

```bash
# Test Edge Function
curl -X POST 'https://[project].supabase.co/functions/v1/budget-alerts' \
  -H 'Authorization: Bearer [anon-key]' \
  -H 'Content-Type: application/json' \
  -d '{"eventId": "[event-uuid]", "checkNow": false}'

# Expected response:
# {"alerts": [...], "newAlertsSent": 0, "totalChecked": N}
```

```typescript
// Frontend test
const { alerts, hasCritical, checkAlerts } = useBudgetAlerts(eventId)
console.log('Active alerts:', alerts.length)
console.log('Has critical:', hasCritical)

// Trigger check
await checkAlerts.mutateAsync()
```

## Notes

- Edge Function can be called manually or scheduled via cron
- Alert deduplication prevents WhatsApp spam
- acknowledgeAlert removes from badge but keeps history for audit
- 5-minute refetch interval keeps UI fresh without excessive polling
