---
phase: 09-day-simulation-real-time-operations
plan: 01
title: Database & Types Foundation
type: foundation
wave: 1
depends_on: []
files_modified:
  - eventflow-scaffold/migrations/009_simulation_contingency.sql
  - eventflow-app/src/modules/simulation/types/simulation.types.ts
  - eventflow-app/src/modules/simulation/types/validators.types.ts
  - eventflow-app/src/modules/contingency/types/contingency.types.ts
  - eventflow-app/src/modules/simulation/types/index.ts
  - eventflow-app/src/modules/contingency/types/index.ts
autonomous: true
must_haves:
  - contingency_audit_log table exists with RLS (INSERT/SELECT only, no UPDATE/DELETE)
  - backup_speaker_id column on schedules table for contingency tracking
  - SimulationIssue and SimulationResult types defined with Zod schemas
  - ContingencyAction and AuditEntry types defined with Zod schemas
  - Three severity levels (critical/warning/info) as const enum
  - Eight issue categories (room/speaker/capacity/timing/equipment/vip/catering/backtoback)
---

# Phase 9 Plan 1: Database & Types Foundation

## Objective

Establish the database schema for contingency audit logging and define all TypeScript types for both simulation and contingency features. This foundation enables Wave 2 plans to build validators and services with type safety.

## Context

**From Phase 6:** The ai_insights_log pattern (JSONB action_data, lifecycle status tracking) provides the template for contingency_audit_log.

**From CONTEXT.md:**
- Contingency audit log must track: who activated, when, what changed, reason for change
- Append-only enforcement (no UPDATE/DELETE policies)
- RLS policies enforce organization isolation

**From RESEARCH.md:**
- contingency_audit_log table design with execution_status lifecycle
- SimulationIssue interface with severity, category, affectedEntities, suggestedFix
- Deterministic issue IDs via content-based generation

## Tasks

<task id="1" name="create-migration-file">
### Task 1: Create Migration 009_simulation_contingency.sql

Create the database migration for Phase 9 tables and columns.

**File:** `eventflow-scaffold/migrations/009_simulation_contingency.sql`

**Schema requirements:**

```sql
-- 1. Add backup_speaker_id to schedules for contingency tracking
ALTER TABLE schedules ADD COLUMN IF NOT EXISTS backup_speaker_id UUID REFERENCES speakers(id);
ALTER TABLE schedules ADD COLUMN IF NOT EXISTS original_speaker_id UUID REFERENCES speakers(id);

-- 2. Create contingency_audit_log table (append-only)
CREATE TABLE IF NOT EXISTS contingency_audit_log (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  event_id UUID NOT NULL REFERENCES events(id) ON DELETE CASCADE,
  action_type TEXT NOT NULL, -- 'backup_speaker_activate', 'room_change', 'schedule_adjust', 'time_change'
  action_data JSONB NOT NULL, -- Full action details (schedule_id, original values, new values)
  execution_status TEXT NOT NULL DEFAULT 'suggested', -- 'suggested', 'approved', 'executed', 'rejected', 'failed'
  suggested_by UUID NOT NULL REFERENCES user_profiles(id),
  suggested_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  approved_by UUID REFERENCES user_profiles(id),
  approved_at TIMESTAMPTZ,
  executed_by UUID REFERENCES user_profiles(id),
  executed_at TIMESTAMPTZ,
  rejected_by UUID REFERENCES user_profiles(id),
  rejected_at TIMESTAMPTZ,
  reason TEXT NOT NULL, -- Why this action was taken
  impact_summary JSONB, -- { affected_participants: N, notifications_sent: N, affected_sessions: [...] }
  error_message TEXT, -- If execution failed
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 3. Indexes for query performance
CREATE INDEX IF NOT EXISTS idx_contingency_audit_event ON contingency_audit_log(event_id);
CREATE INDEX IF NOT EXISTS idx_contingency_audit_status ON contingency_audit_log(execution_status);
CREATE INDEX IF NOT EXISTS idx_contingency_audit_suggested_at ON contingency_audit_log(suggested_at DESC);

-- 4. RLS policies - APPEND-ONLY (INSERT and SELECT only, NO UPDATE/DELETE)
ALTER TABLE contingency_audit_log ENABLE ROW LEVEL SECURITY;

-- Policy: Users can insert audit logs for their organization's events
CREATE POLICY "Users can insert contingency audit logs"
  ON contingency_audit_log FOR INSERT
  WITH CHECK (
    event_id IN (
      SELECT e.id FROM events e
      WHERE e.organization_id = (
        SELECT organization_id FROM user_profiles WHERE id = auth.uid()
      )
    )
  );

-- Policy: Users can view audit logs for their organization's events
CREATE POLICY "Users can view contingency audit logs"
  ON contingency_audit_log FOR SELECT
  USING (
    event_id IN (
      SELECT e.id FROM events e
      WHERE e.organization_id = (
        SELECT organization_id FROM user_profiles WHERE id = auth.uid()
      )
    )
  );

-- NO UPDATE OR DELETE POLICIES - This enforces append-only behavior
-- Any attempt to UPDATE or DELETE will be denied by RLS

-- 5. Add message_type enum value for schedule updates (if not exists)
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_enum WHERE enumlabel = 'schedule_update' AND enumtypid = 'message_type'::regtype) THEN
    ALTER TYPE message_type ADD VALUE 'schedule_update';
  END IF;
EXCEPTION
  WHEN undefined_object THEN
    -- message_type enum doesn't exist, skip
    NULL;
END $$;
```

**Idempotency:** Use IF NOT EXISTS and IF EXISTS checks throughout.

**Validation queries to include at end:**
```sql
-- Verify migration
SELECT 'backup_speaker_id column' AS check, EXISTS (
  SELECT 1 FROM information_schema.columns
  WHERE table_name = 'schedules' AND column_name = 'backup_speaker_id'
) AS exists;

SELECT 'contingency_audit_log table' AS check, EXISTS (
  SELECT 1 FROM information_schema.tables
  WHERE table_name = 'contingency_audit_log'
) AS exists;

SELECT 'RLS enabled' AS check, rowsecurity FROM pg_tables
WHERE tablename = 'contingency_audit_log';
```
</task>

<task id="2" name="create-simulation-types">
### Task 2: Create Simulation Types

Create TypeScript types and Zod schemas for simulation.

**Directory structure:**
```
src/modules/simulation/
├── types/
│   ├── simulation.types.ts
│   ├── validators.types.ts
│   └── index.ts
```

**File:** `src/modules/simulation/types/simulation.types.ts`

```typescript
import { z } from 'zod'

// Severity levels (ordered by priority)
export const SimulationSeverity = {
  CRITICAL: 'critical',
  WARNING: 'warning',
  INFO: 'info',
} as const

export type SimulationSeverity = typeof SimulationSeverity[keyof typeof SimulationSeverity]

// Issue categories (8 validators)
export const IssueCategory = {
  ROOM: 'room',
  SPEAKER: 'speaker',
  CAPACITY: 'capacity',
  TIMING: 'timing',
  EQUIPMENT: 'equipment',
  VIP: 'vip',
  CATERING: 'catering',
  BACK_TO_BACK: 'backtoback',
} as const

export type IssueCategory = typeof IssueCategory[keyof typeof IssueCategory]

// Suggested fix action types
export const FixActionType = {
  UPDATE_SCHEDULE: 'update_schedule',
  REASSIGN_ROOM: 'reassign_room',
  ADJUST_TIME: 'adjust_time',
  ADD_EQUIPMENT: 'add_equipment',
  ACTIVATE_BACKUP: 'activate_backup',
  EXTEND_BREAK: 'extend_break',
  ADD_CATERING: 'add_catering',
} as const

export type FixActionType = typeof FixActionType[keyof typeof FixActionType]

// Zod schemas
export const suggestedFixSchema = z.object({
  type: z.enum([
    'update_schedule',
    'reassign_room',
    'adjust_time',
    'add_equipment',
    'activate_backup',
    'extend_break',
    'add_catering',
  ]),
  action_data: z.record(z.unknown()),
  label: z.string(), // Hebrew label for UI button
})

export const affectedEntitiesSchema = z.object({
  schedule_ids: z.array(z.string().uuid()).optional(),
  participant_ids: z.array(z.string().uuid()).optional(),
  vendor_ids: z.array(z.string().uuid()).optional(),
  speaker_ids: z.array(z.string().uuid()).optional(),
  room_ids: z.array(z.string()).optional(),
})

export const simulationIssueSchema = z.object({
  id: z.string(), // Deterministic ID based on issue content
  severity: z.enum(['critical', 'warning', 'info']),
  category: z.enum(['room', 'speaker', 'capacity', 'timing', 'equipment', 'vip', 'catering', 'backtoback']),
  title: z.string(), // Hebrew title
  description: z.string(), // Hebrew description with context
  affectedEntities: affectedEntitiesSchema,
  suggestedFix: suggestedFixSchema.optional(),
})

export const simulationResultSchema = z.object({
  event_id: z.string().uuid(),
  run_at: z.string().datetime(),
  total_issues: z.number().int().nonnegative(),
  critical: z.number().int().nonnegative(),
  warnings: z.number().int().nonnegative(),
  info: z.number().int().nonnegative(),
  issues: z.array(simulationIssueSchema),
  duration_ms: z.number().int().nonnegative().optional(),
})

// Inferred types
export type SuggestedFix = z.infer<typeof suggestedFixSchema>
export type AffectedEntities = z.infer<typeof affectedEntitiesSchema>
export type SimulationIssue = z.infer<typeof simulationIssueSchema>
export type SimulationResult = z.infer<typeof simulationResultSchema>

// Grouped issues for UI display
export interface GroupedIssues {
  critical: SimulationIssue[]
  warning: SimulationIssue[]
  info: SimulationIssue[]
}

// Severity configuration for UI
export const severityConfig = {
  critical: {
    color: 'red',
    bgColor: 'bg-red-50',
    borderColor: 'border-red-200',
    textColor: 'text-red-700',
    iconColor: 'text-red-500',
    label: 'קריטי',
    description: 'בעיות שחייבות פתרון לפני האירוע',
  },
  warning: {
    color: 'yellow',
    bgColor: 'bg-yellow-50',
    borderColor: 'border-yellow-200',
    textColor: 'text-yellow-700',
    iconColor: 'text-yellow-500',
    label: 'אזהרה',
    description: 'בעיות מומלצות לפתרון',
  },
  info: {
    color: 'blue',
    bgColor: 'bg-blue-50',
    borderColor: 'border-blue-200',
    textColor: 'text-blue-700',
    iconColor: 'text-blue-500',
    label: 'מידע',
    description: 'המלצות לשיפור',
  },
} as const
```

**File:** `src/modules/simulation/types/validators.types.ts`

```typescript
import type { SimulationIssue } from './simulation.types'

// Schedule data structure for validators
export interface ScheduleData {
  id: string
  event_id: string
  title: string
  start_time: string // ISO datetime
  end_time: string // ISO datetime
  room_id: string | null
  room_name: string | null
  room_capacity: number | null
  speaker_id: string | null
  speaker_name: string | null
  backup_speaker_id: string | null
  session_type: string | null // 'lecture', 'workshop', 'break', 'meal', 'networking'
  expected_attendance: number | null
  equipment_required: string[] | null
}

// Participant schedule for transition validation
export interface ParticipantScheduleData {
  participant_id: string
  participant_name: string
  is_vip: boolean
  schedule_id: string
  schedule_title: string
  start_time: string
  end_time: string
  room_id: string | null
  room_name: string | null
}

// Vendor data for catering validation
export interface VendorScheduleData {
  vendor_id: string
  vendor_name: string
  category: string
  schedule_id: string | null
  service_start: string | null
  service_end: string | null
}

// Equipment assignment data
export interface EquipmentData {
  schedule_id: string
  required: string[]
  assigned: string[]
}

// Validator function signature
export type ValidatorFn<T = unknown> = (data: T) => Promise<SimulationIssue[]>

// Validator metadata
export interface ValidatorMeta {
  name: string
  category: SimulationIssue['category']
  description: string
}

// Validator with metadata
export interface Validator<T = unknown> {
  meta: ValidatorMeta
  validate: ValidatorFn<T>
}

// Simulation input data (all data needed by validators)
export interface SimulationInput {
  event_id: string
  schedules: ScheduleData[]
  participantSchedules: ParticipantScheduleData[]
  vendors: VendorScheduleData[]
  equipment: EquipmentData[]
}
```

**File:** `src/modules/simulation/types/index.ts`

```typescript
export * from './simulation.types'
export * from './validators.types'
```
</task>

<task id="3" name="create-contingency-types">
### Task 3: Create Contingency Types

Create TypeScript types and Zod schemas for contingency management.

**Directory structure:**
```
src/modules/contingency/
├── types/
│   ├── contingency.types.ts
│   └── index.ts
```

**File:** `src/modules/contingency/types/contingency.types.ts`

```typescript
import { z } from 'zod'

// Contingency action types
export const ContingencyActionType = {
  BACKUP_SPEAKER_ACTIVATE: 'backup_speaker_activate',
  ROOM_CHANGE: 'room_change',
  SCHEDULE_ADJUST: 'schedule_adjust',
  TIME_CHANGE: 'time_change',
  SESSION_CANCEL: 'session_cancel',
} as const

export type ContingencyActionType = typeof ContingencyActionType[keyof typeof ContingencyActionType]

// Execution status lifecycle
export const ExecutionStatus = {
  SUGGESTED: 'suggested',
  APPROVED: 'approved',
  EXECUTED: 'executed',
  REJECTED: 'rejected',
  FAILED: 'failed',
} as const

export type ExecutionStatus = typeof ExecutionStatus[keyof typeof ExecutionStatus]

// Zod schemas
export const contingencyActionDataSchema = z.object({
  schedule_id: z.string().uuid(),
  schedule_title: z.string(),
  // For backup speaker
  original_speaker_id: z.string().uuid().optional(),
  original_speaker_name: z.string().optional(),
  backup_speaker_id: z.string().uuid().optional(),
  backup_speaker_name: z.string().optional(),
  // For room change
  original_room_id: z.string().optional(),
  original_room_name: z.string().optional(),
  new_room_id: z.string().optional(),
  new_room_name: z.string().optional(),
  // For time change
  original_start_time: z.string().datetime().optional(),
  original_end_time: z.string().datetime().optional(),
  new_start_time: z.string().datetime().optional(),
  new_end_time: z.string().datetime().optional(),
})

export const impactSummarySchema = z.object({
  affected_participants: z.number().int().nonnegative(),
  notifications_sent: z.number().int().nonnegative(),
  notifications_failed: z.number().int().nonnegative().optional(),
  affected_sessions: z.array(z.string().uuid()),
  vip_affected: z.number().int().nonnegative().optional(),
})

export const contingencyActionSchema = z.object({
  id: z.string().uuid().optional(), // Set by database on insert
  event_id: z.string().uuid(),
  action_type: z.enum([
    'backup_speaker_activate',
    'room_change',
    'schedule_adjust',
    'time_change',
    'session_cancel',
  ]),
  action_data: contingencyActionDataSchema,
  execution_status: z.enum(['suggested', 'approved', 'executed', 'rejected', 'failed']),
  suggested_by: z.string().uuid(),
  suggested_at: z.string().datetime(),
  approved_by: z.string().uuid().optional(),
  approved_at: z.string().datetime().optional(),
  executed_by: z.string().uuid().optional(),
  executed_at: z.string().datetime().optional(),
  rejected_by: z.string().uuid().optional(),
  rejected_at: z.string().datetime().optional(),
  reason: z.string().min(1),
  impact_summary: impactSummarySchema.optional(),
  error_message: z.string().optional(),
})

export const auditEntrySchema = contingencyActionSchema.extend({
  id: z.string().uuid(),
  created_at: z.string().datetime(),
})

// Inferred types
export type ContingencyActionData = z.infer<typeof contingencyActionDataSchema>
export type ImpactSummary = z.infer<typeof impactSummarySchema>
export type ContingencyAction = z.infer<typeof contingencyActionSchema>
export type AuditEntry = z.infer<typeof auditEntrySchema>

// Suggestion response (returned by contingencyManager.suggest)
export interface ContingencySuggestion {
  action_id: string
  type: ContingencyActionType
  status: 'pending_approval'
  data: ContingencyActionData
  impact: ImpactSummary
  label: string // Hebrew label for UI
  reason: string
}

// Execution result
export interface ContingencyExecutionResult {
  success: boolean
  action_id: string
  execution_status: ExecutionStatus
  impact_summary?: ImpactSummary
  error_message?: string
}

// UI helper types
export const actionTypeLabels: Record<ContingencyActionType, string> = {
  backup_speaker_activate: 'הפעלת דובר חלופי',
  room_change: 'שינוי אולם',
  schedule_adjust: 'התאמת לו״ז',
  time_change: 'שינוי שעות',
  session_cancel: 'ביטול סשן',
}

export const statusLabels: Record<ExecutionStatus, string> = {
  suggested: 'הוצע',
  approved: 'אושר',
  executed: 'בוצע',
  rejected: 'נדחה',
  failed: 'נכשל',
}

export const statusColors: Record<ExecutionStatus, { bg: string; text: string }> = {
  suggested: { bg: 'bg-blue-100', text: 'text-blue-700' },
  approved: { bg: 'bg-yellow-100', text: 'text-yellow-700' },
  executed: { bg: 'bg-green-100', text: 'text-green-700' },
  rejected: { bg: 'bg-gray-100', text: 'text-gray-700' },
  failed: { bg: 'bg-red-100', text: 'text-red-700' },
}
```

**File:** `src/modules/contingency/types/index.ts`

```typescript
export * from './contingency.types'
```
</task>

## Verification

After completing all tasks:

1. **Database migration valid:**
   - Run migration in Supabase SQL editor (or save for deployment)
   - Verify contingency_audit_log table exists
   - Verify backup_speaker_id column on schedules
   - Verify RLS policies (INSERT/SELECT only)

2. **Types compile without errors:**
   - Run `npx tsc --noEmit` from eventflow-app directory
   - All imports resolve correctly
   - Zod schemas validate correctly

3. **Append-only enforcement:**
   - RLS policies only allow INSERT and SELECT
   - No UPDATE or DELETE policies exist

## Files Created

- `eventflow-scaffold/migrations/009_simulation_contingency.sql`
- `eventflow-app/src/modules/simulation/types/simulation.types.ts`
- `eventflow-app/src/modules/simulation/types/validators.types.ts`
- `eventflow-app/src/modules/simulation/types/index.ts`
- `eventflow-app/src/modules/contingency/types/contingency.types.ts`
- `eventflow-app/src/modules/contingency/types/index.ts`

## Dependencies

None - this is Wave 1 (foundation plan).

## Next Plans

- **09-02**: Uses simulation types to implement validators
- **09-03**: Uses contingency types to implement services
