---
phase: 09-day-simulation-real-time-operations
plan: 04
title: Simulation UI & Hooks
type: feature
wave: 3
depends_on: [09-02]
files_modified:
  - eventflow-app/src/modules/simulation/components/SimulationTrigger.tsx
  - eventflow-app/src/modules/simulation/components/SimulationReport.tsx
  - eventflow-app/src/modules/simulation/components/SimulationIssueCard.tsx
  - eventflow-app/src/modules/simulation/components/SimulationSummary.tsx
  - eventflow-app/src/modules/simulation/components/IssueSection.tsx
  - eventflow-app/src/modules/simulation/components/index.ts
  - eventflow-app/src/modules/simulation/hooks/useSimulation.ts
  - eventflow-app/src/modules/simulation/hooks/index.ts
  - eventflow-app/src/modules/simulation/index.ts
autonomous: true
must_haves:
  - SimulationTrigger button triggers full day simulation
  - SimulationReport groups issues by severity (critical first)
  - SimulationIssueCard shows one-click fix action when available
  - useSimulation hook provides mutation for running simulation
  - Loading state shown during simulation run
  - RTL Hebrew UI throughout
  - lucide-react icons for severity indicators
---

# Phase 9 Plan 4: Simulation UI & Hooks

## Objective

Build the frontend components for triggering and displaying simulation results, including the trigger button, report display, issue cards with fix actions, and React Query hook.

## Context

**From CONTEXT.md:**
- Trigger via dedicated button on event detail page
- Report grouped by severity (critical issues first, then warnings, then info)
- Full context per issue: problem description + affected entities + link to schedule item + one-click fix action
- Critical issues warn strongly but allow manager to override (no hard blocking)

**From RESEARCH.md:**
- severityConfig with colors and Hebrew labels
- lucide-react icons (AlertTriangle, AlertCircle, Info)
- useMutation from @tanstack/react-query for simulation trigger

## Tasks

<task id="1" name="create-simulation-hook">
### Task 1: Create useSimulation Hook

React Query hook for triggering simulation and managing state.

**File:** `src/modules/simulation/hooks/useSimulation.ts`

```typescript
import { useMutation } from '@tanstack/react-query'
import { useSupabaseClient } from '@supabase/auth-helpers-react'
import { runSimulation } from '../services'
import type { SimulationResult } from '../types'

interface UseSimulationOptions {
  onSuccess?: (result: SimulationResult) => void
  onError?: (error: Error) => void
}

/**
 * Hook for running day simulation.
 * Returns mutation for triggering simulation + result state.
 */
export function useSimulation(eventId: string, options?: UseSimulationOptions) {
  const supabase = useSupabaseClient()

  const mutation = useMutation({
    mutationKey: ['simulation', eventId],
    mutationFn: async () => {
      return runSimulation(supabase, eventId)
    },
    onSuccess: (data) => {
      options?.onSuccess?.(data)
    },
    onError: (error) => {
      console.error('Simulation failed:', error)
      options?.onError?.(error as Error)
    },
  })

  return {
    // Mutation controls
    runSimulation: mutation.mutate,
    runSimulationAsync: mutation.mutateAsync,
    reset: mutation.reset,

    // State
    isLoading: mutation.isPending,
    isError: mutation.isError,
    error: mutation.error,

    // Result
    result: mutation.data,
    hasResult: !!mutation.data,

    // Summary helpers
    hasCriticalIssues: (mutation.data?.critical ?? 0) > 0,
    hasWarnings: (mutation.data?.warnings ?? 0) > 0,
    totalIssues: mutation.data?.total_issues ?? 0,
  }
}
```

**File:** `src/modules/simulation/hooks/index.ts`

```typescript
export { useSimulation } from './useSimulation'
```
</task>

<task id="2" name="create-simulation-summary">
### Task 2: Create SimulationSummary Component

Displays summary counts at the top of the report.

**File:** `src/modules/simulation/components/SimulationSummary.tsx`

```typescript
import { AlertTriangle, AlertCircle, Info, CheckCircle } from 'lucide-react'

interface SimulationSummaryProps {
  total: number
  critical: number
  warnings: number
  info: number
  durationMs?: number
}

export function SimulationSummary({
  total,
  critical,
  warnings,
  info,
  durationMs,
}: SimulationSummaryProps) {
  if (total === 0) {
    return (
      <div className="bg-green-50 border border-green-200 rounded-lg p-4 flex items-center gap-3">
        <CheckCircle className="h-6 w-6 text-green-500 flex-shrink-0" />
        <div>
          <h3 className="font-medium text-green-800">הכל תקין!</h3>
          <p className="text-sm text-green-600">
            לא נמצאו בעיות בסימולציית יום האירוע
            {durationMs && ` (${durationMs}ms)`}
          </p>
        </div>
      </div>
    )
  }

  return (
    <div className="bg-white border border-gray-200 rounded-lg p-4">
      <div className="flex items-center justify-between mb-3">
        <h3 className="font-medium text-gray-900">
          נמצאו {total} בעיות
        </h3>
        {durationMs && (
          <span className="text-xs text-gray-400">
            {durationMs}ms
          </span>
        )}
      </div>

      <div className="grid grid-cols-3 gap-3">
        {/* Critical */}
        <div className="bg-red-50 border border-red-200 rounded-lg p-3 text-center">
          <div className="flex items-center justify-center gap-1 mb-1">
            <AlertTriangle className="h-4 w-4 text-red-500" />
            <span className="text-2xl font-bold text-red-700">{critical}</span>
          </div>
          <span className="text-xs text-red-600">קריטי</span>
        </div>

        {/* Warnings */}
        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-center">
          <div className="flex items-center justify-center gap-1 mb-1">
            <AlertCircle className="h-4 w-4 text-yellow-500" />
            <span className="text-2xl font-bold text-yellow-700">{warnings}</span>
          </div>
          <span className="text-xs text-yellow-600">אזהרות</span>
        </div>

        {/* Info */}
        <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-center">
          <div className="flex items-center justify-center gap-1 mb-1">
            <Info className="h-4 w-4 text-blue-500" />
            <span className="text-2xl font-bold text-blue-700">{info}</span>
          </div>
          <span className="text-xs text-blue-600">מידע</span>
        </div>
      </div>
    </div>
  )
}
```
</task>

<task id="3" name="create-simulation-issue-card">
### Task 3: Create SimulationIssueCard Component

Displays a single issue with context and fix action.

**File:** `src/modules/simulation/components/SimulationIssueCard.tsx`

```typescript
import { AlertTriangle, AlertCircle, Info, ChevronLeft, Wrench } from 'lucide-react'
import type { SimulationIssue, SuggestedFix } from '../types'
import { severityConfig } from '../types'

interface SimulationIssueCardProps {
  issue: SimulationIssue
  onFixClick?: (fix: SuggestedFix) => void
  onScheduleClick?: (scheduleId: string) => void
}

const severityIcons = {
  critical: AlertTriangle,
  warning: AlertCircle,
  info: Info,
}

export function SimulationIssueCard({
  issue,
  onFixClick,
  onScheduleClick,
}: SimulationIssueCardProps) {
  const config = severityConfig[issue.severity]
  const Icon = severityIcons[issue.severity]

  return (
    <div
      className={`border rounded-lg p-4 ${config.bgColor} ${config.borderColor}`}
    >
      {/* Header */}
      <div className="flex items-start gap-3">
        <Icon className={`h-5 w-5 flex-shrink-0 mt-0.5 ${config.iconColor}`} />
        <div className="flex-1 min-w-0">
          <h4 className={`font-medium ${config.textColor}`}>
            {issue.title}
          </h4>
          <p className="text-sm text-gray-600 mt-1">
            {issue.description}
          </p>
        </div>
      </div>

      {/* Affected entities links */}
      {issue.affectedEntities.schedule_ids && issue.affectedEntities.schedule_ids.length > 0 && (
        <div className="mt-3 flex flex-wrap gap-2">
          {issue.affectedEntities.schedule_ids.map((scheduleId) => (
            <button
              key={scheduleId}
              onClick={() => onScheduleClick?.(scheduleId)}
              className="inline-flex items-center gap-1 text-xs text-gray-500 hover:text-gray-700 underline"
            >
              <ChevronLeft className="h-3 w-3" />
              עבור לסשן
            </button>
          ))}
        </div>
      )}

      {/* Fix action */}
      {issue.suggestedFix && onFixClick && (
        <div className="mt-3 pt-3 border-t border-gray-200">
          <button
            onClick={() => onFixClick(issue.suggestedFix!)}
            className={`
              inline-flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium
              bg-white border border-gray-300 text-gray-700
              hover:bg-gray-50 hover:border-gray-400
              transition-colors
            `}
          >
            <Wrench className="h-4 w-4" />
            {issue.suggestedFix.label}
          </button>
        </div>
      )}
    </div>
  )
}
```
</task>

<task id="4" name="create-issue-section">
### Task 4: Create IssueSection Component

Groups issues by severity with expandable section.

**File:** `src/modules/simulation/components/IssueSection.tsx`

```typescript
import { useState } from 'react'
import { ChevronDown, ChevronUp } from 'lucide-react'
import type { SimulationIssue, SuggestedFix } from '../types'
import { severityConfig } from '../types'
import { SimulationIssueCard } from './SimulationIssueCard'

interface IssueSectionProps {
  severity: 'critical' | 'warning' | 'info'
  issues: SimulationIssue[]
  onFixClick?: (fix: SuggestedFix) => void
  onScheduleClick?: (scheduleId: string) => void
  defaultExpanded?: boolean
}

export function IssueSection({
  severity,
  issues,
  onFixClick,
  onScheduleClick,
  defaultExpanded = true,
}: IssueSectionProps) {
  const [isExpanded, setIsExpanded] = useState(defaultExpanded)
  const config = severityConfig[severity]

  if (issues.length === 0) return null

  return (
    <div className="border rounded-lg overflow-hidden">
      {/* Section header */}
      <button
        onClick={() => setIsExpanded(!isExpanded)}
        className={`
          w-full flex items-center justify-between p-3
          ${config.bgColor} ${config.borderColor} border-b
        `}
      >
        <div className="flex items-center gap-2">
          <span className={`font-medium ${config.textColor}`}>
            {config.label}
          </span>
          <span className={`
            px-2 py-0.5 rounded-full text-xs font-medium
            ${config.bgColor} ${config.textColor}
          `}>
            {issues.length}
          </span>
        </div>
        {isExpanded ? (
          <ChevronUp className="h-4 w-4 text-gray-500" />
        ) : (
          <ChevronDown className="h-4 w-4 text-gray-500" />
        )}
      </button>

      {/* Section description */}
      {isExpanded && (
        <div className="p-2 bg-gray-50 border-b border-gray-200">
          <p className="text-xs text-gray-500">{config.description}</p>
        </div>
      )}

      {/* Issues list */}
      {isExpanded && (
        <div className="p-3 space-y-3 bg-white">
          {issues.map((issue) => (
            <SimulationIssueCard
              key={issue.id}
              issue={issue}
              onFixClick={onFixClick}
              onScheduleClick={onScheduleClick}
            />
          ))}
        </div>
      )}
    </div>
  )
}
```
</task>

<task id="5" name="create-simulation-report">
### Task 5: Create SimulationReport Component

Main report component that combines summary and issue sections.

**File:** `src/modules/simulation/components/SimulationReport.tsx`

```typescript
import type { SimulationResult, SuggestedFix } from '../types'
import { groupIssuesBySeverity } from '../services'
import { SimulationSummary } from './SimulationSummary'
import { IssueSection } from './IssueSection'

interface SimulationReportProps {
  result: SimulationResult
  onFixClick?: (fix: SuggestedFix) => void
  onScheduleClick?: (scheduleId: string) => void
}

export function SimulationReport({
  result,
  onFixClick,
  onScheduleClick,
}: SimulationReportProps) {
  const grouped = groupIssuesBySeverity(result.issues)

  return (
    <div className="space-y-4" dir="rtl">
      {/* Summary */}
      <SimulationSummary
        total={result.total_issues}
        critical={result.critical}
        warnings={result.warnings}
        info={result.info}
        durationMs={result.duration_ms}
      />

      {/* Issues by severity */}
      <div className="space-y-4">
        <IssueSection
          severity="critical"
          issues={grouped.critical}
          onFixClick={onFixClick}
          onScheduleClick={onScheduleClick}
          defaultExpanded={true}
        />
        <IssueSection
          severity="warning"
          issues={grouped.warning}
          onFixClick={onFixClick}
          onScheduleClick={onScheduleClick}
          defaultExpanded={grouped.critical.length === 0}
        />
        <IssueSection
          severity="info"
          issues={grouped.info}
          onFixClick={onFixClick}
          onScheduleClick={onScheduleClick}
          defaultExpanded={grouped.critical.length === 0 && grouped.warning.length === 0}
        />
      </div>

      {/* Run timestamp */}
      <div className="text-xs text-gray-400 text-center">
        סימולציה בוצעה: {new Date(result.run_at).toLocaleString('he-IL')}
      </div>
    </div>
  )
}
```
</task>

<task id="6" name="create-simulation-trigger">
### Task 6: Create SimulationTrigger Component

Button that triggers simulation with loading state.

**File:** `src/modules/simulation/components/SimulationTrigger.tsx`

```typescript
import { Play, Loader2, RefreshCw } from 'lucide-react'
import { useSimulation } from '../hooks'
import { SimulationReport } from './SimulationReport'
import type { SuggestedFix } from '../types'

interface SimulationTriggerProps {
  eventId: string
  onFixClick?: (fix: SuggestedFix) => void
  onScheduleClick?: (scheduleId: string) => void
}

export function SimulationTrigger({
  eventId,
  onFixClick,
  onScheduleClick,
}: SimulationTriggerProps) {
  const {
    runSimulation,
    isLoading,
    isError,
    error,
    result,
    hasResult,
    hasCriticalIssues,
  } = useSimulation(eventId)

  return (
    <div className="space-y-4" dir="rtl">
      {/* Header with trigger button */}
      <div className="flex items-center justify-between">
        <div>
          <h3 className="text-lg font-medium text-gray-900">
            סימולציית יום האירוע
          </h3>
          <p className="text-sm text-gray-500">
            בדיקה מקיפה לזיהוי בעיות פוטנציאליות לפני האירוע
          </p>
        </div>

        <button
          onClick={() => runSimulation()}
          disabled={isLoading}
          className={`
            inline-flex items-center gap-2 px-4 py-2 rounded-lg
            font-medium text-sm transition-colors
            ${isLoading
              ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
              : hasResult
                ? 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                : 'bg-blue-600 text-white hover:bg-blue-700'
            }
          `}
        >
          {isLoading ? (
            <>
              <Loader2 className="h-4 w-4 animate-spin" />
              מריץ סימולציה...
            </>
          ) : hasResult ? (
            <>
              <RefreshCw className="h-4 w-4" />
              הרץ שוב
            </>
          ) : (
            <>
              <Play className="h-4 w-4" />
              הרץ סימולציה
            </>
          )}
        </button>
      </div>

      {/* Error state */}
      {isError && (
        <div className="bg-red-50 border border-red-200 rounded-lg p-4">
          <p className="text-sm text-red-700">
            שגיאה בהרצת הסימולציה: {error?.message || 'שגיאה לא ידועה'}
          </p>
        </div>
      )}

      {/* Critical issues warning banner */}
      {hasResult && hasCriticalIssues && (
        <div className="bg-red-50 border border-red-300 rounded-lg p-4 flex items-start gap-3">
          <div className="flex-shrink-0 w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
            <span className="text-xl">!</span>
          </div>
          <div>
            <h4 className="font-medium text-red-800">נמצאו בעיות קריטיות</h4>
            <p className="text-sm text-red-700 mt-1">
              מומלץ לטפל בבעיות הקריטיות לפני יום האירוע.
              ניתן להמשיך, אבל ייתכנו בעיות במהלך האירוע.
            </p>
          </div>
        </div>
      )}

      {/* Results */}
      {hasResult && result && (
        <SimulationReport
          result={result}
          onFixClick={onFixClick}
          onScheduleClick={onScheduleClick}
        />
      )}
    </div>
  )
}
```
</task>

<task id="7" name="create-components-index">
### Task 7: Create Module Index Files

Export all components and hooks from module entry points.

**File:** `src/modules/simulation/components/index.ts`

```typescript
export { SimulationTrigger } from './SimulationTrigger'
export { SimulationReport } from './SimulationReport'
export { SimulationSummary } from './SimulationSummary'
export { SimulationIssueCard } from './SimulationIssueCard'
export { IssueSection } from './IssueSection'
```

**File:** `src/modules/simulation/index.ts`

```typescript
// Types
export * from './types'

// Services
export * from './services'

// Hooks
export * from './hooks'

// Components
export * from './components'
```
</task>

## Verification

After completing all tasks:

1. **Components render correctly:**
   - SimulationTrigger shows button that triggers simulation
   - Loading state displayed during simulation
   - SimulationReport groups issues by severity
   - SimulationIssueCard shows fix action when available

2. **RTL Hebrew UI:**
   - dir="rtl" applied to containers
   - Hebrew labels throughout
   - Icons positioned correctly for RTL

3. **Hook works correctly:**
   - useSimulation returns mutation controls and state
   - hasCriticalIssues helper works correctly

4. **TypeScript compiles:**
   - Run `npx tsc --noEmit` from eventflow-app directory
   - All imports resolve correctly

## Files Created

- `eventflow-app/src/modules/simulation/hooks/useSimulation.ts`
- `eventflow-app/src/modules/simulation/hooks/index.ts`
- `eventflow-app/src/modules/simulation/components/SimulationSummary.tsx`
- `eventflow-app/src/modules/simulation/components/SimulationIssueCard.tsx`
- `eventflow-app/src/modules/simulation/components/IssueSection.tsx`
- `eventflow-app/src/modules/simulation/components/SimulationReport.tsx`
- `eventflow-app/src/modules/simulation/components/SimulationTrigger.tsx`
- `eventflow-app/src/modules/simulation/components/index.ts`
- `eventflow-app/src/modules/simulation/index.ts`

## Dependencies

- **09-02**: Simulation services (runSimulation, groupIssuesBySeverity)
- **09-01**: Simulation types (SimulationResult, SimulationIssue, etc.)

## Next Plans

- **09-06**: Integrates SimulationTrigger into EventDetailPage
