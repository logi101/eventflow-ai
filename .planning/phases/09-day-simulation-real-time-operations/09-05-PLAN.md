---
phase: 09-day-simulation-real-time-operations
plan: 05
title: Contingency UI & Hooks
type: feature
wave: 3
depends_on: [09-03]
files_modified:
  - eventflow-app/src/modules/contingency/components/ContingencyPanel.tsx
  - eventflow-app/src/modules/contingency/components/ImpactPreview.tsx
  - eventflow-app/src/modules/contingency/components/ContingencyHistory.tsx
  - eventflow-app/src/modules/contingency/components/BackupSpeakerSelector.tsx
  - eventflow-app/src/modules/contingency/components/ContingencyConfirmDialog.tsx
  - eventflow-app/src/modules/contingency/components/index.ts
  - eventflow-app/src/modules/contingency/hooks/useContingency.ts
  - eventflow-app/src/modules/contingency/hooks/useContingencyHistory.ts
  - eventflow-app/src/modules/contingency/hooks/index.ts
  - eventflow-app/src/modules/contingency/index.ts
autonomous: true
must_haves:
  - ContingencyPanel allows selecting backup speaker from dropdown
  - ImpactPreview shows affected participants and VIP count before confirmation
  - ContingencyConfirmDialog follows Phase 6 suggest+confirm pattern
  - ContingencyHistory displays audit log with status badges
  - useContingency hook provides suggest/execute/reject mutations
  - useContingencyHistory hook queries audit log
  - RTL Hebrew UI throughout
---

# Phase 9 Plan 5: Contingency UI & Hooks

## Objective

Build the frontend components for contingency activation, including backup speaker selection, impact preview, confirmation dialog, and audit history display.

## Context

**From CONTEXT.md:**
- Pre-assigned backup speakers per session + ability to pick anyone ad-hoc
- AI suggests changes, manager approves (follows Phase 6 suggest+confirm pattern)
- Full audit log: who activated, when, what changed, reason for change

**From Phase 6:**
- AIConfirmationDialog pattern: preview changes, show conflicts, approve/reject
- Risk-based UI with color coding
- Approve button disabled when critical issues exist

**From RESEARCH.md:**
- ContingencyPanel for backup speaker selection
- ImpactPreview for affected participants preview
- ContingencyHistory for audit log display

## Tasks

<task id="1" name="create-contingency-hooks">
### Task 1: Create Contingency Hooks

React Query hooks for contingency operations and history.

**File:** `src/modules/contingency/hooks/useContingency.ts`

```typescript
import { useMutation, useQueryClient } from '@tanstack/react-query'
import { useSupabaseClient, useUser } from '@supabase/auth-helpers-react'
import {
  suggestContingencyAction,
  executeContingencyAction,
  rejectContingencyAction,
} from '../services'
import type {
  ContingencyActionType,
  ContingencyActionData,
  ContingencySuggestion,
  ContingencyExecutionResult,
} from '../types'

interface UseContingencyOptions {
  eventId: string
  onSuggestSuccess?: (suggestion: ContingencySuggestion) => void
  onExecuteSuccess?: (result: ContingencyExecutionResult) => void
  onError?: (error: Error) => void
}

/**
 * Hook for contingency suggest/execute/reject operations.
 */
export function useContingency({
  eventId,
  onSuggestSuccess,
  onExecuteSuccess,
  onError,
}: UseContingencyOptions) {
  const supabase = useSupabaseClient()
  const user = useUser()
  const queryClient = useQueryClient()

  // Suggest mutation
  const suggestMutation = useMutation({
    mutationKey: ['contingency', 'suggest', eventId],
    mutationFn: async ({
      actionType,
      actionData,
      reason,
    }: {
      actionType: ContingencyActionType
      actionData: ContingencyActionData
      reason: string
    }) => {
      if (!user?.id) throw new Error('User not authenticated')
      return suggestContingencyAction(
        supabase,
        eventId,
        actionType,
        actionData,
        reason,
        user.id
      )
    },
    onSuccess: (data) => {
      onSuggestSuccess?.(data)
    },
    onError: (error) => {
      console.error('Suggest contingency failed:', error)
      onError?.(error as Error)
    },
  })

  // Execute mutation
  const executeMutation = useMutation({
    mutationKey: ['contingency', 'execute', eventId],
    mutationFn: async (actionId: string) => {
      if (!user?.id) throw new Error('User not authenticated')
      return executeContingencyAction(supabase, actionId, user.id)
    },
    onSuccess: (data) => {
      // Invalidate related queries
      queryClient.invalidateQueries({ queryKey: ['schedules', eventId] })
      queryClient.invalidateQueries({ queryKey: ['contingency-history', eventId] })
      onExecuteSuccess?.(data)
    },
    onError: (error) => {
      console.error('Execute contingency failed:', error)
      onError?.(error as Error)
    },
  })

  // Reject mutation
  const rejectMutation = useMutation({
    mutationKey: ['contingency', 'reject', eventId],
    mutationFn: async ({
      actionId,
      reason,
    }: {
      actionId: string
      reason?: string
    }) => {
      if (!user?.id) throw new Error('User not authenticated')
      return rejectContingencyAction(supabase, actionId, user.id, reason)
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['contingency-history', eventId] })
    },
    onError: (error) => {
      console.error('Reject contingency failed:', error)
      onError?.(error as Error)
    },
  })

  return {
    // Suggest
    suggest: suggestMutation.mutate,
    suggestAsync: suggestMutation.mutateAsync,
    isSuggesting: suggestMutation.isPending,
    suggestion: suggestMutation.data,

    // Execute
    execute: executeMutation.mutate,
    executeAsync: executeMutation.mutateAsync,
    isExecuting: executeMutation.isPending,
    executionResult: executeMutation.data,

    // Reject
    reject: rejectMutation.mutate,
    rejectAsync: rejectMutation.mutateAsync,
    isRejecting: rejectMutation.isPending,

    // Reset
    reset: () => {
      suggestMutation.reset()
      executeMutation.reset()
      rejectMutation.reset()
    },

    // Combined loading state
    isLoading: suggestMutation.isPending || executeMutation.isPending || rejectMutation.isPending,
  }
}
```

**File:** `src/modules/contingency/hooks/useContingencyHistory.ts`

```typescript
import { useQuery } from '@tanstack/react-query'
import { useSupabaseClient } from '@supabase/auth-helpers-react'
import { getContingencyHistory } from '../services'
import type { AuditEntry } from '../types'

interface UseContingencyHistoryOptions {
  eventId: string
  enabled?: boolean
}

/**
 * Hook for fetching contingency audit history.
 */
export function useContingencyHistory({
  eventId,
  enabled = true,
}: UseContingencyHistoryOptions) {
  const supabase = useSupabaseClient()

  const query = useQuery({
    queryKey: ['contingency-history', eventId],
    queryFn: async () => {
      return getContingencyHistory(supabase, eventId)
    },
    enabled,
    staleTime: 30 * 1000, // 30 seconds
  })

  return {
    history: query.data ?? [],
    isLoading: query.isLoading,
    isError: query.isError,
    error: query.error,
    refetch: query.refetch,

    // Helpers
    hasHistory: (query.data?.length ?? 0) > 0,
    executedCount: query.data?.filter(a => a.execution_status === 'executed').length ?? 0,
    pendingCount: query.data?.filter(a => a.execution_status === 'suggested').length ?? 0,
  }
}
```

**File:** `src/modules/contingency/hooks/index.ts`

```typescript
export { useContingency } from './useContingency'
export { useContingencyHistory } from './useContingencyHistory'
```
</task>

<task id="2" name="create-impact-preview">
### Task 2: Create ImpactPreview Component

Shows affected participants before confirmation.

**File:** `src/modules/contingency/components/ImpactPreview.tsx`

```typescript
import { Users, Star, Bell, AlertTriangle } from 'lucide-react'
import type { ImpactSummary } from '../types'

interface ImpactPreviewProps {
  impact: ImpactSummary
  showWarning?: boolean
}

export function ImpactPreview({ impact, showWarning = true }: ImpactPreviewProps) {
  const hasVIPs = (impact.vip_affected ?? 0) > 0

  return (
    <div className="space-y-3" dir="rtl">
      {/* Warning banner for VIPs */}
      {showWarning && hasVIPs && (
        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 flex items-start gap-2">
          <AlertTriangle className="h-4 w-4 text-yellow-500 flex-shrink-0 mt-0.5" />
          <p className="text-sm text-yellow-700">
            שינוי זה ישפיע על {impact.vip_affected} משתתפי VIP
          </p>
        </div>
      )}

      {/* Impact stats */}
      <div className="grid grid-cols-2 gap-3">
        {/* Affected participants */}
        <div className="bg-gray-50 rounded-lg p-3">
          <div className="flex items-center gap-2 text-gray-600 mb-1">
            <Users className="h-4 w-4" />
            <span className="text-xs">משתתפים מושפעים</span>
          </div>
          <span className="text-xl font-bold text-gray-900">
            {impact.affected_participants}
          </span>
        </div>

        {/* VIPs affected */}
        <div className="bg-purple-50 rounded-lg p-3">
          <div className="flex items-center gap-2 text-purple-600 mb-1">
            <Star className="h-4 w-4" />
            <span className="text-xs">VIP מושפעים</span>
          </div>
          <span className="text-xl font-bold text-purple-700">
            {impact.vip_affected ?? 0}
          </span>
        </div>

        {/* Notifications to send */}
        <div className="bg-blue-50 rounded-lg p-3 col-span-2">
          <div className="flex items-center gap-2 text-blue-600 mb-1">
            <Bell className="h-4 w-4" />
            <span className="text-xs">הודעות WhatsApp שיישלחו</span>
          </div>
          <span className="text-xl font-bold text-blue-700">
            {impact.affected_participants}
          </span>
        </div>
      </div>

      {/* Affected sessions */}
      {impact.affected_sessions.length > 0 && (
        <div className="text-xs text-gray-500">
          סשנים מושפעים: {impact.affected_sessions.length}
        </div>
      )}
    </div>
  )
}
```
</task>

<task id="3" name="create-backup-speaker-selector">
### Task 3: Create BackupSpeakerSelector Component

Dropdown for selecting backup speaker.

**File:** `src/modules/contingency/components/BackupSpeakerSelector.tsx`

```typescript
import { useState, useEffect } from 'react'
import { useQuery } from '@tanstack/react-query'
import { useSupabaseClient } from '@supabase/auth-helpers-react'
import { User, ChevronDown, Check } from 'lucide-react'

interface Speaker {
  id: string
  name: string
  email: string | null
  phone: string | null
}

interface BackupSpeakerSelectorProps {
  eventId: string
  currentSpeakerId?: string
  preassignedBackupId?: string
  onSelect: (speaker: Speaker) => void
  selectedSpeakerId?: string
}

export function BackupSpeakerSelector({
  eventId,
  currentSpeakerId,
  preassignedBackupId,
  onSelect,
  selectedSpeakerId,
}: BackupSpeakerSelectorProps) {
  const supabase = useSupabaseClient()
  const [isOpen, setIsOpen] = useState(false)

  // Fetch all speakers for this event
  const { data: speakers = [], isLoading } = useQuery({
    queryKey: ['speakers', eventId],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('speakers')
        .select('id, name, email, phone')
        .eq('event_id', eventId)
        .order('name')

      if (error) throw error
      return data as Speaker[]
    },
  })

  // Filter out current speaker
  const availableSpeakers = speakers.filter(s => s.id !== currentSpeakerId)

  // Find selected speaker
  const selectedSpeaker = speakers.find(s => s.id === selectedSpeakerId)

  // Find preassigned backup
  const preassignedBackup = speakers.find(s => s.id === preassignedBackupId)

  return (
    <div className="relative" dir="rtl">
      <label className="block text-sm font-medium text-gray-700 mb-1">
        בחר דובר חלופי
      </label>

      {/* Dropdown trigger */}
      <button
        type="button"
        onClick={() => setIsOpen(!isOpen)}
        className={`
          w-full flex items-center justify-between px-3 py-2 border rounded-lg
          bg-white text-right
          ${selectedSpeaker ? 'border-blue-300' : 'border-gray-300'}
          hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500
        `}
      >
        <div className="flex items-center gap-2">
          <User className="h-4 w-4 text-gray-400" />
          <span className={selectedSpeaker ? 'text-gray-900' : 'text-gray-500'}>
            {selectedSpeaker?.name || 'בחר דובר...'}
          </span>
        </div>
        <ChevronDown className={`h-4 w-4 text-gray-400 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
      </button>

      {/* Dropdown menu */}
      {isOpen && (
        <div className="absolute z-10 mt-1 w-full bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-auto">
          {isLoading ? (
            <div className="p-3 text-center text-gray-500">טוען...</div>
          ) : availableSpeakers.length === 0 ? (
            <div className="p-3 text-center text-gray-500">אין דוברים זמינים</div>
          ) : (
            <>
              {/* Preassigned backup first (if exists) */}
              {preassignedBackup && (
                <>
                  <div className="px-3 py-1 text-xs text-gray-500 bg-gray-50">
                    דובר חלופי מוגדר מראש
                  </div>
                  <button
                    type="button"
                    onClick={() => {
                      onSelect(preassignedBackup)
                      setIsOpen(false)
                    }}
                    className={`
                      w-full flex items-center justify-between px-3 py-2 text-right
                      hover:bg-blue-50
                      ${selectedSpeakerId === preassignedBackup.id ? 'bg-blue-50' : ''}
                    `}
                  >
                    <div>
                      <div className="font-medium text-gray-900">{preassignedBackup.name}</div>
                      {preassignedBackup.email && (
                        <div className="text-xs text-gray-500">{preassignedBackup.email}</div>
                      )}
                    </div>
                    {selectedSpeakerId === preassignedBackup.id && (
                      <Check className="h-4 w-4 text-blue-600" />
                    )}
                  </button>
                  <div className="border-t border-gray-200" />
                </>
              )}

              {/* Other speakers */}
              <div className="px-3 py-1 text-xs text-gray-500 bg-gray-50">
                כל הדוברים
              </div>
              {availableSpeakers
                .filter(s => s.id !== preassignedBackupId)
                .map((speaker) => (
                  <button
                    key={speaker.id}
                    type="button"
                    onClick={() => {
                      onSelect(speaker)
                      setIsOpen(false)
                    }}
                    className={`
                      w-full flex items-center justify-between px-3 py-2 text-right
                      hover:bg-blue-50
                      ${selectedSpeakerId === speaker.id ? 'bg-blue-50' : ''}
                    `}
                  >
                    <div>
                      <div className="font-medium text-gray-900">{speaker.name}</div>
                      {speaker.email && (
                        <div className="text-xs text-gray-500">{speaker.email}</div>
                      )}
                    </div>
                    {selectedSpeakerId === speaker.id && (
                      <Check className="h-4 w-4 text-blue-600" />
                    )}
                  </button>
                ))}
            </>
          )}
        </div>
      )}

      {/* Click outside handler */}
      {isOpen && (
        <div
          className="fixed inset-0 z-0"
          onClick={() => setIsOpen(false)}
        />
      )}
    </div>
  )
}
```
</task>

<task id="4" name="create-contingency-confirm-dialog">
### Task 4: Create ContingencyConfirmDialog Component

Confirmation dialog following Phase 6 suggest+confirm pattern.

**File:** `src/modules/contingency/components/ContingencyConfirmDialog.tsx`

```typescript
import { X, AlertTriangle, Loader2, Check, XCircle } from 'lucide-react'
import { motion, AnimatePresence } from 'framer-motion'
import type { ContingencySuggestion } from '../types'
import { actionTypeLabels } from '../types'
import { ImpactPreview } from './ImpactPreview'

interface ContingencyConfirmDialogProps {
  isOpen: boolean
  suggestion: ContingencySuggestion | null
  onApprove: () => void
  onReject: () => void
  onClose: () => void
  isExecuting?: boolean
}

export function ContingencyConfirmDialog({
  isOpen,
  suggestion,
  onApprove,
  onReject,
  onClose,
  isExecuting = false,
}: ContingencyConfirmDialogProps) {
  if (!suggestion) return null

  const hasVIPImpact = (suggestion.impact.vip_affected ?? 0) > 0

  return (
    <AnimatePresence>
      {isOpen && (
        <>
          {/* Backdrop */}
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 bg-black/50 z-40"
            onClick={onClose}
          />

          {/* Dialog */}
          <motion.div
            initial={{ opacity: 0, scale: 0.95 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 0.95 }}
            className="fixed inset-0 z-50 flex items-center justify-center p-4"
          >
            <div
              className="bg-white rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-auto"
              dir="rtl"
              onClick={(e) => e.stopPropagation()}
            >
              {/* Header */}
              <div className="flex items-center justify-between p-4 border-b">
                <h2 className="text-lg font-semibold text-gray-900">
                  אישור פעולה
                </h2>
                <button
                  onClick={onClose}
                  className="p-1 rounded-lg hover:bg-gray-100"
                  disabled={isExecuting}
                >
                  <X className="h-5 w-5 text-gray-500" />
                </button>
              </div>

              {/* Content */}
              <div className="p-4 space-y-4">
                {/* Action type badge */}
                <div className="flex items-center gap-2">
                  <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded-md text-sm font-medium">
                    {actionTypeLabels[suggestion.type]}
                  </span>
                </div>

                {/* Action label */}
                <div className="bg-gray-50 rounded-lg p-3">
                  <p className="font-medium text-gray-900">{suggestion.label}</p>
                  {suggestion.reason && (
                    <p className="text-sm text-gray-600 mt-1">
                      סיבה: {suggestion.reason}
                    </p>
                  )}
                </div>

                {/* Impact preview */}
                <ImpactPreview impact={suggestion.impact} />

                {/* VIP warning */}
                {hasVIPImpact && (
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 flex items-start gap-2">
                    <AlertTriangle className="h-5 w-5 text-yellow-500 flex-shrink-0 mt-0.5" />
                    <div>
                      <p className="font-medium text-yellow-800">השפעה על VIP</p>
                      <p className="text-sm text-yellow-700">
                        שינוי זה ישפיע על {suggestion.impact.vip_affected} משתתפי VIP.
                        ודא שזו הפעולה הנכונה.
                      </p>
                    </div>
                  </div>
                )}
              </div>

              {/* Actions */}
              <div className="flex gap-3 p-4 border-t bg-gray-50">
                <button
                  onClick={onReject}
                  disabled={isExecuting}
                  className="flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 disabled:opacity-50"
                >
                  <XCircle className="h-4 w-4" />
                  ביטול
                </button>
                <button
                  onClick={onApprove}
                  disabled={isExecuting}
                  className="flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50"
                >
                  {isExecuting ? (
                    <>
                      <Loader2 className="h-4 w-4 animate-spin" />
                      מבצע...
                    </>
                  ) : (
                    <>
                      <Check className="h-4 w-4" />
                      אשר ובצע
                    </>
                  )}
                </button>
              </div>
            </div>
          </motion.div>
        </>
      )}
    </AnimatePresence>
  )
}
```
</task>

<task id="5" name="create-contingency-history">
### Task 5: Create ContingencyHistory Component

Displays audit log with status badges.

**File:** `src/modules/contingency/components/ContingencyHistory.tsx`

```typescript
import { History, User, Clock, CheckCircle, XCircle, AlertCircle, Loader2 } from 'lucide-react'
import type { AuditEntry } from '../types'
import { actionTypeLabels, statusLabels, statusColors } from '../types'

interface ContingencyHistoryProps {
  history: AuditEntry[]
  isLoading?: boolean
}

export function ContingencyHistory({ history, isLoading }: ContingencyHistoryProps) {
  if (isLoading) {
    return (
      <div className="flex items-center justify-center p-8">
        <Loader2 className="h-6 w-6 animate-spin text-gray-400" />
      </div>
    )
  }

  if (history.length === 0) {
    return (
      <div className="text-center p-8 text-gray-500">
        <History className="h-8 w-8 mx-auto mb-2 opacity-50" />
        <p>אין היסטוריית פעולות</p>
      </div>
    )
  }

  return (
    <div className="space-y-3" dir="rtl">
      <h3 className="font-medium text-gray-900 flex items-center gap-2">
        <History className="h-4 w-4" />
        היסטוריית פעולות
      </h3>

      <div className="space-y-2">
        {history.map((entry) => (
          <ContingencyHistoryItem key={entry.id} entry={entry} />
        ))}
      </div>
    </div>
  )
}

function ContingencyHistoryItem({ entry }: { entry: AuditEntry }) {
  const statusConfig = statusColors[entry.execution_status]
  const StatusIcon = getStatusIcon(entry.execution_status)

  return (
    <div className="bg-white border border-gray-200 rounded-lg p-3">
      {/* Header */}
      <div className="flex items-start justify-between">
        <div className="flex items-center gap-2">
          <span className="text-sm font-medium text-gray-900">
            {actionTypeLabels[entry.action_type as keyof typeof actionTypeLabels] || entry.action_type}
          </span>
          <span className={`
            inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium
            ${statusConfig.bg} ${statusConfig.text}
          `}>
            <StatusIcon className="h-3 w-3" />
            {statusLabels[entry.execution_status]}
          </span>
        </div>
      </div>

      {/* Action details */}
      <p className="text-sm text-gray-600 mt-1">
        {entry.action_data.schedule_title}
      </p>

      {/* Reason */}
      {entry.reason && (
        <p className="text-xs text-gray-500 mt-1">
          סיבה: {entry.reason}
        </p>
      )}

      {/* Impact summary */}
      {entry.impact_summary && entry.execution_status === 'executed' && (
        <div className="flex gap-4 mt-2 text-xs text-gray-500">
          <span>משתתפים: {entry.impact_summary.affected_participants}</span>
          <span>הודעות: {entry.impact_summary.notifications_sent}</span>
          {(entry.impact_summary.vip_affected ?? 0) > 0 && (
            <span className="text-purple-600">VIP: {entry.impact_summary.vip_affected}</span>
          )}
        </div>
      )}

      {/* Error message */}
      {entry.error_message && (
        <p className="text-xs text-red-600 mt-1">
          שגיאה: {entry.error_message}
        </p>
      )}

      {/* Metadata */}
      <div className="flex items-center gap-4 mt-2 text-xs text-gray-400">
        <span className="flex items-center gap-1">
          <Clock className="h-3 w-3" />
          {new Date(entry.suggested_at).toLocaleString('he-IL')}
        </span>
        {entry.executed_at && (
          <span className="flex items-center gap-1">
            <CheckCircle className="h-3 w-3" />
            בוצע: {new Date(entry.executed_at).toLocaleString('he-IL')}
          </span>
        )}
      </div>
    </div>
  )
}

function getStatusIcon(status: string) {
  switch (status) {
    case 'executed':
      return CheckCircle
    case 'rejected':
    case 'failed':
      return XCircle
    default:
      return AlertCircle
  }
}
```
</task>

<task id="6" name="create-contingency-panel">
### Task 6: Create ContingencyPanel Component

Main panel for contingency activation workflow.

**File:** `src/modules/contingency/components/ContingencyPanel.tsx`

```typescript
import { useState } from 'react'
import { AlertTriangle, Loader2 } from 'lucide-react'
import { useContingency } from '../hooks'
import { useContingencyHistory } from '../hooks'
import type { ContingencyActionData } from '../types'
import { BackupSpeakerSelector } from './BackupSpeakerSelector'
import { ContingencyConfirmDialog } from './ContingencyConfirmDialog'
import { ContingencyHistory } from './ContingencyHistory'

interface Schedule {
  id: string
  title: string
  speaker_id: string | null
  speaker_name: string | null
  backup_speaker_id: string | null
}

interface ContingencyPanelProps {
  eventId: string
  schedule: Schedule
  onSuccess?: () => void
}

export function ContingencyPanel({
  eventId,
  schedule,
  onSuccess,
}: ContingencyPanelProps) {
  const [reason, setReason] = useState('')
  const [selectedSpeaker, setSelectedSpeaker] = useState<{ id: string; name: string } | null>(null)
  const [showConfirmDialog, setShowConfirmDialog] = useState(false)

  const {
    suggest,
    execute,
    reject,
    suggestion,
    isSuggesting,
    isExecuting,
    reset,
  } = useContingency({
    eventId,
    onSuggestSuccess: () => {
      setShowConfirmDialog(true)
    },
    onExecuteSuccess: () => {
      setShowConfirmDialog(false)
      reset()
      setReason('')
      setSelectedSpeaker(null)
      onSuccess?.()
    },
  })

  const { history, isLoading: isLoadingHistory } = useContingencyHistory({ eventId })

  const handleActivateBackup = () => {
    if (!selectedSpeaker || !reason.trim()) return

    const actionData: ContingencyActionData = {
      schedule_id: schedule.id,
      schedule_title: schedule.title,
      original_speaker_id: schedule.speaker_id || undefined,
      original_speaker_name: schedule.speaker_name || undefined,
      backup_speaker_id: selectedSpeaker.id,
      backup_speaker_name: selectedSpeaker.name,
    }

    suggest({
      actionType: 'backup_speaker_activate',
      actionData,
      reason: reason.trim(),
    })
  }

  const handleApprove = () => {
    if (!suggestion) return
    execute(suggestion.action_id)
  }

  const handleReject = () => {
    if (!suggestion) return
    reject({ actionId: suggestion.action_id, reason: 'נדחה על ידי המנהל' })
    setShowConfirmDialog(false)
    reset()
  }

  return (
    <div className="space-y-6" dir="rtl">
      {/* Header */}
      <div className="flex items-center gap-2">
        <AlertTriangle className="h-5 w-5 text-orange-500" />
        <h3 className="font-medium text-gray-900">הפעלת תוכנית מגירה</h3>
      </div>

      {/* Current session info */}
      <div className="bg-gray-50 rounded-lg p-3">
        <p className="text-sm text-gray-600">סשן נוכחי:</p>
        <p className="font-medium text-gray-900">{schedule.title}</p>
        {schedule.speaker_name && (
          <p className="text-sm text-gray-600">דובר: {schedule.speaker_name}</p>
        )}
      </div>

      {/* Backup speaker selection */}
      <BackupSpeakerSelector
        eventId={eventId}
        currentSpeakerId={schedule.speaker_id || undefined}
        preassignedBackupId={schedule.backup_speaker_id || undefined}
        onSelect={(speaker) => setSelectedSpeaker({ id: speaker.id, name: speaker.name })}
        selectedSpeakerId={selectedSpeaker?.id}
      />

      {/* Reason input */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">
          סיבה לשינוי
        </label>
        <textarea
          value={reason}
          onChange={(e) => setReason(e.target.value)}
          placeholder="למשל: הדובר המקורי לא יכול להגיע..."
          className="w-full px-3 py-2 border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
          rows={2}
        />
      </div>

      {/* Activate button */}
      <button
        onClick={handleActivateBackup}
        disabled={!selectedSpeaker || !reason.trim() || isSuggesting}
        className={`
          w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg
          font-medium transition-colors
          ${selectedSpeaker && reason.trim()
            ? 'bg-orange-600 text-white hover:bg-orange-700'
            : 'bg-gray-100 text-gray-400 cursor-not-allowed'
          }
        `}
      >
        {isSuggesting ? (
          <>
            <Loader2 className="h-4 w-4 animate-spin" />
            מחשב השפעה...
          </>
        ) : (
          'הפעל דובר חלופי'
        )}
      </button>

      {/* Confirmation dialog */}
      <ContingencyConfirmDialog
        isOpen={showConfirmDialog}
        suggestion={suggestion || null}
        onApprove={handleApprove}
        onReject={handleReject}
        onClose={() => {
          setShowConfirmDialog(false)
          reset()
        }}
        isExecuting={isExecuting}
      />

      {/* History */}
      <div className="border-t pt-4">
        <ContingencyHistory history={history} isLoading={isLoadingHistory} />
      </div>
    </div>
  )
}
```
</task>

<task id="7" name="create-components-index">
### Task 7: Create Module Index Files

Export all components and hooks from module entry points.

**File:** `src/modules/contingency/components/index.ts`

```typescript
export { ContingencyPanel } from './ContingencyPanel'
export { ContingencyConfirmDialog } from './ContingencyConfirmDialog'
export { ContingencyHistory } from './ContingencyHistory'
export { ImpactPreview } from './ImpactPreview'
export { BackupSpeakerSelector } from './BackupSpeakerSelector'
```

**File:** `src/modules/contingency/index.ts`

```typescript
// Types
export * from './types'

// Services
export * from './services'

// Hooks
export * from './hooks'

// Components
export * from './components'
```
</task>

## Verification

After completing all tasks:

1. **Components render correctly:**
   - ContingencyPanel shows backup speaker selection
   - ImpactPreview displays affected participants count
   - ContingencyConfirmDialog follows suggest+confirm pattern
   - ContingencyHistory shows audit entries with status badges

2. **Hooks work correctly:**
   - useContingency provides suggest/execute/reject mutations
   - useContingencyHistory queries audit log

3. **RTL Hebrew UI:**
   - dir="rtl" applied to containers
   - Hebrew labels throughout
   - Icons positioned correctly for RTL

4. **TypeScript compiles:**
   - Run `npx tsc --noEmit` from eventflow-app directory
   - All imports resolve correctly

## Files Created

- `eventflow-app/src/modules/contingency/hooks/useContingency.ts`
- `eventflow-app/src/modules/contingency/hooks/useContingencyHistory.ts`
- `eventflow-app/src/modules/contingency/hooks/index.ts`
- `eventflow-app/src/modules/contingency/components/ImpactPreview.tsx`
- `eventflow-app/src/modules/contingency/components/BackupSpeakerSelector.tsx`
- `eventflow-app/src/modules/contingency/components/ContingencyConfirmDialog.tsx`
- `eventflow-app/src/modules/contingency/components/ContingencyHistory.tsx`
- `eventflow-app/src/modules/contingency/components/ContingencyPanel.tsx`
- `eventflow-app/src/modules/contingency/components/index.ts`
- `eventflow-app/src/modules/contingency/index.ts`

## Dependencies

- **09-03**: Contingency services (suggestContingencyAction, executeContingencyAction, etc.)
- **09-01**: Contingency types (ContingencySuggestion, ImpactSummary, etc.)

## Next Plans

- **09-06**: Integrates ContingencyPanel into EventDetailPage
