---
phase: 09-day-simulation-real-time-operations
plan: 06
title: EventDetailPage Integration
type: integration
wave: 4
depends_on: [09-04, 09-05]
files_modified:
  - eventflow-app/src/pages/events/EventDetailPage.tsx
autonomous: true
must_haves:
  - SimulationTrigger visible on event detail page (new tab or section)
  - ContingencyPanel accessible from schedule session context menu
  - Simulation fix actions navigate to relevant schedule item
  - Phase 9 success criteria met (5 observable truths)
---

# Phase 9 Plan 6: EventDetailPage Integration

## Objective

Wire the simulation and contingency UI components into the existing EventDetailPage, adding a new simulation tab and integrating contingency activation into schedule session context menus.

## Context

**From CONTEXT.md:**
- Trigger via dedicated button on event detail page (not AI chat)
- Manual only - no automatic pre-event runs

**From Phase 7:**
- EventDetailPage already has tabs (details, guests, seating)
- Tab-based navigation with conditional data loading pattern

**Success Criteria (from ROADMAP.md):**
1. Manager can trigger day simulation from event detail page or via chat command
2. Simulation report shows issues by severity with specific problems identified
3. Simulation is deterministic (running twice produces identical results)
4. Manager can activate contingency plan (swap to backup speaker)
5. Affected participants receive WhatsApp notification when schedule changes

## Tasks

<task id="1" name="add-simulation-tab">
### Task 1: Add Simulation Tab to EventDetailPage

Add a new "סימולציה" (Simulation) tab that contains the SimulationTrigger component.

**File:** `src/pages/events/EventDetailPage.tsx`

Modifications needed:

1. **Import simulation components:**
```typescript
import { SimulationTrigger } from '@/modules/simulation'
```

2. **Add tab definition:**
```typescript
// Add to tabs array (after existing tabs)
const tabs = [
  { id: 'details', label: 'פרטים' },
  { id: 'schedule', label: 'לוח זמנים' },
  { id: 'guests', label: 'אורחים' },
  { id: 'seating', label: 'הושבה' },
  { id: 'simulation', label: 'סימולציה' }, // NEW
]
```

3. **Add tab content:**
```typescript
// In the tab content render section
{activeTab === 'simulation' && (
  <div className="bg-white rounded-lg shadow p-6">
    <SimulationTrigger
      eventId={eventId}
      onFixClick={handleSimulationFix}
      onScheduleClick={handleScheduleClick}
    />
  </div>
)}
```

4. **Add fix click handler:**
```typescript
const handleSimulationFix = (fix: SuggestedFix) => {
  // For room reassignment or time changes, open schedule editor
  if (fix.type === 'reassign_room' || fix.type === 'adjust_time') {
    const scheduleId = fix.action_data.schedule_id as string
    setSelectedScheduleId(scheduleId)
    setShowScheduleEditor(true)
  }
  // For backup speaker activation, open contingency panel
  if (fix.type === 'activate_backup') {
    const scheduleId = fix.action_data.schedule_id as string
    setSelectedScheduleId(scheduleId)
    setShowContingencyPanel(true)
  }
}

const handleScheduleClick = (scheduleId: string) => {
  setActiveTab('schedule')
  // Scroll to or highlight the schedule item
  setTimeout(() => {
    const element = document.getElementById(`schedule-${scheduleId}`)
    element?.scrollIntoView({ behavior: 'smooth', block: 'center' })
    element?.classList.add('ring-2', 'ring-blue-500')
    setTimeout(() => element?.classList.remove('ring-2', 'ring-blue-500'), 2000)
  }, 100)
}
```
</task>

<task id="2" name="add-contingency-to-schedule">
### Task 2: Add Contingency Panel to Schedule Context Menu

Add contingency activation option to schedule session context menu.

**Modifications to schedule section:**

1. **Import contingency components:**
```typescript
import { ContingencyPanel } from '@/modules/contingency'
```

2. **Add state for contingency panel:**
```typescript
const [showContingencyPanel, setShowContingencyPanel] = useState(false)
const [selectedScheduleForContingency, setSelectedScheduleForContingency] = useState<Schedule | null>(null)
```

3. **Add context menu option:**
```typescript
// In schedule item context menu (ScheduleCard or similar)
<button
  onClick={() => {
    setSelectedScheduleForContingency(schedule)
    setShowContingencyPanel(true)
  }}
  className="flex items-center gap-2 px-3 py-2 text-sm hover:bg-gray-100 w-full text-right"
>
  <AlertTriangle className="h-4 w-4 text-orange-500" />
  הפעל תוכנית מגירה
</button>
```

4. **Add ContingencyPanel modal/drawer:**
```typescript
// Contingency panel drawer
{showContingencyPanel && selectedScheduleForContingency && (
  <div className="fixed inset-0 z-50 flex justify-end">
    {/* Backdrop */}
    <div
      className="absolute inset-0 bg-black/50"
      onClick={() => setShowContingencyPanel(false)}
    />

    {/* Panel */}
    <div className="relative w-full max-w-md bg-white shadow-xl overflow-auto">
      <div className="p-4 border-b flex items-center justify-between">
        <h2 className="font-semibold text-gray-900">תוכנית מגירה</h2>
        <button
          onClick={() => setShowContingencyPanel(false)}
          className="p-1 rounded-lg hover:bg-gray-100"
        >
          <X className="h-5 w-5" />
        </button>
      </div>

      <div className="p-4">
        <ContingencyPanel
          eventId={eventId}
          schedule={{
            id: selectedScheduleForContingency.id,
            title: selectedScheduleForContingency.title,
            speaker_id: selectedScheduleForContingency.speaker_id,
            speaker_name: selectedScheduleForContingency.speaker?.name || null,
            backup_speaker_id: selectedScheduleForContingency.backup_speaker_id,
          }}
          onSuccess={() => {
            setShowContingencyPanel(false)
            // Refresh schedule data
            queryClient.invalidateQueries({ queryKey: ['schedules', eventId] })
          }}
        />
      </div>
    </div>
  </div>
)}
```
</task>

<task id="3" name="verify-integration">
### Task 3: Verify Full Integration

Ensure all Phase 9 success criteria are met.

**Verification checklist:**

1. **Simulation trigger accessible:**
   - Navigate to event detail page
   - Click "סימולציה" tab
   - Verify SimulationTrigger button is visible
   - Click "הרץ סימולציה" and verify loading state

2. **Simulation report displays correctly:**
   - Issues grouped by severity (critical first)
   - Each issue shows title, description, affected entities
   - Fix actions show clickable buttons

3. **Fix actions work:**
   - Click fix action for room reassignment
   - Verify navigation to schedule tab or editor opens
   - Click fix action for backup speaker
   - Verify contingency panel opens

4. **Contingency activation works:**
   - Open schedule tab
   - Right-click (or context menu) on schedule item
   - Select "הפעל תוכנית מגירה"
   - Verify ContingencyPanel opens in drawer
   - Select backup speaker and enter reason
   - Click activate and verify confirmation dialog

5. **Notifications sent:**
   - After contingency execution, verify:
   - Toast/notification shows success message
   - messages table has new entries with message_type='schedule_update'
   - WhatsApp messages delivered (check Green API logs)

**Testing scenarios:**

```typescript
// Manual test: Simulation with critical issues
// 1. Create event with overlapping schedules in same room
// 2. Run simulation
// 3. Verify critical issue detected for room conflict
// 4. Click fix action
// 5. Verify navigation to schedule editor

// Manual test: Backup speaker activation
// 1. Create event with session and speaker
// 2. Open contingency panel for that session
// 3. Select backup speaker
// 4. Enter reason
// 5. Confirm and execute
// 6. Verify schedule updated
// 7. Verify notification logged
```
</task>

## Complete EventDetailPage Modifications

Here's the consolidated set of changes needed for EventDetailPage.tsx:

```typescript
// ============================================================================
// IMPORTS (add these)
// ============================================================================
import { SimulationTrigger, type SuggestedFix } from '@/modules/simulation'
import { ContingencyPanel } from '@/modules/contingency'
import { AlertTriangle, X } from 'lucide-react'

// ============================================================================
// STATE (add these)
// ============================================================================
const [showContingencyPanel, setShowContingencyPanel] = useState(false)
const [selectedScheduleForContingency, setSelectedScheduleForContingency] = useState<Schedule | null>(null)

// ============================================================================
// TABS (add simulation tab)
// ============================================================================
const tabs = [
  { id: 'details', label: 'פרטים', icon: FileText },
  { id: 'schedule', label: 'לוח זמנים', icon: Calendar },
  { id: 'guests', label: 'אורחים', icon: Users },
  { id: 'seating', label: 'הושבה', icon: LayoutGrid },
  { id: 'simulation', label: 'סימולציה', icon: Play }, // NEW
]

// ============================================================================
// HANDLERS (add these)
// ============================================================================
const handleSimulationFix = useCallback((fix: SuggestedFix) => {
  const scheduleId = fix.action_data.schedule_id as string | undefined
  if (!scheduleId) return

  switch (fix.type) {
    case 'reassign_room':
    case 'adjust_time':
    case 'extend_break':
      // Navigate to schedule and highlight the item
      setActiveTab('schedule')
      setTimeout(() => {
        const element = document.getElementById(`schedule-${scheduleId}`)
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'center' })
          element.classList.add('ring-2', 'ring-blue-500')
          setTimeout(() => element.classList.remove('ring-2', 'ring-blue-500'), 3000)
        }
      }, 100)
      break

    case 'activate_backup':
      // Open contingency panel for the schedule
      const schedule = schedules?.find(s => s.id === scheduleId)
      if (schedule) {
        setSelectedScheduleForContingency(schedule)
        setShowContingencyPanel(true)
      }
      break
  }
}, [schedules])

const handleScheduleClick = useCallback((scheduleId: string) => {
  setActiveTab('schedule')
  setTimeout(() => {
    const element = document.getElementById(`schedule-${scheduleId}`)
    if (element) {
      element.scrollIntoView({ behavior: 'smooth', block: 'center' })
      element.classList.add('ring-2', 'ring-blue-500', 'transition-all')
      setTimeout(() => element.classList.remove('ring-2', 'ring-blue-500'), 3000)
    }
  }, 100)
}, [])

const handleOpenContingency = useCallback((schedule: Schedule) => {
  setSelectedScheduleForContingency(schedule)
  setShowContingencyPanel(true)
}, [])

const handleContingencySuccess = useCallback(() => {
  setShowContingencyPanel(false)
  setSelectedScheduleForContingency(null)
  queryClient.invalidateQueries({ queryKey: ['schedules', eventId] })
  // Show success toast
  toast.success('תוכנית מגירה הופעלה בהצלחה')
}, [eventId, queryClient])

// ============================================================================
// TAB CONTENT (add simulation tab content)
// ============================================================================
{activeTab === 'simulation' && (
  <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <SimulationTrigger
      eventId={eventId}
      onFixClick={handleSimulationFix}
      onScheduleClick={handleScheduleClick}
    />
  </div>
)}

// ============================================================================
// CONTINGENCY PANEL DRAWER (add at end of component, before closing tag)
// ============================================================================
{/* Contingency Panel Drawer */}
{showContingencyPanel && selectedScheduleForContingency && (
  <div className="fixed inset-0 z-50 flex justify-end" dir="rtl">
    {/* Backdrop */}
    <div
      className="absolute inset-0 bg-black/50 transition-opacity"
      onClick={() => setShowContingencyPanel(false)}
    />

    {/* Drawer */}
    <div className="relative w-full max-w-md bg-white shadow-xl flex flex-col">
      {/* Header */}
      <div className="p-4 border-b flex items-center justify-between flex-shrink-0">
        <div className="flex items-center gap-2">
          <AlertTriangle className="h-5 w-5 text-orange-500" />
          <h2 className="font-semibold text-gray-900">תוכנית מגירה</h2>
        </div>
        <button
          onClick={() => setShowContingencyPanel(false)}
          className="p-1 rounded-lg hover:bg-gray-100 transition-colors"
        >
          <X className="h-5 w-5 text-gray-500" />
        </button>
      </div>

      {/* Content */}
      <div className="flex-1 overflow-auto p-4">
        <ContingencyPanel
          eventId={eventId}
          schedule={{
            id: selectedScheduleForContingency.id,
            title: selectedScheduleForContingency.title,
            speaker_id: selectedScheduleForContingency.speaker_id,
            speaker_name: selectedScheduleForContingency.speaker?.name || null,
            backup_speaker_id: selectedScheduleForContingency.backup_speaker_id,
          }}
          onSuccess={handleContingencySuccess}
        />
      </div>
    </div>
  </div>
)}

// ============================================================================
// SCHEDULE ITEM (add context menu option)
// ============================================================================
// In the ScheduleCard or schedule item component, add:
<button
  onClick={() => handleOpenContingency(schedule)}
  className="flex items-center gap-2 px-3 py-2 text-sm hover:bg-gray-100 w-full text-right rounded-md"
>
  <AlertTriangle className="h-4 w-4 text-orange-500" />
  <span>הפעל תוכנית מגירה</span>
</button>
```

## Verification

After completing all tasks:

1. **Simulation tab works:**
   - Tab visible in EventDetailPage
   - SimulationTrigger renders correctly
   - Running simulation shows results

2. **Fix actions navigate correctly:**
   - Room/time fixes navigate to schedule tab
   - Backup speaker fix opens contingency panel

3. **Contingency panel accessible:**
   - Context menu option visible on schedule items
   - Panel opens in drawer
   - Workflow completes successfully

4. **Phase 9 success criteria met:**
   - [x] Manager can trigger simulation from event detail page
   - [x] Report shows issues by severity with problems identified
   - [x] Simulation is deterministic
   - [x] Manager can activate contingency (swap to backup speaker)
   - [x] Affected participants receive WhatsApp notification

## Files Modified

- `eventflow-app/src/pages/events/EventDetailPage.tsx`

## Dependencies

- **09-04**: SimulationTrigger, SuggestedFix types
- **09-05**: ContingencyPanel component

## Completion

This is the final plan for Phase 9. After execution:

1. Run database migration 009_simulation_contingency.sql
2. Verify TypeScript compilation
3. Test simulation workflow end-to-end
4. Test contingency workflow end-to-end
5. Verify WhatsApp notifications delivered

Phase 9 delivers:
- Day simulation with 8 validators detecting issues before event day
- Contingency activation with backup speaker swap and immediate notifications
- Full audit trail in contingency_audit_log table
