---
phase: 10-tier-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - eventflow-app/supabase/migrations/20260203000010_add_tier_columns.sql
  - eventflow-app/src/config/tiers.ts
  - eventflow-app/src/contexts/TierContext.tsx
  - eventflow-app/src/components/ui/TierBadge.tsx
autonomous: true

must_haves:
  truths:
    - "organizations table has tier column with CHECK constraint (base, premium, legacy_premium)"
    - "organizations table has tier_limits JSONB column for per-tier limits"
    - "organizations table has current_usage JSONB column for usage tracking"
    - "Index on tier column exists for RLS performance"
    - "TierContext provides tier data with 1-minute refresh interval"
    - "tiers.ts is single source of truth for tier configuration"
    - "TierBadge component displays current tier in header"
  artifacts:
    - path: "eventflow-app/supabase/migrations/20260203000010_add_tier_columns.sql"
      provides: "Database migration for tier columns"
      contains: "tier column, tier_limits, current_usage, tier_updated_at, tier_updated_by"
    - path: "eventflow-app/src/config/tiers.ts"
      provides: "Central tier configuration registry"
      contains: "TIERS constant, hasFeature(), getTierLimits()"
    - path: "eventflow-app/src/contexts/TierContext.tsx"
      provides: "React context for global tier state"
      contains: "useTier() hook, canAccess(), hasQuota(), refreshQuota()"
    - path: "eventflow-app/src/components/ui/TierBadge.tsx"
      provides: "UI component to display current tier"
      contains: "TierBadge with Base (gray) and Premium (gold) styling"
  key_links:
    - from: "organizations.tier"
      to: "TierContext"
      via: "Query from organizations table"
      pattern: "select('tier, tier_limits, current_usage')"
    - from: "tiers.ts"
      to: "TierContext"
      via: "Import and use hasFeature(), getTierLimits()"
      pattern: "import { hasFeature, getTierLimits } from '../config/tiers'"
    - from: "TierContext"
      to: "TierBadge"
      via: "useTier() hook provides tier prop"
      pattern: "const { tier } = useTier()"
---

<objective>
Create database foundation for tier structure: tier columns, usage tracking, React context, and UI components.

Purpose: Establish the data model and frontend infrastructure for Base and Premium tiers. The database schema stores tier configuration and usage counters. The React context provides real-time tier state to all components. The tiers registry ensures single source of truth.

Output: Migration file, TypeScript context, configuration, and UI component.

Status: ✅ COMPLETE - Implemented on 2026-02-03
</objective>

<execution_context>
@/Users/eliyawolfman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eliyawolfman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md (P1.1 Database Schema: Tier Columns)
@.planning/ROADMAP.md (Phase 1: Foundation)
@eventflow-app/supabase/migrations/20260203000010_add_tier_columns.sql
@eventflow-app/src/config/tiers.ts
@eventflow-app/src/contexts/TierContext.tsx
@eventflow-app/src/components/ui/TierBadge.tsx
</context>

<tasks>

<task type="done">
  <name>Task 1: Create database migration for tier columns</name>
  <files>eventflow-app/supabase/migrations/20260203000010_add_tier_columns.sql</files>
  <action>
  Create migration file with:

  1. **tier column** (TEXT with CHECK constraint):
     - Default: 'base'
     - Check: `CHECK (tier IN ('base', 'premium', 'legacy_premium'))`

  2. **tier_limits JSONB column**:
     - Base: {"events_per_year": 5, "participants_per_event": 100, "messages_per_month": 200, "ai_chat_messages_per_month": 50}
     - Premium: All -1 (unlimited)
     - Legacy Premium: All -1 (unlimited)

  3. **current_usage JSONB column**:
     - events_count, participants_count, messages_sent, ai_messages_sent
     - period_start, period_end, warned_this_month

  4. **Audit trail columns**:
     - tier_updated_at TIMESTAMPTZ
     - tier_updated_by UUID REFERENCES user_profiles(id)

  5. **Index on tier column**: For RLS performance

  6. **Comments**: Document each column in Hebrew and English
  </action>
  <done>
  ✅ Migration file created with all required columns and indexes.
  Deployed to Supabase on 2026-02-03.
  </done>
</task>

<task type="done">
  <name>Task 2: Create central tiers registry</name>
  <files>eventflow-app/src/config/tiers.ts</files>
  <action>
  Create tiers.ts with:

  1. **Type definitions**:
     - type Tier = 'base' | 'premium' | 'legacy_premium'
     - interface TierLimits
     - type Feature

  2. **TIERS constant**:
     - Base: features=['events', 'participants', 'messages'], limits={5, 100, 200, 50}
     - Premium: features=[...all], limits={-1, -1, -1, -1}
     - Legacy Premium: Same as Premium

  3. **Helper functions**:
     - hasFeature(tier, feature): boolean
     - getTierLimits(tier): TierLimits
  </action>
  <done>
  ✅ tiers.ts created with complete type definitions and helper functions.
  Provides single source of truth for tier configuration.
  </done>
</task>

<task type="done">
  <name>Task 3: Create TierContext provider</name>
  <files>eventflow-app/src/contexts/TierContext.tsx</files>
  <action>
  Create TierContext.tsx with:

  1. **TierContextValue interface**:
     - tier, loading, canAccess(), hasQuota(), usage, limits, refreshQuota()

  2. **TierProvider component**:
     - Fetch organization data via TanStack Query
     - 1-minute stale time and refresh interval
     - Provide canAccess(feature) helper using hasFeature() from tiers.ts
     - Provide hasQuota(quotaType) helper comparing usage vs limits
     - Provide refreshQuota() for manual invalidation

  3. **useTier() hook**: Expose context with error if used outside provider
  </action>
  <done>
  ✅ TierContext created with all required features.
  Fetches tier data from organizations table every minute.
  </done>
</task>

<task type="done">
  <name>Task 4: Create TierBadge component</name>
  <files>eventflow-app/src/components/ui/TierBadge.tsx</files>
  <action>
  Create TierBadge.tsx with:

  1. **Accept tier prop**: 'base' | 'premium' | 'legacy_premium'
  2. **Style Base tier**: Gray badge, "תוכנית בסיס"
  3. **Style Premium tier**: Gold badge, "תוכנית פרימיום"
  4. **RTL layout**: Hebrew text aligned right
  5. **Click handler**: Navigate to /settings/billing
  </action>
  <done>
  ✅ TierBadge created with RTL Hebrew layout.
  Ready to integrate into header navigation.
  </done>
</task>

</tasks>

<verification>
1. ✅ Migration file exists and is valid SQL
2. ✅ organizations table has tier column with CHECK constraint
3. ✅ tier_limits and current_usage JSONB columns exist
4. ✅ Index on tier column created
5. ✅ tiers.ts is single source of truth for tier configuration
6. ✅ TierContext provides accurate tier data with 1-minute refresh
7. ✅ TierBadge displays tier correctly in RTL Hebrew
</verification>

<success_criteria>
Database schema supports tier structure with usage tracking. React context provides real-time tier state to all components. Central tiers registry ensures consistency across codebase. TierBadge component ready for header integration.

All files completed and deployed on 2026-02-03.
</success_criteria>

<output>
Phase 10, Plan 01 complete. Ready to proceed with Plan 02 (Usage Counter Triggers).
</output>
