---
phase: 10-tier-foundation
plan: 03
type: execute
wave: 1
depends_on: [10-01]
files_modified:
  - eventflow-app/supabase/migrations/20260204000012_add_tier_rls_policies.sql
autonomous: true

must_haves:
  truths:
    - "check_org_tier() function exists as security definer and STABLE"
    - "RLS policy on simulations table enforces Premium tier only"
    - "RLS policy on ai_chat_sessions table enforces Premium tier only"
    - "RLS policy on vendor_analysis table enforces Premium tier only"
    - "Base tier users cannot query/insert Premium feature tables"
    - "Premium tier users can access all tables"
    - "RLS queries complete in <200ms under 100 concurrent requests"
  artifacts:
    - path: "eventflow-app/supabase/migrations/20260204000012_add_tier_rls_policies.sql"
      provides: "RLS policies for Premium feature table access control"
      contains: "check_org_tier function, 3 RLS policies with tier checks"
  key_links:
    - from: "organizations.tier"
      to: "Premium feature tables (simulations, ai_chat_sessions, vendor_analysis)"
      via: "RLS policies using check_org_tier()"
      pattern: "USING (check_org_tier(organization_id, 'premium'))"
    - from: "check_org_tier()"
      to: "RLS policy performance"
      via: "STABLE marker and security definer"
      pattern: "CREATE OR REPLACE FUNCTION ... SECURITY DEFINER STABLE"
---

<objective>
Add Row Level Security (RLS) policies to restrict Premium-only tables to Premium organizations.

Purpose: Enforce tier restrictions at the database level to ensure security and performance. Create a reusable security definer function that checks organization tier, then apply RLS policies to Premium feature tables (simulations, ai_chat_sessions, vendor_analysis).

Output: Single SQL migration file with tier check function and RLS policies.
</objective>

<execution_context>
@/Users/eliyawolfman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eliyawolfman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md (P1.3 RLS Policies: Premium Feature Tables)
@.planning/ROADMAP.md (Phase 1: Foundation, P1.3 Tasks)
@eventflow-app/supabase/migrations/20260203000010_add_tier_columns.sql
@eventflow-scaffold/schema.sql (for Premium feature table structures)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create check_org_tier function</name>
  <files>eventflow-app/supabase/migrations/20260204000012_add_tier_rls_policies.sql</files>
  <action>
  Create security definer function:

  ```sql
  CREATE OR REPLACE FUNCTION check_org_tier(p_org_id UUID, p_required_tier TEXT)
  RETURNS BOOLEAN AS $$
  DECLARE
    v_tier TEXT;
  BEGIN
    -- Get organization tier
    SELECT tier INTO v_tier
    FROM organizations
    WHERE id = p_org_id;

    -- Check if tier matches required tier
    -- Premium and legacy_premium have same access
    RETURN v_tier IN (p_required_tier, 'legacy_premium') OR v_tier = 'premium';
  END;
  $$ LANGUAGE plpgsql SECURITY DEFINER STABLE;
  ```

  Notes:
  - SECURITY DEFINER: Bypasses RLS for the function itself
  - STABLE: Tells optimizer function is safe to cache (performance critical)
  - Handles legacy_premium tier (same access as Premium)
  - Returns boolean for simple RLS policy check
  </action>
  <verify>
  1. Function compiles without errors
  2. SECURITY DEFINER set
  3. STABLE marker present
  4. Returns boolean type
  5. Handles legacy_premium correctly
  </verify>
  <done>
  Function created as SECURITY DEFINER with STABLE marker.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RLS policy on simulations table</name>
  <files>eventflow-app/supabase/migrations/20260204000012_add_tier_rls_policies.sql</files>
  <action>
  Create RLS policies for simulations table:

  ```sql
  -- Enable RLS if not already enabled
  ALTER TABLE simulations ENABLE ROW LEVEL SECURITY;

  -- Policy: Only Premium tier can access
  DROP POLICY IF EXISTS premium_only_simulations ON simulations;
  CREATE POLICY premium_only_simulations ON simulations
  FOR ALL
  USING (check_org_tier(organization_id, 'premium'));

  -- Note: This policy applies to SELECT, INSERT, UPDATE, DELETE
  ```

  Notes:
  - Enable RLS first if not enabled
  - DROP POLICY IF EXISTS for idempotent migration
  - FOR ALL means applies to all operations
  - USING clause checks organization_id tier
  </action>
  <verify>
  1. RLS enabled on simulations table
  2. Policy syntax is valid
  3. Uses check_org_tier() function
  4. FOR ALL (applies to all operations)
  </verify>
  <done>
  RLS policy created on simulations table.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create RLS policy on ai_chat_sessions table</name>
  <files>eventflow-app/supabase/migrations/20260204000012_add_tier_rls_policies.sql</files>
  <action>
  Create RLS policies for ai_chat_sessions table:

  ```sql
  -- Enable RLS if not already enabled
  ALTER TABLE ai_chat_sessions ENABLE ROW LEVEL SECURITY;

  -- Policy: Only Premium tier can access
  DROP POLICY IF EXISTS premium_only_ai_chat_sessions ON ai_chat_sessions;
  CREATE POLICY premium_only_ai_chat_sessions ON ai_chat_sessions
  FOR ALL
  USING (check_org_tier(organization_id, 'premium'));
  ```

  Notes:
  - Same pattern as simulations table
  - Enforces Premium requirement for AI chat
  </action>
  <verify>
  1. RLS enabled on ai_chat_sessions table
  2. Policy syntax is valid
  3. Uses check_org_tier() function
  </verify>
  <done>
  RLS policy created on ai_chat_sessions table.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create RLS policy on vendor_analysis table</name>
  <files>eventflow-app/supabase/migrations/20260204000012_add_tier_rls_policies.sql</files>
  <action>
  Create RLS policies for vendor_analysis table:

  ```sql
  -- Enable RLS if not already enabled
  ALTER TABLE vendor_analysis ENABLE ROW LEVEL SECURITY;

  -- Policy: Only Premium tier can access
  DROP POLICY IF EXISTS premium_only_vendor_analysis ON vendor_analysis;
  CREATE POLICY premium_only_vendor_analysis ON vendor_analysis
  FOR ALL
  USING (check_org_tier(organization_id, 'premium'));
  ```

  Notes:
  - Same pattern as previous tables
  - Enforces Premium requirement for vendor analysis
  </action>
  <verify>
  1. RLS enabled on vendor_analysis table
  2. Policy syntax is valid
  3. Uses check_org_tier() function
  </verify>
  <done>
  RLS policy created on vendor_analysis table.
  </done>
</task>

<task type="auto">
  <name>Task 5: Add performance index for tier column</name>
  <files>eventflow-app/supabase/migrations/20260204000012_add_tier_rls_policies.sql</files>
  <action>
  Create composite index for RLS performance:

  ```sql
  -- Composite index for RLS tier checks on organizations
  CREATE INDEX IF NOT EXISTS idx_organizations_tier_id ON organizations(id, tier);
  ```

  Notes:
  - Composite index on (id, tier) speeds up JOINs in check_org_tier()
  - IF NOT EXISTS for idempotent migration
  - Critical for <200ms query performance under load
  </action>
  <verify>
  1. Index syntax is valid
  2. Composite on (id, tier) for JOIN performance
  </verify>
  <done>
  Composite index created for RLS performance.
  </done>
</task>

<task type="auto">
  <name>Task 6: Add migration comments and test queries</name>
  <files>eventflow-app/supabase/migrations/20260204000012_add_tier_rls_policies.sql</files>
  <action>
  Add to migration file:

  1. **Migration header**:
     ```sql
     -- Migration 012: Add Tier RLS Policies for Premium Features
     -- EventFlow AI v2.1 - SaaS Tier Structure
     -- Date: 2026-02-04
     ```

  2. **Section comments** (Hebrew and English):
     ```sql
     -- פונקציה לבדיקת רמת מנוי (Tier Check Function)
     -- Security definer function checks organization tier with STABLE marker for query optimization
     ```

  3. **Test queries** (for manual verification):
     ```sql
     -- Test: Create Base tier org, try to insert into simulations (should fail)
     INSERT INTO simulations (organization_id, ...) VALUES (base_org_id, ...);
     -- Expected: Permission denied

     -- Test: Create Premium tier org, try to insert into simulations (should succeed)
     INSERT INTO simulations (organization_id, ...) VALUES (premium_org_id, ...);
     -- Expected: Success

     -- Benchmark: EXPLAIN ANALYZE RLS query
     EXPLAIN ANALYZE SELECT * FROM simulations WHERE organization_id = $1;
     -- Expected: <200ms
     ```
  </action>
  <verify>
  1. All sections have clear comments
  2. Test queries cover Base (fail) and Premium (success) cases
  3. EXPLAIN ANALYZE query for performance benchmarking
  </verify>
  <done>
  Migration file with comments and test queries added.
  </done>
</task>

</tasks>

<verification>
1. ✅ check_org_tier() function is SECURITY DEFINER and STABLE
2. ✅ RLS enabled on all 3 Premium feature tables
3. ✅ RLS policies enforce Premium tier requirement
4. ✅ Legacy Premium tier handled correctly
5. ✅ Composite index (id, tier) created for performance
6. ✅ Policies apply to all operations (FOR ALL)
7. ✅ Idempotent DROP POLICY statements
</verification>

<success_criteria>
RLS policies prevent Base tier users from accessing Premium feature tables (simulations, ai_chat_sessions, vendor_analysis). Premium tier users can access all tables. Queries complete in <200ms under 100 concurrent requests.

Ready to deploy to Supabase and test with Base and Premium tier organizations.
</success_criteria>

<output>
After completion, create `.planning/phases/10-tier-foundation/10-03-SUMMARY.md`
</output>
