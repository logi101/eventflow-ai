---
phase: 10-tier-foundation
plan: 04
type: execute
wave: 1
depends_on: [10-01]
files_modified:
  - eventflow-app/supabase/migrations/20260204000013_migrate_existing_orgs_to_base.sql
autonomous: true

must_haves:
  truths:
    - "All existing organizations have tier set (no NULL values)"
    - "Option 1: Simple migration sets all organizations to 'base' tier"
    - "Option 2: Grandfathering sets pre-2026-02-03 orgs to 'legacy_premium'"
    - "legacy_expires_at column exists for grandfathered orgs (if Option 2)"
    - "Migration is idempotent and safe to run multiple times"
    - "No production outages during deployment"
  artifacts:
    - path: "eventflow-app/supabase/migrations/20260204000013_migrate_existing_orgs_to_base.sql"
      provides: "Migration script for existing organizations to tier structure"
      contains: "Simple migration OR grandfathering option, email template, admin queries"
  key_links:
    - from: "existing organizations"
      to: "organizations.tier"
      via: "UPDATE statement in migration"
      pattern: "UPDATE organizations SET tier = 'base' WHERE tier IS NULL"
    - from: "grandfathered orgs"
      to: "organizations.legacy_expires_at"
      via: "UPDATE statement with date check"
      pattern: "UPDATE organizations SET tier = 'legacy_premium' WHERE created_at < '2026-02-03'"
---

<objective>
Migrate existing organizations to Base tier with optional grandfathering for long-term users.

Purpose: Ensure all existing organizations have a tier value (no NULLs) when the new tier structure launches. Provide two migration options: simple (all to Base) or grandfathering (pre-launch orgs to legacy_premium for 6 months).

Output: Migration script with both options, email template, and admin queries.
</objective>

<execution_context>
@/Users/eliyawolfman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eliyawolfman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md (P1.4 Existing User Migration)
@.planning/ROADMAP.md (Phase 1: Foundation, P1.4 Tasks)
@eventflow-app/supabase/migrations/20260203000010_add_tier_columns.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Option 1 - Simple Migration</name>
  <files>eventflow-app/supabase/migrations/20260204000013_migrate_existing_orgs_to_base.sql</files>
  <action>
  Create simple migration:

  ```sql
  -- Migration 013: Migrate Existing Organizations to Base Tier
  -- EventFlow AI v2.1 - SaaS Tier Structure
  -- Date: 2026-02-04

  -- ===========================================
  -- Option 1: Simple Migration
  -- All organizations set to 'base' tier
  -- ===========================================

  -- Set all organizations with NULL tier to 'base'
  UPDATE organizations
  SET
    tier = 'base',
    tier_updated_at = NOW()
  WHERE tier IS NULL;

  -- Verify no NULL tiers remain
  DO $$
  BEGIN
    IF EXISTS (SELECT 1 FROM organizations WHERE tier IS NULL) THEN
      RAISE EXCEPTION 'Migration failed: Some organizations still have NULL tier';
    END IF;
  END $$;
  ```

  Notes:
  - Simple and straightforward
  - All existing users become Base tier
  - No grandfathering or special treatment
  - Idempotent: WHERE tier IS NULL only affects unmigrated rows
  </action>
  <verify>
  1. UPDATE syntax is valid
  2. WHERE tier IS NULL ensures idempotency
  3. Verification block raises error if NULL tiers remain
  </verify>
  <done>
  Option 1 simple migration created.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Option 2 - Grandfathering</name>
  <files>eventflow-app/supabase/migrations/20260204000013_migrate_existing_orgs_to_base.sql</files>
  <action>
  Create grandfathering migration:

  ```sql
  -- ===========================================
  -- Option 2: Grandfathering
  -- Organizations created before 2026-02-03 get 6 months of legacy_premium
  -- ===========================================

  -- Add legacy_expires_at column if it doesn't exist
  ALTER TABLE organizations
  ADD COLUMN IF NOT EXISTS legacy_expires_at TIMESTAMPTZ;

  -- Set orgs created before 2026-02-03 to legacy_premium with 6-month expiration
  UPDATE organizations
  SET
    tier = 'legacy_premium',
    legacy_expires_at = NOW() + INTERVAL '6 months',
    tier_updated_at = NOW()
  WHERE
    tier IS NULL
    AND created_at < '2026-02-03T00:00:00Z';

  -- Set remaining orgs to base
  UPDATE organizations
  SET
    tier = 'base',
    tier_updated_at = NOW()
  WHERE tier IS NULL;

  -- Verify no NULL tiers remain
  DO $$
  BEGIN
    IF EXISTS (SELECT 1 FROM organizations WHERE tier IS NULL) THEN
      RAISE EXCEPTION 'Migration failed: Some organizations still have NULL tier';
    END IF;
  END $$;
  ```

  Notes:
  - Grandfathers pre-launch organizations
  - 6-month legacy Premium period
  - Adds legacy_expires_at column for expiration tracking
  - New organizations default to Base
  </action>
  <verify>
  1. ALTER TABLE adds legacy_expires_at column
  2. UPDATE with date check for grandfathering
  3. Second UPDATE catches remaining orgs
  4. Verification block raises error if NULL tiers remain
  </verify>
  <done>
  Option 2 grandfathering migration created.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create admin queries for grandfathered orgs</name>
  <files>eventflow-app/supabase/migrations/20260204000013_migrate_existing_orgs_to_base.sql</files>
  <action>
  Add admin queries to migration file:

  ```sql
  -- ===========================================
  -- Admin Queries (Post-Migration)
  -- ===========================================

  -- Query 1: Count grandfathered organizations
  -- ××¡×¤×¨ ××¨×’×•× ×™× ×©×§×™×‘×œ×• ×¤×¨×™××™×•× ×œ×’××’
  SELECT
    COUNT(*) as legacy_premium_count
  FROM organizations
  WHERE tier = 'legacy_premium';

  -- Query 2: Find grandfathered orgs approaching expiration (within 30 days)
  -- ××¨×’×•× ×™× ×©×ª×§×•×¤×ª ×”×¤×¨×™××™×•× ×©×œ×”× ×¢×•××“×ª ×œ×¤×•×’ (30 ×™××™×)
  SELECT
    id,
    name,
    legacy_expires_at,
    legacy_expires_at - NOW() as days_remaining
  FROM organizations
  WHERE
    tier = 'legacy_premium'
    AND legacy_expires_at - NOW() < INTERVAL '30 days'
  ORDER BY legacy_expires_at ASC;

  -- Query 3: Identify expired legacy Premium orgs
  -- ××¨×’×•× ×™× ×©×ª×§×•×¤×ª ×”×¤×¨×™××™×•× ×©×œ×”× ×¤×’×”
  SELECT
    id,
    name,
    legacy_expires_at,
    NOW() - legacy_expires_at as days_expired
  FROM organizations
  WHERE
    tier = 'legacy_premium'
    AND legacy_expires_at < NOW()
  ORDER BY legacy_expires_at DESC;
  ```

  Notes:
  - Query 1: Count grandfathered orgs for reporting
  - Query 2: Find orgs expiring soon (send upgrade reminders)
  - Query 3: Find expired orgs (downgrade to Base or manual review)
  </action>
  <verify>
  1. All queries are valid SQL
  2. Query 2 correctly filters within 30 days
  3. Query 3 correctly filters expired orgs
  </verify>
  <done>
  Admin queries created for grandfathered org tracking.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create email template for tier announcement</name>
  <files>eventflow-app/supabase/migrations/20260204000013_migrate_existing_orgs_to_base.sql</files>
  <action>
  Add email template to migration file:

  ```sql
  -- ===========================================
  -- Email Template: Tier Structure Announcement
  -- ===========================================

  -- Insert email template (use your email system)
  -- This is a reference for sending the announcement email

  /*
  Subject: ×—×“×© ×‘-EventFlow: ×ª×•×›× ×™×ª ×¤×¨×™××™×•× ×—×“×©×” ğŸ‰

  ×©×œ×•× {user_name},

  ×× ×—× ×• ×©××—×™× ×œ×”×•×“×™×¢ ×¢×œ ×”×©×§×ª ×ª×•×›× ×™×•×ª ×× ×•×™ ×—×“×©×•×ª ×‘-EventFlow!

  ğŸ“¦ ×ª×•×›× ×™×ª ×‘×¡×™×¡ (×—×™× ×):
  - 5 ××™×¨×•×¢×™× ×‘×©× ×”
  - 100 ××©×ª×ª×¤×™× ×œ××™×¨×•×¢
  - 200 ×”×•×“×¢×•×ª ×‘×—×•×“×©
  - × ×™×”×•×œ ××™×¨×•×¢×™× ×‘×¡×™×¡×™

  â­ ×ª×•×›× ×™×ª ×¤×¨×™××™×•×:
  - ××™×¨×•×¢×™× ×œ×œ× ×”×’×‘×œ×”
  - ××©×ª×ª×¤×™× ×œ×œ× ×”×’×‘×œ×”
  - ×”×•×“×¢×•×ª ×œ×œ× ×”×’×‘×œ×”
  - ×¦'××˜ AI ×—×›×
  - ×¡×™××•×œ×¦×™×™×ª ×™×•× ×”××™×¨×•×¢
  - ×× ×•×¢ × ×˜×•×•×¨×§×™× ×’
  - ×”×ª×¨××•×ª ×ª×§×¦×™×‘
  - × ×™×ª×•×— ×¡×¤×§×™×

  ğŸ ×”××¨×’×•×Ÿ ×©×œ×š ×§×™×‘×œ ×’×™×©×” ×œ×ª×•×›× ×™×ª ×‘×¡×™×¡.

  ×œ×©×“×¨×•×’ ×œ×¤×¨×™××™×•×, ×™×© ×œ×¤× ×•×ª ×œ×¦×•×•×ª ×”×ª××™×›×”:
  support@eventflow.ai

  ×‘×ª×•×“×”,
  ×¦×•×•×ª EventFlow
  */
  ```
  </action>
  <verify>
  1. Template includes Hebrew text (RTL)
  2. Base tier limits clearly stated
  3. Premium features listed
  4. Upgrade contact info provided
  </verify>
  <done>
  Email template created for tier announcement.
  </done>
</task>

<task type="auto">
  <name>Task 5: Add deployment checklist</name>
  <files>eventflow-app/supabase/migrations/20260204000013_migrate_existing_orgs_to_base.sql</files>
  <action>
  Add deployment checklist to migration file:

  ```sql
  -- ===========================================
  -- Deployment Checklist
  -- ===========================================

  -- Pre-Deployment:
  -- [ ] Test migration on staging database
  -- [ ] Count current organizations: SELECT COUNT(*) FROM organizations;
  -- [ ] Backup organizations table: pg_dump -t organizations
  -- [ ] Choose migration option (simple vs grandfathering)
  -- [ ] Prepare email campaign (optional: send after migration)

  -- Deployment:
  -- [ ] Deploy during non-peak hours (e.g., 2-4 AM)
  -- [ ] Run migration in Supabase SQL Editor
  -- [ ] Verify no NULL tiers: SELECT COUNT(*) FROM organizations WHERE tier IS NULL;
  -- [ ] Check grandfathered count: SELECT COUNT(*) FROM organizations WHERE tier = 'legacy_premium';
  -- [ ] Monitor application logs for errors

  -- Post-Deployment:
  -- [ ] Verify application loads without errors
  -- [ ] Test Base tier user (should see upgrade prompts)
  -- [ ] Test Premium tier user (should see all features)
  -- [ ] Send email announcement (optional)
  -- [ ] Create ticket in support system for tier-related questions

  -- Rollback Plan (if issues):
  -- UPDATE organizations SET tier = 'premium' WHERE tier IN ('base', 'legacy_premium');
  -- This temporarily grants Premium to all while investigating issues
  ```
  </action>
  <verify>
  1. Checklist covers pre, during, and post deployment
  2. Rollback plan provided
  3. Monitoring steps included
  </verify>
  <done>
  Deployment checklist added.
  </done>
</task>

</tasks>

<verification>
1. âœ… Option 1: Simple migration updates all orgs to Base
2. âœ… Option 2: Grandfathering with 6-month legacy Premium
3. âœ… legacy_expires_at column added for grandfathering
4. âœ… Admin queries for tracking grandfathered orgs
5. âœ… Email template in Hebrew with RTL
6. âœ… Deployment checklist with rollback plan
7. âœ… Verification block raises error if NULL tiers remain
</verification>

<success_criteria>
All existing organizations have tier set (no NULL values) after migration. Admins can query grandfathered organizations and track expiration. Email template ready for tier announcement. Migration is idempotent and safe to run multiple times.

Ready to deploy to production after staging testing.
</success_criteria>

<output>
After completion, create `.planning/phases/10-tier-foundation/10-04-SUMMARY.md`
</output>
