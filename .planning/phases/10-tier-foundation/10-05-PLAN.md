---
phase: 10-tier-foundation
plan: 05
type: execute
wave: 1
depends_on: [10-01]
files_modified:
  - eventflow-app/supabase/migrations/20260204000014_add_monthly_reset_cron.sql
autonomous: true

must_haves:
  truths:
    - "pg_cron job scheduled to run on 1st of each month at 00:00 UTC"
    - "Reset function resets current_usage JSONB to zero"
    - "period_start and period_end updated to new month"
    - "warned_this_month reset to false"
    - "Reset operations logged to admin_logs table"
    - "Job is idempotent and handles edge cases (Premium unlimited)"
  artifacts:
    - path: "eventflow-app/supabase/migrations/20260204000014_add_monthly_reset_cron.sql"
      provides: "pg_cron job for automatic monthly usage reset"
      contains: "reset_monthly_usage() function, cron schedule, logging"
  key_links:
    - from: "pg_cron"
      to: "organizations.current_usage"
      via: "reset_monthly_usage() function"
      pattern: "SELECT cron.schedule('reset-monthly-limits', '0 0 1 * *', ...)"
    - from: "reset_monthly_usage()"
      to: "admin_logs"
      via: "INSERT statement"
      pattern: "INSERT INTO admin_logs (action, details) VALUES ('monthly_reset', ...)"
---

<objective>
Create pg_cron job to reset monthly usage counters on the 1st of each month.

Purpose: Automatically reset usage counters (events_count, participants_count, messages_sent, ai_messages_sent) to zero at the start of each billing cycle. Update period_start and period_end to track new billing period. Reset warned_this_month flag for new soft limit warnings.

Output: Single SQL migration file with reset function and pg_cron schedule.
</objective>

<execution_context>
@/Users/eliyawolfman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eliyawolfman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md (P1.5 Monthly Usage Reset Cron Job)
@.planning/ROADMAP.md (Phase 1: Foundation, P1.5 Tasks)
@eventflow-app/supabase/migrations/20260203000010_add_tier_columns.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reset_monthly_usage function</name>
  <files>eventflow-app/supabase/migrations/20260204000014_add_monthly_reset_cron.sql</files>
  <action>
  Create PL/pgSQL function:

  ```sql
  CREATE OR REPLACE FUNCTION reset_monthly_usage()
  RETURNS void AS $$
  DECLARE
    v_count INTEGER;
    v_current_month TEXT;
    v_next_month TEXT;
  BEGIN
    -- Calculate current and next month timestamps
    v_current_month := date_trunc('month', NOW())::TEXT;
    v_next_month := (date_trunc('month', NOW()) + INTERVAL '1 month')::TEXT;

    -- Reset usage for all organizations
    UPDATE organizations
    SET
      current_usage = jsonb_build_object(
        'events_count', 0,
        'participants_count', 0,
        'messages_sent', 0,
        'ai_messages_sent', 0,
        'period_start', v_current_month,
        'period_end', v_next_month,
        'warned_this_month', false
      );

    -- Get count of updated organizations
    GET DIAGNOSTICS v_count = ROW_COUNT;

    -- Log reset operation
    INSERT INTO admin_logs (action, details, created_at)
    VALUES (
      'monthly_reset',
      jsonb_build_object(
        'organizations_reset', v_count,
        'period_start', v_current_month,
        'period_end', v_next_month
      ),
      NOW()
    );

    RAISE NOTICE 'Monthly usage reset completed for % organizations', v_count;
  END;
  $$ LANGUAGE plpgsql;
  ```

  Notes:
  - Resets all counters to zero (including Premium for consistency)
  - Updates period_start to start of current month
  - Updates period_end to start of next month
  - Resets warned_this_month for new soft limit warnings
  - Logs operation to admin_logs table for audit trail
  </action>
  <verify>
  1. Function compiles without errors
  2. jsonb_build_object creates correct structure
  3. date_trunc calculates month boundaries correctly
  4. Logs to admin_logs table
  </verify>
  <done>
  Function created with complete usage reset logic.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin_logs table if not exists</name>
  <files>eventflow-app/supabase/migrations/20260204000014_add_monthly_reset_cron.sql</files>
  <action>
  Create admin_logs table (if not exists):

  ```sql
  -- Create admin_logs table for cron job auditing
  CREATE TABLE IF NOT EXISTS admin_logs (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    action TEXT NOT NULL,
    details JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
  );

  -- Create index on created_at for querying
  CREATE INDEX IF NOT EXISTS idx_admin_logs_created_at ON admin_logs(created_at DESC);

  -- Create index on action for filtering
  CREATE INDEX IF NOT EXISTS idx_admin_logs_action ON admin_logs(action);
  ```

  Notes:
  - Stores all admin/cron operations for audit
  - details JSONB for flexible logging
  - Indexes for efficient querying
  </action>
  <verify>
  1. Table syntax is valid
  2. Indexes created correctly
  3. IF NOT EXISTS for idempotency
  </verify>
  <done>
  admin_logs table created for auditing.
  </done>
</task>

<task type="auto">
  <name>Task 3: Schedule pg_cron job</name>
  <files>eventflow-app/supabase/migrations/20260204000014_add_monthly_reset_cron.sql</files>
  <action>
  Schedule pg_cron job:

  ```sql
  -- Schedule monthly reset cron job
  -- Runs on 1st of each month at 00:00 UTC
  SELECT cron.schedule(
    'reset-monthly-limits',
    '0 0 1 * *',
    $$SELECT reset_monthly_usage();$$
  );

  -- Verify schedule
  SELECT * FROM cron.job WHERE jobname = 'reset-monthly-limits';
  ```

  Notes:
  - Cron format: '0 0 1 * *' (minute hour day month weekday)
  - Runs at 00:00 on 1st of every month
  - Calls reset_monthly_usage() function
  - Select from cron.job to verify schedule
  </action>
  <verify>
  1. cron.schedule syntax is valid
  2. Cron expression '0 0 1 * *' is correct for monthly reset
  3. Function call is properly wrapped
  4. Verification query checks job exists
  </verify>
  <done>
  pg_cron job scheduled for 1st of each month.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add manual test function</name>
  <files>eventflow-app/supabase/migrations/20260204000014_add_monthly_reset_cron.sql</files>
  <action>
  Add manual testing function:

  ```sql
  -- ===========================================
  -- Manual Testing Function
  -- Run this to test reset logic without waiting for cron
  -- ===========================================

  -- Test: Run reset manually
  SELECT reset_monthly_usage();

  -- Verify: Check current_usage after reset
  SELECT
    id,
    name,
    current_usage->>'events_count' as events_count,
    current_usage->>'participants_count' as participants_count,
    current_usage->>'messages_sent' as messages_sent,
    current_usage->>'period_start' as period_start,
    current_usage->>'period_end' as period_end
  FROM organizations;

  -- Verify: Check admin_logs for reset entry
  SELECT * FROM admin_logs
  WHERE action = 'monthly_reset'
  ORDER BY created_at DESC
  LIMIT 1;

  -- Expected: All counts are 0, period_start is current month, period_end is next month
  ```
  </action>
  <verify>
  1. Manual function call is valid
  2. Verification queries check reset results
  3. Admin log query for audit trail
  </verify>
  <done>
  Manual testing function added.
  </done>
</task>

<task type="auto">
  <name>Task 5: Add monitoring and alerting queries</name>
  <files>eventflow-app/supabase/migrations/20260204000014_add_monthly_reset_cron.sql</files>
  <action>
  Add monitoring queries:

  ```sql
  -- ===========================================
  -- Monitoring Queries
  -- ===========================================

  -- Query 1: Check if monthly reset ran this month
  -- בדוק אם איפוס חודשי רץ החודש
  SELECT
    action,
    details->>'organizations_reset' as orgs_reset,
    details->>'period_start' as period_start,
    created_at
  FROM admin_logs
  WHERE
    action = 'monthly_reset'
    AND created_at >= date_trunc('month', NOW())
  ORDER BY created_at DESC
  LIMIT 1;

  -- Query 2: Check cron job status
  -- בדוק סטטוס משימת cron
  SELECT * FROM cron.job_run_details
  WHERE jobname = 'reset-monthly-limits'
  ORDER BY start_time DESC
  LIMIT 5;

  -- Query 3: Identify organizations with stale period dates (reset didn't run)
  -- ארגונים עם תאריכי תקופה מיושנים
  SELECT
    id,
    name,
    current_usage->>'period_start' as period_start,
    current_usage->>'period_end' as period_end
  FROM organizations
  WHERE
    (current_usage->>'period_end')::TIMESTAMPTZ < date_trunc('month', NOW());
  ```
  </action>
  <verify>
  1. Query 1 checks for reset in current month
  2. Query 2 checks cron job run history
  3. Query 3 finds orgs with stale period dates
  </verify>
  <done>
  Monitoring queries added.
  </done>
</task>

<task type="auto">
  <name>Task 6: Add migration comments and documentation</name>
  <files>eventflow-app/supabase/migrations/20260204000014_add_monthly_reset_cron.sql</files>
  <action>
  Add migration header and comments:

  ```sql
  -- Migration 014: Add Monthly Usage Reset Cron Job
  -- EventFlow AI v2.1 - SaaS Tier Structure
  -- Date: 2026-02-04

  -- ===========================================
  -- Overview
  -- ===========================================
  -- This migration creates a pg_cron job that runs on the 1st of each month
  -- to reset usage counters for all organizations.
  --
  -- What gets reset:
  -- - events_count: 0
  -- - participants_count: 0
  -- - messages_sent: 0
  -- - ai_messages_sent: 0
  -- - period_start: Start of current month
  -- - period_end: Start of next month
  -- - warned_this_month: false (allows new soft limit warnings)
  --
  -- All organizations are reset (including Premium) for consistency.
  -- ===========================================

  -- פונקציית איפוס חודשי (Monthly Reset Function)
  -- Resets usage counters and updates period dates for all organizations
  ```

  Notes:
  - Clear documentation of what gets reset
  - Notes that Premium is also reset (for consistency)
  - Hebrew comments for RTL support
  </action>
  <verify>
  1. Migration header is complete
  2. Overview explains purpose clearly
  3. What gets reset is documented
  </verify>
  <done>
  Migration comments added.
  </done>
</task>

</tasks>

<verification>
1. ✅ reset_monthly_usage() function resets all counters to zero
2. ✅ period_start and period_end updated to new month
3. ✅ warned_this_month reset to false
4. ✅ admin_logs table created for audit trail
5. ✅ pg_cron job scheduled for 1st of each month at 00:00 UTC
6. ✅ Manual test function provided
7. ✅ Monitoring queries for cron status and stale dates
</verification>

<success_criteria>
Monthly reset cron job runs automatically on 1st of each month. Usage counters reset to zero. Period dates updated to new billing cycle. All operations logged to admin_logs table. Manual test function works for verification.

Ready to deploy to Supabase and test manually before first scheduled run.
</success_criteria>

<output>
After completion, create `.planning/phases/10-tier-foundation/10-05-SUMMARY.md`
</output>
