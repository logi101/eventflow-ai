-- Migration 012: Create Premium Tables + Add Tier RLS Policies
-- EventFlow AI v2.1 - SaaS Tier Structure
-- Date: 2026-02-04

-- ====================================================================
-- 1. CREATE PREMIUM FEATURE TABLES (missing from v2.0)
-- ====================================================================

-- -------------------------------------------------------------------------
-- SIMULATIONS TABLE
-- -------------------------------------------------------------------------
DO $$
BEGIN
  -- Drop table if it exists with old schema (to fix migration issues)
  IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'simulations') THEN
    -- Check if organization_id column exists, if not drop and recreate
    IF NOT EXISTS (
      SELECT 1 FROM information_schema.columns
      WHERE table_name = 'simulations' AND column_name = 'organization_id'
    ) THEN
      DROP TABLE simulations CASCADE;
    END IF;
  END IF;
END $$;

CREATE TABLE IF NOT EXISTS simulations (
  -- Identity
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  event_id UUID NOT NULL REFERENCES events(id) ON DELETE CASCADE,
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Simulation details
  simulation_date TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  scenario TEXT NOT NULL, -- 'event_day', 'room_conflicts', 'speaker_overlaps'
  simulation_metadata JSONB DEFAULT '{}', -- { validators_run: 8, issues_found: 12, severity_breakdown: {...} }

  -- Results
  issues JSONB NOT NULL DEFAULT '[]', -- Array of simulation issues
  impact_summary JSONB, -- { affected_participants: 50, affected_sessions: 5, vip_affected: 2 }
  recommendations JSONB DEFAULT '[]', -- Suggested fixes for issues

  -- Execution lifecycle
  status TEXT NOT NULL DEFAULT 'completed', -- 'running', 'completed', 'failed'
  executed_by UUID REFERENCES user_profiles(id),

  -- Metadata
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  -- Constraints
  CONSTRAINT valid_simulation_status CHECK (status IN ('running', 'completed', 'failed'))
);

-- Indexes for simulations
CREATE INDEX IF NOT EXISTS idx_simulations_event_id ON simulations(event_id);
CREATE INDEX IF NOT EXISTS idx_simulations_organization_id ON simulations(organization_id);
CREATE INDEX IF NOT EXISTS idx_simulations_date ON simulations(simulation_date DESC);

-- -------------------------------------------------------------------------
-- VENDOR ANALYSIS TABLE
-- -------------------------------------------------------------------------
DO $$
BEGIN
  -- Drop table if it exists with old schema (to fix migration issues)
  IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'vendor_analysis') THEN
    -- Check if organization_id column exists, if not drop and recreate
    IF NOT EXISTS (
      SELECT 1 FROM information_schema.columns
      WHERE table_name = 'vendor_analysis' AND column_name = 'organization_id'
    ) THEN
      DROP TABLE vendor_analysis CASCADE;
    END IF;
  END IF;
END $$;

CREATE TABLE IF NOT EXISTS vendor_analysis (
  -- Identity
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  vendor_id UUID NOT NULL REFERENCES vendors(id) ON DELETE CASCADE,
  event_id UUID REFERENCES events(id) ON DELETE SET NULL,
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Analysis details
  analysis_date TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  checklist_item_id UUID REFERENCES checklist_items(id) ON DELETE SET NULL,

  -- AI insights
  ai_insights JSONB NOT NULL DEFAULT '{}', -- { overall_rating: 4.5, strengths: [...], weaknesses: [...], recommendation: "..." }
  quote_comparison JSONB, -- { current_quote: 5000, alternatives: [...], savings_potential: 500 }
  budget_analysis JSONB, -- { budget: 10000, used: 5000, remaining: 5000, percentage: 50 }

  -- Historical context
  past_usage JSONB DEFAULT '[]', -- [{ event_name: "Event Y", date: "2025-12-01", rating: 4.5 }]

  -- Metadata
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Indexes for vendor_analysis
DO $$
BEGIN
  IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'vendor_analysis' AND column_name = 'analysis_date') THEN
    EXECUTE 'CREATE INDEX IF NOT EXISTS idx_vendor_analysis_vendor_id ON vendor_analysis(vendor_id)';
    EXECUTE 'CREATE INDEX IF NOT EXISTS idx_vendor_analysis_organization_id ON vendor_analysis(organization_id)';
    EXECUTE 'CREATE INDEX IF NOT EXISTS idx_vendor_analysis_date ON vendor_analysis(analysis_date DESC)';
  END IF;
END $$;

-- -------------------------------------------------------------------------
-- RLS FOR SIMULATIONS TABLE (Organization Isolation)
-- -------------------------------------------------------------------------
ALTER TABLE simulations ENABLE ROW LEVEL SECURITY;

-- Users can read simulations for their organization's events
DROP POLICY IF EXISTS "Users can read simulations" ON simulations;
CREATE POLICY "Users can read simulations"
  ON simulations FOR SELECT
  TO authenticated
  USING (
    organization_id IN (
      SELECT organization_id FROM user_profiles WHERE id = auth.uid()
    )
  );

-- Users can insert simulations for their organization's events
DROP POLICY IF EXISTS "Users can insert simulations" ON simulations;
CREATE POLICY "Users can insert simulations"
  ON simulations FOR INSERT
  TO authenticated
  WITH CHECK (
    organization_id IN (
      SELECT organization_id FROM user_profiles WHERE id = auth.uid()
    )
  );

-- No UPDATE/DELETE (append-only)

-- -------------------------------------------------------------------------
-- RLS FOR VENDOR ANALYSIS TABLE (Organization Isolation)
-- -------------------------------------------------------------------------
ALTER TABLE vendor_analysis ENABLE ROW LEVEL SECURITY;

-- Users can read vendor analysis for their organization
DROP POLICY IF EXISTS "Users can read vendor_analysis" ON vendor_analysis;
CREATE POLICY "Users can read vendor_analysis"
  ON vendor_analysis FOR SELECT
  TO authenticated
  USING (
    organization_id IN (
      SELECT organization_id FROM user_profiles WHERE id = auth.uid()
    )
  );

-- Users can insert vendor analysis for their organization
DROP POLICY IF EXISTS "Users can insert vendor_analysis" ON vendor_analysis;
CREATE POLICY "Users can insert vendor_analysis"
  ON vendor_analysis FOR INSERT
  TO authenticated
  WITH CHECK (
    organization_id IN (
      SELECT organization_id FROM user_profiles WHERE id = auth.uid()
    )
  );

-- No UPDATE/DELETE (append-only)

-- ====================================================================
-- 2. TIER CHECK FUNCTION (Security Definer + STABLE)
-- ====================================================================
CREATE OR REPLACE FUNCTION check_org_tier(org_id UUID, required_tier TEXT)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER  -- Bypasses RLS to check tier directly
STABLE  -- PostgreSQL optimizer caches result per statement
AS $$
DECLARE
  v_tier TEXT;
BEGIN
  -- Get organization tier
  SELECT tier INTO v_tier
  FROM organizations
  WHERE id = org_id;

  -- Check if tier matches required tier
  -- Premium and legacy_premium have same access
  -- Text comparison: 'premium' >= 'premium', 'premium' >= 'base'
  RETURN v_tier >= required_tier OR v_tier = 'legacy_premium';
END;
$$;

-- ====================================================================
-- 3. PREMIUM-ONLY RLS POLICIES (Tier Enforcement)
-- ====================================================================

-- -------------------------------------------------------------------------
-- SIMULATIONS TABLE - PREMIUM ONLY
-- -------------------------------------------------------------------------
DROP POLICY IF EXISTS "Users can read simulations" ON simulations;
CREATE POLICY "Premium users can read simulations"
  ON simulations FOR SELECT
  TO authenticated
  USING (
    check_org_tier(organization_id, 'premium')
  );

DROP POLICY IF EXISTS "Users can insert simulations" ON simulations;
CREATE POLICY "Premium users can insert simulations"
  ON simulations FOR INSERT
  TO authenticated
  WITH CHECK (
    check_org_tier(organization_id, 'premium')
  );

-- -------------------------------------------------------------------------
-- AI CHAT SESSIONS TABLE - PREMIUM ONLY
-- -------------------------------------------------------------------------
-- Note: ai_chat_sessions doesn't have organization_id column directly
-- We use event_id to check tier instead
-- Note: Existing RLS policies will be replaced by tier-enforced policies
DO $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM information_schema.tables 
    WHERE table_name = 'ai_chat_sessions'
  ) THEN
    -- Check if organization_id column exists before creating tier policy
    IF EXISTS (
      SELECT 1 FROM information_schema.columns 
      WHERE table_name = 'ai_chat_sessions' AND column_name = 'organization_id'
    ) THEN
      DROP POLICY IF EXISTS "Users can view own ai_chat_sessions" ON ai_chat_sessions;
      CREATE POLICY "Premium users can read ai_chat_sessions"
        ON ai_chat_sessions FOR SELECT
        TO authenticated
        USING (
          check_org_tier(organization_id, 'premium')
        );

      DROP POLICY IF EXISTS "Users can insert ai_chat_sessions" ON ai_chat_sessions;
      CREATE POLICY "Premium users can insert ai_chat_sessions"
        ON ai_chat_sessions FOR INSERT
        TO authenticated
        WITH CHECK (
          check_org_tier(organization_id, 'premium')
        );
    END IF;
  END IF;
END $$;

-- -------------------------------------------------------------------------
-- VENDOR ANALYSIS TABLE - PREMIUM ONLY
-- -------------------------------------------------------------------------
DROP POLICY IF EXISTS "Users can read vendor_analysis" ON vendor_analysis;
CREATE POLICY "Premium users can read vendor_analysis"
  ON vendor_analysis FOR SELECT
  TO authenticated
  USING (
    check_org_tier(organization_id, 'premium')
  );

DROP POLICY IF EXISTS "Users can insert vendor_analysis" ON vendor_analysis;
CREATE POLICY "Premium users can insert vendor_analysis"
  ON vendor_analysis FOR INSERT
  TO authenticated
  WITH CHECK (
    check_org_tier(organization_id, 'premium')
  );

-- ====================================================================
-- 4. PERFORMANCE INDEXES
-- ====================================================================
-- Composite index for RLS tier checks
CREATE INDEX IF NOT EXISTS idx_organizations_tier_id ON organizations(id, tier);

-- ====================================================================
-- 7. MIGRATION COMPLETE
-- ====================================================================
COMMENT ON TABLE simulations IS 'Day simulation results for Premium tier. Stores issues, impact summary, and recommendations. Premium-only access via RLS.';

COMMENT ON TABLE vendor_analysis IS 'AI-powered vendor analysis results for Premium tier. Stores insights, quote comparisons, and historical usage. Premium-only access via RLS.';

COMMENT ON FUNCTION check_org_tier IS 'Security definer function to check organization tier (base/premium). Marked STABLE for query optimizer caching. Prevents RLS performance degradation with tier checks.';

DO $$
BEGIN
  -- Add comments for policies only if they exist
  IF EXISTS (SELECT 1 FROM pg_policy WHERE policyname = 'Premium users can read simulations') THEN
    COMMENT ON POLICY "Premium users can read simulations" ON simulations IS 'RLS policy restricting simulations read access to premium organizations only. Uses check_org_tier() STABLE function for performance.';
  END IF;

  IF EXISTS (SELECT 1 FROM pg_policy WHERE policyname = 'Premium users can insert simulations') THEN
    COMMENT ON POLICY "Premium users can insert simulations" ON simulations IS 'RLS policy restricting simulations insert access to premium organizations only. Uses check_org_tier() STABLE function for performance.';
  END IF;

  IF EXISTS (SELECT 1 FROM pg_policy WHERE policyname = 'Premium users can read ai_chat_sessions') THEN
    COMMENT ON POLICY "Premium users can read ai_chat_sessions" ON ai_chat_sessions IS 'RLS policy restricting AI chat read access to premium organizations only. Uses check_org_tier() STABLE function for performance.';
  END IF;

  IF EXISTS (SELECT 1 FROM pg_policy WHERE policyname = 'Premium users can insert ai_chat_sessions') THEN
    COMMENT ON POLICY "Premium users can insert ai_chat_sessions" ON ai_chat_sessions IS 'RLS policy restricting AI chat insert access to premium organizations only. Uses check_org_tier() STABLE function for performance.';
  END IF;

  IF EXISTS (SELECT 1 FROM pg_policy WHERE policyname = 'Premium users can read vendor_analysis') THEN
    COMMENT ON POLICY "Premium users can read vendor_analysis" ON vendor_analysis IS 'RLS policy restricting vendor analysis read access to premium organizations only. Uses check_org_tier() STABLE function for performance.';
  END IF;

  IF EXISTS (SELECT 1 FROM pg_policy WHERE policyname = 'Premium users can insert vendor_analysis') THEN
    COMMENT ON POLICY "Premium users can insert vendor_analysis" ON vendor_analysis IS 'RLS policy restricting vendor analysis insert access to premium organizations only. Uses check_org_tier() STABLE function for performance.';
  END IF;
END $$;

-- ====================================================================
-- 6. VALIDATION QUERIES
-- ====================================================================

-- Test 1: Base tier user cannot insert into simulations (should fail)
-- INSERT INTO simulations (event_id, organization_id, scenario) VALUES (test_event_id, base_org_id, 'test');

-- Test 2: Premium tier user can insert into simulations (should succeed)
-- INSERT INTO simulations (event_id, organization_id, scenario) VALUES (test_event_id, premium_org_id, 'test');

-- Test 3: Base tier user cannot query simulations (should return empty)
-- SELECT * FROM simulations WHERE organization_id = base_org_id;

-- Test 4: Premium tier user can query simulations (should return results)
-- SELECT * FROM simulations WHERE organization_id = premium_org_id;

-- Benchmark: EXPLAIN ANALYZE RLS query (should be <200ms)
-- EXPLAIN ANALYZE SELECT * FROM simulations WHERE organization_id = $1;

-- ====================================================================
-- 7. MIGRATION COMPLETE
-- ====================================================================

DO $$
BEGIN
  RAISE NOTICE 'âœ“ Migration 012 complete: Premium tables created + RLS policies applied';
  RAISE NOTICE '  - simulations table created (Premium only)';
  RAISE NOTICE '  - vendor_analysis table created (Premium only)';
  RAISE NOTICE '  - check_org_tier() function created (SECURITY DEFINER + STABLE)';
  RAISE NOTICE '  - Premium-only RLS policies applied to 3 tables';
  RAISE NOTICE '  - Performance indexes created';
END $$;
